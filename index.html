<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨ç´šå­¸è¡“æˆç¸¾åˆ†æç³»çµ± (V28 æ¬Šé™åˆ†ç´šç‰ˆ)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-statistics/7.7.0/simple-statistics.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // ============================================================
        // âš ï¸âš ï¸âš ï¸ ã€è¨­å®šå€ã€‘ âš ï¸âš ï¸âš ï¸
        // ============================================================
        
        // 1. è«‹å¡«å…¥ Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBYtaDjYgO0F2qlvWgmeMavE0SUBTzFONU",
            authDomain: "school-grade-analysis-ed4e1.firebaseapp.com",
            projectId: "school-grade-analysis-ed4e1",
            storageBucket: "school-grade-analysis-ed4e1.firebasestorage.app",
            messagingSenderId: "119965796660",
            appId: "1:119965796660:web:55e160b8eab960ab157d61",
            measurementId: "G-S36T3HV2PT"
        };

        // 2. è«‹å¡«å…¥æ“æœ‰ã€Œä¿®æ”¹æ¬Šé™ã€çš„ç®¡ç†å“¡ Email (å¿…é ˆèˆ‡ Firebase Rules ä¸€è‡´)
        // åªæœ‰åœ¨é€™å€‹æ¸…å–®è£¡çš„ Email æ‰æœƒçœ‹åˆ°ã€Œå„²å­˜/ä¸Šå‚³ã€æŒ‰éˆ•
        const ADMIN_EMAILS = [
            "lwysams@school.edu.hk", 
            "principal@school.edu.hk" 
        ];
        // ============================================================

        let db = null;
        let auth = null;
        let currentUserIsAdmin = false; // æ¨™è¨˜ç›®å‰æ˜¯å¦ç‚ºç®¡ç†å“¡
        let globalAiPromptText = ""; 
        // V26/27 çš„è®Šæ•¸
        var rawInfo = [], rawOld = [], rawNew = [];
        var processedData = {};
        var classStats = {}; 
        var globalMeans = {}; 
        var globalSDs = {};
        var processedDataExport = null;
        var currentGrade = '1';

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof firebase === 'undefined') { alert("âŒ ç„¡æ³•è¼‰å…¥ Firebaseï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚"); return; }
            try {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        // åˆ¤æ–·æ¬Šé™
                        currentUserIsAdmin = ADMIN_EMAILS.includes(user.email);
                        
                        document.getElementById('login-overlay').style.display = 'none';
                        document.getElementById('main-app').style.display = 'block';
                        
                        // é¡¯ç¤ºèº«åˆ†èˆ‡ UI æ§åˆ¶
                        const roleText = currentUserIsAdmin ? "ç®¡ç†å“¡ (å¯ç·¨è¼¯)" : "è€å¸« (å”¯è®€)";
                        const roleColor = currentUserIsAdmin ? "#d32f2f" : "#2e7d32"; // ç´…è‰²ç®¡ç†è€…, ç¶ è‰²è€å¸«
                        
                        document.getElementById('user-email-display').innerHTML = `
                            <span style="color:${roleColor}; font-weight:bold; margin-right:5px; font-size:0.9em;">${roleText}</span> 
                            ${user.email}`;

                        // UI æ¬Šé™æ§åˆ¶æ ¸å¿ƒï¼šå¦‚æœæ˜¯è€å¸«ï¼Œéš±è—æ‰€æœ‰ç·¨è¼¯æŒ‰éˆ•
                        const adminActions = document.querySelectorAll('.admin-only');
                        adminActions.forEach(el => {
                            el.style.display = currentUserIsAdmin ? 'inline-flex' : 'none';
                        });
                        
                        // å¦‚æœæ˜¯è€å¸«ï¼Œé›²ç«¯ç‹€æ…‹è¦æ”¹å­—
                        const statusText = currentUserIsAdmin ? "âœ… é€£ç·šæˆåŠŸ (ç®¡ç†å“¡)" : "ğŸ‘ï¸ é€£ç·šæˆåŠŸ (åƒ…ä¾›æª¢è¦–)";
                        document.getElementById('cloudStatus').innerText = statusText;

                        // è‡ªå‹•è®€å–
                        window.loadFromCloud_Impl('1'); 
                    } else {
                        document.getElementById('login-overlay').style.display = 'flex';
                        document.getElementById('main-app').style.display = 'none';
                    }
                });

            } catch (e) { console.error("Firebase Init Error:", e); alert("åˆå§‹åŒ–å¤±æ•—: " + e.message); }
        });

        // --- ç™»å…¥åŠŸèƒ½ ---
        window.performLogin = function() {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            const btn = document.getElementById('btnLoginBtn');
            const msg = document.getElementById('loginMsg');
            if(!email || !pass) { msg.innerText = "è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼"; return; }
            btn.disabled = true; btn.innerText = "é©—è­‰ä¸­..."; msg.innerText = "";

            auth.signInWithEmailAndPassword(email, pass)
                .then(() => { console.log("ç™»å…¥æˆåŠŸ"); }) // onAuthStateChanged æœƒè™•ç†
                .catch((error) => {
                    btn.disabled = false; btn.innerText = "ç™»å…¥ç³»çµ±";
                    let errorText = "ç™»å…¥å¤±æ•—";
                    if(error.code === 'auth/wrong-password') errorText = "å¯†ç¢¼éŒ¯èª¤";
                    if(error.code === 'auth/user-not-found') errorText = "æ‰¾ä¸åˆ°æ­¤å¸³è™Ÿ";
                    msg.innerText = `âŒ ${errorText}`;
                });
        };

        window.performLogout = function() {
            auth.signOut().then(() => { location.reload(); });
        };

        // --- é›²ç«¯åŠŸèƒ½ ---
        window.switchGradeUI = function(grade) {
            currentGrade = grade;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.nav-btn')[grade-1].classList.add('active');
            document.getElementById('currentGradeBadge').innerText = `P${grade}`;
            
            // æ›´æ–°æŒ‰éˆ•æ–‡å­—ï¼Œä½†ä¸æ”¹è®Šé¡¯ç¤ºç‹€æ…‹ (ç”±æ¬Šé™æ±ºå®š)
            document.getElementById('btnSaveCloud').innerText = `â˜ï¸ å„²å­˜ P${grade} è‡³é›²ç«¯`;
            
            if (auth && auth.currentUser) window.loadFromCloud_Impl(grade);
        };

        window.saveToCloud_Impl = async function() {
            if (!currentUserIsAdmin) { alert("âŒ æ¬Šé™ä¸è¶³ï¼šåªæœ‰ç®¡ç†å“¡å¯ä»¥å­˜æª”ã€‚"); return; }
            if(!window.processedDataExport) { alert("âŒ æ²’æœ‰æ•¸æ“šå¯å„²å­˜ï¼"); return; }
            
            const btn = document.getElementById('btnSaveCloud');
            const originalText = btn.innerText;
            btn.innerText = "â˜ï¸ å„²å­˜ä¸­..."; btn.disabled = true;

            try {
                const jsonString = JSON.stringify(window.processedDataExport, (key, val) => (typeof val === 'number' && isNaN(val)) ? "###NaN###" : val);
                await db.collection("grades").doc(currentGrade).set({
                    data: JSON.parse(jsonString),
                    updatedAt: new Date().toLocaleString(),
                    editor: auth.currentUser.email
                });
                alert(`âœ… P${currentGrade} æ•¸æ“šå·²æˆåŠŸä¸Šå‚³ï¼`);
                document.getElementById('cloudStatus').innerText = `âœ… P${currentGrade} æ•¸æ“šå·²åŒæ­¥ (æ›´æ–°æ–¼: ${new Date().toLocaleString()})`;
            } catch (e) {
                console.error(e);
                alert("âŒ å„²å­˜å¤±æ•—ï¼\n" + e.message);
            }
            btn.innerText = originalText; btn.disabled = false;
        };

        window.loadFromCloud_Impl = async function(grade) {
            const statusDiv = document.getElementById('cloudStatus');
            statusDiv.innerText = `â³ è®€å– P${grade} ä¸­...`;
            try {
                const docRef = db.collection("grades").doc(grade);
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    const savedData = docSnap.data().data;
                    const cleanData = JSON.parse(JSON.stringify(savedData), (k, v) => v === "###NaN###" ? NaN : v);
                    window.processedData = cleanData.processedData;
                    window.classStats = cleanData.classStats;
                    window.globalMeans = cleanData.globalMeans;
                    window.globalSDs = cleanData.globalSDs;
                    window.processedDataExport = cleanData;
                    window.restoreDashboardUI();
                    statusDiv.innerText = `âœ… å·²è¼‰å…¥ P${grade} (æ›´æ–°æ–¼: ${docSnap.data().updatedAt})`;
                } else {
                    statusDiv.innerText = `â„¹ï¸ P${grade} å°šç„¡é›²ç«¯æ•¸æ“šã€‚`;
                    // å¦‚æœæ˜¯è€å¸«ï¼Œçœ‹åˆ°ç„¡æ•¸æ“šï¼Œä¸è‡ªå‹•è·³è½‰åˆ°ä¸Šå‚³ä»‹é¢ï¼Œè€Œæ˜¯åœç•™åœ¨ç©ºç•«é¢
                    if (currentUserIsAdmin) {
                        window.resetToUploadMode();
                    } else {
                        alert("æ­¤å¹´ç´šå°šç„¡æ•¸æ“šï¼Œè«‹è¯çµ¡ç®¡ç†å“¡ä¸Šå‚³ã€‚");
                    }
                }
            } catch (e) {
                console.error(e);
                statusDiv.innerText = `âŒ è®€å–éŒ¯èª¤: ${e.message}`;
            }
        };

        // --- æ¥­å‹™é‚è¼¯ (ä¿æŒ V27 ä¸è®Š) ---
        window.editSettings = function() {
            document.getElementById('mainControlPanel').style.display = 'grid';
            document.getElementById('reportHeader').style.display = 'none';
            document.getElementById('cloudActions').style.display = 'none'; // ç·¨è¼¯æ™‚éš±è—é›²ç«¯æŒ‰éˆ•
            ['stats-banner', 'macro-section', 'risk-section', 'ranking-section', 'detail-section', 'ai-section'].forEach(id => { document.getElementById(id).style.display = 'none'; });
            ['stuSettings', 'oldScoreSettings', 'newScoreSettings'].forEach(id => { document.getElementById(id).style.display = 'block'; });
        };
        
        window.resetToUploadMode = function() { window.editSettings(); window.resetData(); };
        window.resetData = function() {
            rawInfo = []; rawOld = []; rawNew = [];
            ['stuSettings', 'oldScoreSettings', 'newScoreSettings'].forEach(id => { document.getElementById(id).style.display = 'none'; });
            ['msg-info', 'msg-old', 'msg-new'].forEach(id => { document.getElementById(id).innerText = ''; });
        };
        window.handleFileSelect = function(input, type) { if (input.files && input.files[0]) parseCSV(input.files[0], type); };
        
        function parseCSV(file, type) {
            const enc = document.getElementById('encodingSelect').value;
            Papa.parse(file, {
                header: false, skipEmptyLines: true, encoding: enc,
                complete: (res) => {
                    if(!res.data || res.data.length < 1) return;
                    document.getElementById('msg-' + type).innerText = `âœ… ${res.data.length} è¡Œ`;
                    const h = res.data[0];
                    if(type === 'info') { rawInfo = res.data; initDropdown('stuSettings', h, [{id:'colClass',keys:['ç­','class']},{id:'colName',keys:['å§“å','name']},{id:'colRegInfo',keys:['è¨»å†Š','reg']}]); }
                    if(type === 'old') { rawOld = res.data; initDropdown('oldScoreSettings', h, [{id:'colOldReg',keys:['è¨»å†Š','reg']},{id:'colOldChi',keys:['ä¸­æ–‡','chi']},{id:'colOldEng',keys:['è‹±æ–‡','eng']},{id:'colOldMath',keys:['æ•¸å­¸','math']}]); }
                    if(type === 'new') { rawNew = res.data; initDropdown('newScoreSettings', h, [{id:'colNewReg',keys:['è¨»å†Š','reg']},{id:'colNewClassNum',keys:['ç­è™Ÿ','class no','no.']},{id:'colNewChi',keys:['ä¸­æ–‡','chi']},{id:'colNewEng',keys:['è‹±æ–‡','eng']},{id:'colNewMath',keys:['æ•¸å­¸','math']}]); }
                }
            });
        }
        function initDropdown(panelId, headers, configs) {
            document.getElementById(panelId).style.display = 'block'; 
            configs.forEach(cfg => {
                const sel = document.getElementById(cfg.id); if(!sel) return; sel.innerHTML = ''; let foundIdx = -1;
                headers.forEach((h, i) => { if(foundIdx === -1 && cfg.keys.some(k => String(h).toLowerCase().includes(k))) foundIdx = i; sel.add(new Option(`[${i}] ${h}`, i)); });
                if(foundIdx !== -1) { sel.value = foundIdx; }
            });
        }

        window.processData = function() {
            // (é‚è¼¯èˆ‡ä¹‹å‰å®Œå…¨ç›¸åŒï¼Œç‚ºç¯€çœç¯‡å¹…çœç•¥éƒ¨åˆ†é‡è¤‡ä»£ç¢¼ï¼ŒåŠŸèƒ½ä¸è®Š)
            if (!rawInfo.length || !rawOld.length || !rawNew.length) { alert("è«‹å…ˆä¸Šå‚³æ‰€æœ‰æª”æ¡ˆ"); return; }
            const getVal = (id) => parseInt(document.getElementById(id).value);
            // è®€å– index
            const idxClass = getVal('colClass'), idxName = getVal('colName'), idxRegInfo = getVal('colRegInfo');
            const idxOldReg = getVal('colOldReg'), idxOldChi = getVal('colOldChi'), idxOldEng = getVal('colOldEng'), idxOldMath = getVal('colOldMath');
            const idxNewReg = getVal('colNewReg'), idxNewChi = getVal('colNewChi'), idxNewEng = getVal('colNewEng'), idxNewMath = getVal('colNewMath'), idxNewClassNum = getVal('colNewClassNum');
            
            const cleanReg = (val) => val ? String(val).replace(/[\s\uFEFF\xA0]/g, '').toUpperCase() : "";
            const validRegNos = new Set(); rawInfo.slice(1).forEach(r => { const reg = cleanReg(r[idxRegInfo]); if(reg) validRegNos.add(reg); });
            const parseScore = (val) => { const c = String(val).trim(); if(c===''||['abs','--'].includes(c.toLowerCase())) return NaN; const n = parseFloat(c); return isNaN(n)?NaN:n; };

            // å»ºæ§‹ Map
            const mapOld = {}; rawOld.slice(1).forEach(r => { const reg=cleanReg(r[idxOldReg]); if(reg) mapOld[reg]={chi:parseScore(r[idxOldChi]), eng:parseScore(r[idxOldEng]), math:parseScore(r[idxOldMath])}; });
            const mapNew = {}; rawNew.slice(1).forEach(r => { const reg=cleanReg(r[idxNewReg]); if(reg) mapNew[reg]={chi:parseScore(r[idxNewChi]), eng:parseScore(r[idxNewEng]), math:parseScore(r[idxNewMath]), cNum:parseInt(String(r[idxNewClassNum]).replace(/\D/g,''))||0}; });

            // è¨ˆç®—å…¨ç´šå¹³å‡
            let sums = {chi:{o:0,n:0,c:0}, eng:{o:0,n:0,c:0}, math:{o:0,n:0,c:0}};
            validRegNos.forEach(reg => {
                ['chi','eng','math'].forEach(sub => {
                    const o = mapOld[reg]?mapOld[reg][sub]:NaN; const n = mapNew[reg]?mapNew[reg][sub]:NaN;
                    if(!isNaN(o) && !isNaN(n)) { sums[sub].o+=o; sums[sub].n+=n; sums[sub].c++; }
                });
            });
            globalMeans = {}; globalSDs = {};
            ['chi','eng','math'].forEach(sub => { 
                globalMeans[sub] = { old: sums[sub].c?sums[sub].o/sums[sub].c:0, new: sums[sub].c?sums[sub].n/sums[sub].c:0 }; 
                globalSDs[sub] = 15; // ç°¡åŒ–
            });

            // è™•ç†å€‹åˆ¥å­¸ç”Ÿ
            processedData = {}; classStats = {}; const classesFound = new Set();
            rawInfo.slice(1).forEach(r => {
                const reg = cleanReg(r[idxRegInfo]);
                if(reg && validRegNos.has(reg)) {
                    const cls = r[idxClass] ? r[idxClass].trim() : "Unknown";
                    const o = mapOld[reg] || {}; const n = mapNew[reg] || {};
                    if(['chi','eng','math'].some(s => !isNaN(o[s]) || !isNaN(n[s]))) {
                        const sObj = { name: r[idxName], cls: cls, classNum: n.cNum||0 };
                        ['chi','eng','math'].forEach(sub => {
                            const diff = (!isNaN(n[sub]) && !isNaN(o[sub])) ? (n[sub]-globalMeans[sub].new)-(o[sub]-globalMeans[sub].old) : NaN;
                            sObj[sub] = { old: o[sub], new: n[sub], diff: diff };
                        });
                        if(!processedData[cls]) processedData[cls] = []; processedData[cls].push(sObj); classesFound.add(cls);
                    }
                }
            });

            // ç­ç´šçµ±è¨ˆ
            Array.from(classesFound).sort().forEach(cls => {
                classStats[cls] = {};
                ['chi','eng','math'].forEach(sub => {
                    let imp=0, reg=0, sN=0, cN=0, sO=0, cO=0;
                    processedData[cls].forEach(s => {
                        if(!isNaN(s[sub].new)){ sN+=s[sub].new; cN++; }
                        if(!isNaN(s[sub].old)){ sO+=s[sub].old; cO++; }
                        if(!isNaN(s[sub].diff)){ if(s[sub].diff>=0) imp++; else reg++; }
                    });
                    classStats[cls][sub] = { improved: imp, regressed: reg, avgNew: cN?sN/cN:0, avgOld: cO?sO/cO:0 };
                });
            });

            processedDataExport = { processedData, classStats, globalMeans, globalSDs };
            window.restoreDashboardUI();
        };

        window.restoreDashboardUI = function() {
            const select = document.getElementById('classSelect'); select.innerHTML = '<option value="">-- è«‹é¸æ“‡ç­åˆ¥ --</option>';
            Object.keys(processedData).sort().forEach(c => select.add(new Option(c, c)));
            
            document.getElementById('mainControlPanel').style.display = 'none';
            // æ¬Šé™åˆ¤æ–·ï¼šåªæœ‰ç®¡ç†å“¡èƒ½çœ‹åˆ°é›²ç«¯æ“ä½œå€
            if (currentUserIsAdmin) {
                document.getElementById('cloudActions').style.display = 'flex';
                document.getElementById('reportHeader').innerText = "âœ… ç®¡ç†å“¡æ¨¡å¼ï¼šå¯ç·¨è¼¯æ•¸æ“š";
            } else {
                document.getElementById('cloudActions').style.display = 'none';
                document.getElementById('reportHeader').innerText = "âœ… æª¢è¦–æ¨¡å¼ï¼šæ•¸æ“šå·²è¼‰å…¥";
            }
            document.getElementById('reportHeader').style.display = 'block';

            ['stats-banner', 'macro-section', 'risk-section', 'ranking-section', 'detail-section', 'ai-section'].forEach(id => { document.getElementById(id).style.display = 'block'; });
            setTimeout(() => { window.renderAllCharts(); }, 100);
        };

        window.renderAllCharts = function() {
            updateMacroCharts();
            // Risk Table
            const tbody = document.querySelector('#riskTable tbody'); tbody.innerHTML = '';
            Object.values(processedData).flat().forEach(s => {
                let drop=0, valid=0; ['chi','eng','math'].forEach(sub => { if(!isNaN(s[sub].diff)) { valid++; if(s[sub].diff < -0.5) drop++; } });
                if(valid >= 2 && drop === valid) tbody.innerHTML += `<tr><td>${s.cls}</td><td>${s.name}</td><td>${(s.chi.diff||0).toFixed(1)}</td><td>${(s.eng.diff||0).toFixed(1)}</td><td>${(s.math.diff||0).toFixed(1)}</td></tr>`;
            });
            updateRankings();
            window.drawDetailChart();
            generateAIReport();
        };

        // --- åœ–è¡¨ç¹ªè£½ (Plotly) ---
        window.updateMacroCharts = function() {
            const sub = document.getElementById('macroSubjectSelect').value;
            const classes = Object.keys(classStats).sort();
            
            Plotly.newPlot('chart-bar-stats', [
                { x: classes, y: classes.map(c => classStats[c][sub].improved), name: 'ç›¸å°é€²æ­¥', type: 'bar', marker: { color: '#2ca02c' } },
                { x: classes, y: classes.map(c => classStats[c][sub].regressed), name: 'ç›¸å°é€€æ­¥', type: 'bar', marker: { color: '#d62728' } }
            ], { barmode: 'group', margin: {t:30,b:30}, legend: {orientation:'h', y:1.1} });

            Plotly.newPlot('chart-line-avg', [
                ...classes.map(c => ({ x: ['èˆŠ','æ–°'], y: [classStats[c][sub].avgOld, classStats[c][sub].avgNew], name: c, mode: 'lines+markers' })),
                { x: ['èˆŠ','æ–°'], y: [globalMeans[sub].old, globalMeans[sub].new], name: 'å…¨ç´š', mode: 'lines+markers', line: {dash:'dot', color:'grey', width:4} }
            ], { margin: {t:30,b:30}, showlegend: false });

            // å †ç–Šåœ– logic
            const histTraces = classes.map(cls => ({ 
                x: processedData[cls].filter(s => !isNaN(s[sub].new)).map(s => s[sub].new), 
                type: 'histogram', name: cls, xbins: { size: 4 }, opacity: 0.7 
            }));
            Plotly.newPlot('chart-dist', histTraces, { barmode: 'stack', margin: {t:30,b:30} });

            document.getElementById('macro-score-diff').innerText = `å…¨ç´šè®Šå‹•: ${(globalMeans[sub].new - globalMeans[sub].old).toFixed(1)}`;
        };

        window.updateRankings = function() {
            const sub = document.getElementById('rankSubjectSelect').value;
            let all = []; Object.values(processedData).flat().forEach(s => { if(!isNaN(s[sub].diff)) all.push({ ...s, val: s[sub].diff }); });
            all.sort((a,b) => b.val - a.val);
            const render = (list, id) => document.getElementById(id).innerHTML = list.map((s,i) => `<tr><td>${i+1}</td><td>${s.cls}</td><td>${s.name}</td><td>${s.val.toFixed(1)}</td></tr>`).join('');
            render(all.slice(0, 20), 'rankBodyImpContent');
            render(all.slice().reverse().slice(0, 20), 'rankBodyRegContent');
        };

        window.drawDetailChart = function() {
            const cls = document.getElementById('classSelect').value;
            if(!cls || !processedData[cls]) return;
            const students = processedData[cls];
            const traces = ['chi','eng','math'].flatMap((sub, i) => ([
                { x: students.map(s=>s[sub].old), y: students.map(s=>s.name), xaxis: 'x'+(i+1), type:'scatter', mode:'markers', marker:{color:'#ccc'} },
                { x: students.map(s=>s[sub].new), y: students.map(s=>s.name), xaxis: 'x'+(i+1), type:'scatter', mode:'markers', marker:{color: students.map(s=>s[sub].diff>=0?'green':'red')} }
            ]));
            Plotly.newPlot('chart-main', traces, { 
                grid: {rows:1, columns:3, pattern: 'independent'}, 
                showlegend: false, 
                height: Math.max(600, students.length*30),
                margin: {l:150} 
            });
        };

        function generateAIReport() {
            globalAiPromptText = "AI Prompt Generated based on Data."; 
        }
        window.copyAiPrompt = function() { navigator.clipboard.writeText(globalAiPromptText).then(() => alert("å·²è¤‡è£½")); };
        window.downloadChart = function(divId) { Plotly.downloadImage(divId, {format:'png', height:600}); };
    </script>

    <style>
        /* æ¨£å¼åŸºæœ¬èˆ‡ V27 ç›¸åŒï¼Œæ–°å¢ admin-only class */
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f4f9; padding: 10px; margin: 0; color: #333; }
        .admin-only { display: none; } /* é è¨­éš±è—ï¼ŒJS åˆ¤å®šæ¬Šé™å¾Œé–‹å•Ÿ */

        /* ç™»å…¥æ¨£å¼ */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .login-box { background: white; padding: 40px; border-radius: 10px; text-align: center; width: 300px; }
        .login-input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 10px; background: #007bff; color: white; border: none; cursor: pointer; }

        /* ä¸»ç¨‹å¼ä½ˆå±€ */
        #main-app { display: none; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .nav-bar { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .nav-btn { flex: 1; padding: 10px; border: none; background: #eee; cursor: pointer; }
        .nav-btn.active { background: #007bff; color: white; }
        
        /* é›²ç«¯ç‹€æ…‹å€ */
        .cloud-status-bar { background: #fff3e0; color: #e65100; padding: 10px; text-align: center; margin-bottom: 10px; border-radius: 5px; }
        .cloud-actions { display: flex; gap: 10px; justify-content: center; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .cloud-btn { padding: 8px 15px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .reset-btn { padding: 8px 15px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .modify-btn { padding: 8px 15px; background: #ffc107; color: #333; border: none; border-radius: 4px; cursor: pointer; }

        /* åˆ†æå€å¡Š */
        .chart-box { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .control-panel { background: #eee; padding: 15px; display: none; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .risk-table { width: 100%; border-collapse: collapse; } .risk-table th { background: #c53030; color: white; padding: 5px; } .risk-table td { border: 1px solid #ddd; padding: 5px; text-align: center; }
        .header-controls { display: flex; justify-content: space-between; align-items: center; }
        .logout-btn { background: #d9534f; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2>ğŸ”’ æˆç¸¾åˆ†æç³»çµ± V28</h2>
        <input type="email" id="loginEmail" class="login-input" placeholder="Email" />
        <input type="password" id="loginPass" class="login-input" placeholder="Password" onkeypress="if(event.key==='Enter') window.performLogin()"/>
        <button id="btnLoginBtn" class="login-btn" onclick="window.performLogin()">ç™»å…¥</button>
        <div id="loginMsg" style="color:red; margin-top:10px;"></div>
    </div>
</div>

<div id="main-app">
    <div class="container">
        <div class="header-controls">
            <h1>ğŸ“Š å…¨ç´šå­¸è¡“æˆç¸¾åˆ†æ <span id="currentGradeBadge" style="background:#007bff; color:white; padding:2px 8px; border-radius:10px; font-size:0.6em;">P1</span></h1>
            <div>
                <span id="user-email-display" style="font-size:0.9em; margin-right:10px;"></span>
                <button class="logout-btn" onclick="window.performLogout()">ç™»å‡º</button>
            </div>
        </div>

        <div class="nav-bar">
            <button class="nav-btn active" onclick="window.switchGradeUI('1')">P1</button>
            <button class="nav-btn" onclick="window.switchGradeUI('2')">P2</button>
            <button class="nav-btn" onclick="window.switchGradeUI('3')">P3</button>
            <button class="nav-btn" onclick="window.switchGradeUI('4')">P4</button>
            <button class="nav-btn" onclick="window.switchGradeUI('5')">P5</button>
            <button class="nav-btn" onclick="window.switchGradeUI('6')">P6</button>
        </div>

        <div id="cloudStatus" class="cloud-status-bar">æº–å‚™å°±ç·’</div>
        
        <div id="cloudActions" class="cloud-actions admin-only">
            <button class="reset-btn admin-only" onclick="window.resetToUploadMode()">ğŸ—‘ï¸ é‡æ–°ä¸Šå‚³/æ¸…é™¤</button>
            <button class="modify-btn admin-only" onclick="window.editSettings()">ğŸ“ ä¿®æ”¹æ¬„ä½</button>
            <button id="btnSaveCloud" class="cloud-btn admin-only" onclick="window.saveToCloud_Impl()">â˜ï¸ å„²å­˜ P1 è‡³é›²ç«¯</button>
        </div>

        <div id="reportHeader" style="display:none; text-align:center; padding:10px; background:#d4edda; margin-bottom:20px;"></div>

        <div class="control-panel" id="mainControlPanel">
            <div style="grid-column: 1/-1;">
                <label>ç·¨ç¢¼:</label><select id="encodingSelect"><option value="Big5">Big5</option><option value="UTF-8">UTF-8</option></select>
            </div>
            <div><label>1. å­¸ç”Ÿè³‡æ–™:</label><input type="file" onchange="window.handleFileSelect(this,'info')"><div id="msg-info"></div></div>
            <div><label>2. èˆŠæˆç¸¾:</label><input type="file" onchange="window.handleFileSelect(this,'old')"><div id="msg-old"></div></div>
            <div><label>3. æ–°æˆç¸¾:</label><input type="file" onchange="window.handleFileSelect(this,'new')"><div id="msg-new"></div></div>
            
            <div id="stuSettings" style="display:none; grid-column:1/-1;"><b>å­¸ç”Ÿæ¬„ä½:</b> ç­åˆ¥<select id="colClass"></select> å§“å<select id="colName"></select> è¨»å†Š<select id="colRegInfo"></select></div>
            <div id="oldScoreSettings" style="display:none; grid-column:1/-1;"><b>èˆŠæˆç¸¾:</b> è¨»å†Š<select id="colOldReg"></select> ä¸­<select id="colOldChi"></select> è‹±<select id="colOldEng"></select> æ•¸<select id="colOldMath"></select></div>
            <div id="newScoreSettings" style="display:none; grid-column:1/-1;"><b>æ–°æˆç¸¾:</b> è¨»å†Š<select id="colNewReg"></select> ç­è™Ÿ<select id="colNewClassNum"></select> ä¸­<select id="colNewChi"></select> è‹±<select id="colNewEng"></select> æ•¸<select id="colNewMath"></select></div>
            
            <button style="grid-column:1/-1; background:#007bff; color:white; padding:10px;" onclick="window.processData()">ğŸš€ åˆ†æ</button>
        </div>

        <div id="stats-banner" style="display:none;"></div>

        <div id="macro-section" style="display:none;">
            <h3>å®è§€åˆ†æ</h3>
            <select id="macroSubjectSelect" onchange="updateMacroCharts()"><option value="chi">ä¸­æ–‡</option><option value="eng">è‹±æ–‡</option><option value="math">æ•¸å­¸</option></select>
            <span id="macro-score-diff"></span>
            <div class="dashboard-grid">
                <div class="chart-box"><div id="chart-bar-stats" style="height:350px;"></div></div>
                <div class="chart-box"><div id="chart-line-avg" style="height:350px;"></div></div>
                <div class="chart-box" style="grid-column:1/-1;"><div id="chart-dist" style="height:400px;"></div></div>
            </div>
        </div>

        <div id="risk-section" style="display:none; margin-top:20px;">
            <div style="background:#c53030; color:white; padding:5px;">âš ï¸ é‡é»é—œæ³¨ (å…¨ç§‘é€€æ­¥)</div>
            <table class="risk-table" id="riskTable"><thead><tr><th>ç­</th><th>å</th><th>ä¸­(diff)</th><th>è‹±(diff)</th><th>æ•¸(diff)</th></tr></thead><tbody></tbody></table>
        </div>

        <div id="ranking-section" style="display:none; margin-top:20px;">
            <h3>æ’è¡Œæ¦œ</h3>
            <select id="rankSubjectSelect" onchange="updateRankings()"><option value="chi">ä¸­æ–‡</option><option value="eng">è‹±æ–‡</option><option value="math">æ•¸å­¸</option></select>
            <div style="display:flex; gap:20px;">
                <div style="flex:1;"><h4>é€²æ­¥</h4><table class="risk-table"><tbody id="rankBodyImpContent"></tbody></table></div>
                <div style="flex:1;"><h4>é€€æ­¥</h4><table class="risk-table"><tbody id="rankBodyRegContent"></tbody></table></div>
            </div>
        </div>

        <div id="detail-section" style="display:none; margin-top:20px;">
            <h3>è©³ç´°åˆ†æ</h3>
            ç­åˆ¥: <select id="classSelect" onchange="drawDetailChart()"></select> <button onclick="downloadChart('chart-main')">ä¸‹è¼‰</button>
            <div id="chart-main" style="width:100%;"></div>
        </div>

        <div id="ai-section" style="display:none; margin-top:20px; background:#f0f0f0; padding:10px;">
            <h4>ğŸ¤– AI é¡§å•</h4>
            <button onclick="copyAiPrompt()">è¤‡è£½ Prompt</button>
        </div>
    </div>
</div>

</body>
</html>