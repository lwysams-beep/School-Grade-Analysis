<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCK-AI Hub | æ­£è¦ºè“®ç¤¾ AI æ™ºæ…§åº« V1.9</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        /* CSS V1.9 Update */
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --light: #ecf0f1;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --admin-color: #8e44ad;
            --value-edu-color: #e91e63;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background-color: #f4f7f6; display: flex; height: 100vh; }
        .sidebar { width: 260px; background-color: var(--primary); color: white; display: flex; flex-direction: column; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .page { display: none; animation: fadeIn 0.4s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .sidebar h2 { font-size: 1.3rem; margin-bottom: 20px; text-align: center; border-bottom: 1px solid #546e7a; padding-bottom: 15px; }
        .menu-item { padding: 12px 15px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; display: flex; align-items: center; }
        .menu-item:hover, .menu-item.active { background-color: var(--accent); transform: translateX(5px); }
        .menu-icon { margin-right: 10px; width: 20px; text-align: center; }
        .user-info { margin-top: auto; padding-top:20px; border-top:1px solid #546e7a; font-size: 0.9rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; border-bottom: 4px solid var(--accent); }
        .stat-number { font-size: 2.5rem; font-weight: 800; color: var(--primary); margin: 10px 0; }
        
        .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; }

        .resource-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }
        .card { background: white; border-radius: 12px; padding: 0; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; transition: transform 0.2s; overflow: hidden; display: flex; flex-direction: column;}
        .card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .card-content { padding: 20px; flex: 1; display: flex; flex-direction: column; }
        
        .app-preview { width: 100%; height: 180px; object-fit: contain; background-color: #e0e0e0; border-bottom: 1px solid #ddd; display: block; }
        .app-preview-placeholder { height: 180px; background: linear-gradient(135deg, #e0e0e0, #f5f5f5); display: flex; align-items: center; justify-content: center; color: #aaa; font-size: 2rem; }

        .card.teaching { border-top: 5px solid var(--accent); }
        .card.admin { border-top: 5px solid var(--admin-color); }
        .card.value-edu { border-top: 5px solid var(--value-edu-color); }
        
        .rating-badge-container { display: flex; gap: 10px; margin: 15px 0; }
        .badge-rate { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 5px 10px; border-radius: 8px; color: white; font-weight: bold; min-width: 60px; }
        .bg-ease { background: linear-gradient(135deg, #f1c40f, #f39c12); }
        .bg-effect { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .rate-label { font-size: 0.7rem; text-transform: uppercase; opacity: 0.9; }
        .rate-score { font-size: 1.2rem; }
        
        /* è©•åˆ†è¡¨å–®æ¨£å¼ */
        .rating-form { margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; font-size: 0.9rem; background: #fafafa; padding: 10px; border-radius: 5px;}
        .rating-input-row { display: flex; gap: 10px; align-items: center; margin-bottom: 5px; }
        .rating-select { padding: 2px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.8rem; }
        
        /* V1.9 è©•è«–å€æ¨£å¼ */
        .comments-section { margin-top: 15px; border-top: 2px dashed #f0f0f0; padding-top: 15px; }
        .comments-title { font-size: 0.85rem; font-weight: bold; color: #7f8c8d; margin-bottom: 8px; }
        .comment-list { max-height: 120px; overflow-y: auto; font-size: 0.85rem; margin-bottom: 10px; padding-right: 5px; }
        .comment-item { margin-bottom: 6px; border-bottom: 1px dotted #eee; padding-bottom: 4px; line-height: 1.4; }
        .comment-author { font-weight: bold; color: var(--primary); margin-right: 3px; }
        .comment-content { color: #555; }
        .comment-input-group { display: flex; gap: 5px; }
        .comment-input { flex: 1; padding: 6px; font-size: 0.85rem; border: 1px solid #ddd; border-radius: 4px; }

        .tag { background: #f0f2f5; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; color: #555; margin-right: 5px; display: inline-block; margin-bottom: 5px;}
        .smart-tag { background: #e8f6f3; color: var(--success); border: 1px solid #d4efdf; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; font-weight: 600; }
        .btn-primary { background-color: var(--accent); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-admin { background-color: var(--admin-color); color: white; }
        .btn-value { background-color: var(--value-edu-color); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-outline { border: 1px solid #ccc; background: white; color: #555; }
        .btn-xs { padding: 4px 8px; font-size: 0.8rem; }

        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #34495e; }
        .form-control { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
        .form-control:disabled { background-color: #e9ecef; cursor: not-allowed; opacity: 0.7; }
        
        .cross-subject-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; margin-top: 10px; }
        .checkbox-label { display: flex; align-items: center; font-size: 0.9rem; cursor: pointer; }
        .checkbox-label input { margin-right: 8px; transform: scale(1.2); }

        #loginModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: white; padding: 40px; border-radius: 15px; width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        
        .leaderboard-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .leaderboard-item:last-child { border-bottom: none; }
        .lb-rank { width: 30px; font-weight: bold; color: #7f8c8d; }
        .lb-name { flex: 1; font-weight: 600; }
        .lb-stats { text-align: right; font-size: 0.85rem; color: #555; }
        .lb-highlight { color: var(--accent); font-weight: bold; }
        .lb-link { color: var(--success); text-decoration: none; border: 1px solid var(--success); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 5px; transition: 0.2s; }
        .lb-link:hover { background: var(--success); color: white; }
    </style>
</head>
<body>

    <div id="loginModal">
        <div class="login-box">
            <h2 style="color:var(--primary); margin-top:0;">BCK-AI Hub V1.9</h2>
            <p style="color:#7f8c8d; margin-bottom:20px;">è«‹ä½¿ç”¨æ ¡æ–¹æ´¾ç™¼çš„å¸³è™Ÿç™»å…¥</p>
            <input type="email" id="loginEmail" class="form-control" placeholder="Email" style="margin-bottom:10px;">
            <input type="password" id="loginPass" class="form-control" placeholder="Password" style="margin-bottom:20px;">
            <button id="loginBtn" class="btn btn-primary" style="width:100%" onclick="handleLogin()">ç™»å…¥ç³»çµ±</button>
            <p style="margin-top:15px; font-size:0.8rem; color:#e74c3c;" id="loginMsg"></p>
        </div>
    </div>

    <div class="sidebar">
        <h2>BCK-AI Hub</h2>
        <div class="menu-item active" onclick="showPage('dashboard')"><span class="menu-icon">ğŸ“Š</span> æ•¸æ“šç¸½è¦½</div>
        <div class="menu-item" onclick="showPage('apps')"><span class="menu-icon">ğŸ“±</span> æ‡‰ç”¨ç¨‹å¼åº«</div>
        <div class="menu-item" onclick="showPage('prompts')"><span class="menu-icon">ğŸ’¡</span> Prompt åˆ†äº«</div>
        <div class="menu-item" onclick="showPage('upload')"><span class="menu-icon">ğŸ“¤</span> ä¸Šè¼‰åˆ†äº«</div>
        <div class="user-info">
            <p>ğŸ‘‹ <span id="currentUserDisplay">...</span> è€å¸«</p>
            <button class="btn btn-outline" style="width:100%; font-size:0.8rem;" onclick="logout()">ç™»å‡º</button>
        </div>
    </div>

    <div class="main-content">
        <div id="dashboard" class="page active">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h1>å¹³å°æ•¸æ“šå„€è¡¨æ¿</h1>
                <button class="btn btn-success" onclick="exportDataReport()">ğŸ“¥ åŒ¯å‡ºæ•¸æ“šå ±å‘Š (CSV)</button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card" style="border-bottom-color: var(--accent);">
                    <div class="stat-number" id="totalApps">0</div>
                    <div>å­¸æ•™è©•è³‡æº</div>
                </div>
                <div class="stat-card" style="border-bottom-color: var(--admin-color);">
                    <div class="stat-number" id="totalAdmin">0</div>
                    <div>è¡Œæ”¿æ•ˆèƒ½å·¥å…·</div>
                </div>
                <div class="stat-card" style="border-bottom-color: var(--warning);">
                    <div class="stat-number" id="totalPrompts">0</div>
                    <div>Prompt æŒ‡ä»¤</div>
                </div>
                <div class="stat-card" style="border-bottom-color: var(--success);">
                    <div class="stat-number" id="activeTeachers">0</div>
                    <div>åƒèˆ‡è€å¸«</div>
                </div>
            </div>

            <div class="charts-row">
                <div class="chart-box">
                    <h3 style="color:var(--accent)">ğŸ“ å­¸æ•™è©•ï¼š5C+ ç´ é¤Šåˆ†ä½ˆ</h3>
                    <canvas id="teachingChart"></canvas>
                </div>
                <div class="chart-box">
                    <h3 style="color:var(--accent)">ğŸ“ å­¸æ•™è©•ï¼šå­¸ç§‘è³‡æºåˆ†ä½ˆ</h3>
                    <canvas id="subjectChart"></canvas>
                </div>
            </div>

            <div class="chart-box" style="margin-bottom: 20px;">
                <h3 style="color:var(--admin-color)">ğŸ“‚ è¡Œæ”¿ï¼šæ•ˆèƒ½é¡åˆ¥åˆ†æ (å…¨è¦½)</h3>
                <div style="height: 350px;">
                    <canvas id="adminChart"></canvas>
                </div>
            </div>
            
            <div class="chart-box">
                <h3>ğŸ† æ´»èºè²¢ç»èˆ‡å„ªè³ªä½œå“æ’è¡Œæ¦œ</h3>
                <div id="leaderboardList"></div>
            </div>
        </div>

        <div id="apps" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h1>æ‡‰ç”¨ç¨‹å¼åº«</h1>
                <div>
                    <button class="btn btn-primary" onclick="filterApps('all')">å…¨éƒ¨</button>
                    <button class="btn btn-primary" style="background:var(--accent)" onclick="filterApps('teaching')">å­¸æ•™è©•</button>
                    <button class="btn btn-value" onclick="filterApps('value')">ğŸ’— åƒ¹å€¼è§€æ•™è‚²</button>
                    <button class="btn btn-admin" onclick="filterApps('admin')">è¡Œæ”¿</button>
                </div>
            </div>
            <div id="appsContainer" class="resource-grid"></div>
        </div>

        <div id="prompts" class="page">
            <h1>å¥½ Prompt åˆ†äº«å€</h1>
            <div id="promptsContainer" class="resource-grid"></div>
        </div>

        <div id="upload" class="page">
            <h1>ä¸Šè¼‰ / ç·¨è¼¯è³‡æº</h1>
            <div style="background:white; padding:30px; border-radius:12px; max-width: 800px; margin:0 auto;">
                <input type="hidden" id="editModeId" value="">

                <div class="form-group">
                    <label>è³‡æºé¡å‹</label>
                    <select id="uploadType" class="form-control" onchange="toggleUploadForm()">
                        <option value="app">App / ç¶²ä»¶</option>
                        <option value="prompt">AI Prompt (æŒ‡ä»¤)</option>
                    </select>
                </div>

                <div id="appForm">
                    <div class="form-group">
                        <label>ä½œå“åç¨±</label>
                        <input type="text" id="appTitle" class="form-control" placeholder="ä¾‹å¦‚ï¼šè‡ªå‹•å‡ºå·ç¥å™¨">
                    </div>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <div class="form-group">
                            <label>ä¸»åˆ†é¡</label>
                            <select id="appCategory" class="form-control" onchange="handleCategoryChange()">
                                <option value="teaching">å­¸æ•™è©• (Teaching)</option>
                                <option value="admin">è¡Œæ”¿ (Admin)</option>
                            </select>
                        </div>
                        <div class="form-group" id="subjectGroup">
                            <label>é©ç”¨ç§‘ç›®</label>
                            <select id="appSubject" class="form-control" onchange="handleSubjectChange()">
                                <option value="ä¸­æ–‡">ä¸­æ–‡</option>
                                <option value="è‹±æ–‡">è‹±æ–‡</option>
                                <option value="æ•¸å­¸">æ•¸å­¸</option>
                                <option value="å¸¸è­˜/ç§‘å­¸">å¸¸è­˜/ç§‘å­¸</option>
                                <option value="äººæ–‡">äººæ–‡</option>
                                <option value="è¦–è—">è¦–è—</option>
                                <option value="éŸ³æ¨‚">éŸ³æ¨‚</option>
                                <option value="é«”è‚²">é«”è‚²</option>
                                <option value="åœ–æ›¸">åœ–æ›¸</option>
                                <option value="æ™®é€šè©±">æ™®é€šè©±</option>
                                <option value="ä½›å­¸">ä½›å­¸</option>
                                <option value="ç§‘æŠ€">ç§‘æŠ€</option>
                                <option value="åƒ¹å€¼è§€æ•™è‚²">åƒ¹å€¼è§€æ•™è‚²</option>
                                <option value="è·¨èª²ç¨‹">è·¨èª²ç¨‹ (è«‹é¸æ­¤é …ä»¥é€²è¡Œè¤‡é¸)</option>
                            </select>
                            
                            <div id="crossSubjectSection" style="display:none; margin-top:10px;">
                                <label style="font-size:0.9rem; color:#e67e22;">è«‹å‹¾é¸æ¶‰åŠçš„ç§‘ç›®ï¼š</label>
                                <div class="cross-subject-grid" id="crossSubjectCheckboxes"></div>
                            </div>

                        </div>
                        <div class="form-group" id="adminTypeGroup" style="display:none;">
                            <label>è¡Œæ”¿é¡åˆ¥</label>
                            <select id="appAdminType" class="form-control">
                                <option value="æ ¡å‹™é‹ä½œ">æ ¡å‹™é‹ä½œ (æ—¥å¸¸æµç¨‹ã€æ”¾å­¸ã€é»å)</option>
                                <option value="æ–‡æ›¸è™•ç†">æ–‡æ›¸è™•ç† (å ±å‘Šã€æœƒè­°è¨˜éŒ„)</option>
                                <option value="æ•¸æ“šåˆ†æ">æ•¸æ“šåˆ†æ (æˆç¸¾ã€å•å·çµ±è¨ˆ)</option>
                                <option value="è³‡è¨Šé€šè¨Š">è³‡è¨Šé€šè¨Š (é€šå‘Šã€å®£å‚³ã€è¯çµ¡)</option>
                                <option value="æ´»å‹•ç­–åŠƒ">æ´»å‹•ç­–åŠƒ (æ—…è¡Œã€æ¯”è³½ç±Œå‚™)</option>
                                <option value="è³‡æºç®¡ç†">è³‡æºç®¡ç† (ç‰©è³‡ã€å ´åœ°)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>é€£çµ (URL)</label>
                        <input type="text" id="appLink" class="form-control" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label>è§£æ±ºäº†ä»€éº¼é›£é»ï¼Ÿ</label>
                        <input type="text" id="appPainPoint" class="form-control" placeholder="ä¾‹å¦‚ï¼šç¯€çœäº†æ¯é€± 2 å°æ™‚çš„æ’ç‰ˆæ™‚é–“">
                    </div>
                    <div class="form-group">
                        <label>ç°¡ä»‹ (AI å°‡è¼”åŠ©æ¨™ç±¤)</label>
                        <textarea id="appDesc" class="form-control" rows="3" onblur="triggerAutoTag()" placeholder="è«‹æè¿°å·¥å…·åŠŸèƒ½..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>5C+ / é—œéµå­—æ¨™ç±¤ (å¯äººæ‰‹ä¿®æ”¹ï¼Œç”¨é€—è™Ÿåˆ†éš”)</label>
                        <input type="text" id="appTags" class="form-control" value="General">
                    </div>
                </div>

                <div id="promptForm" style="display:none;">
                    <div class="form-group">
                        <label>Prompt ä¸»é¡Œ</label>
                        <input type="text" id="promptTitle" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>æŒ‡ä»¤å…§å®¹</label>
                        <textarea id="promptContent" class="form-control" rows="6" style="font-family:monospace"></textarea>
                    </div>
                    <div class="form-group">
                        <label>ç”¨é€”/ç›®æ¨™</label>
                        <input type="text" id="promptPurpose" class="form-control">
                    </div>
                </div>

                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button id="submitBtn" class="btn btn-primary" style="flex:2" onclick="submitUpload()">ç¢ºèªç™¼å¸ƒ</button>
                    <button id="cancelBtn" class="btn btn-outline" style="flex:1; display:none" onclick="resetForm(true)">å–æ¶ˆç·¨è¼¯</button>
                    <button id="deleteBtn" class="btn btn-danger" style="flex:1; display:none" onclick="deleteResource()">ğŸ—‘ï¸ åˆªé™¤</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION ZONE V1.9
        // ==========================================
        const firebaseConfig = {
          apiKey: "AIzaSyBPRN5_vnvMOPAR0fTVaZoqM57ffIGZOQU",
          authDomain: "bck-ai-hub.firebaseapp.com",
          projectId: "bck-ai-hub",
          storageBucket: "bck-ai-hub.firebasestorage.app",
          messagingSenderId: "1010987556331",
          appId: "1:1010987556331:web:07dac81847056ae7520dae"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        let currentUser = null;
        let teachingChartRef = null;
        let subjectChartRef = null;
        let adminChartRef = null;

        const teacherDirectory = {
            "lwysams@bcklas.edu.hk": "ç©",
            "slssams@bcklas.edu.hk": "çŠ",
            "ckysams@bcklas.edu.hk": "å¾",
            "cymsams@bcklas.edu.hk": "æ–‡",
            "lysams@bcklas.edu.hk": "ç‡•",
            "hhysams@bcklas.edu.hk": "ä¾¯",
            "scysams@bcklas.edu.hk": "è˜‡",
            "ccwsams@bcklas.edu.hk": "ç‘‹",
            "ynysams@bcklas.edu.hk": "æ¥Š",
            "csysams@bcklas.edu.hk": "æ·‘",
            "dspsams@bcklas.edu.hk": "ä¸",
            "cherry@bcklas.edu.hk": "Cherry",
            "lslsams@bcklas.edu.hk": "éˆ´",
            "cpy2sams@bcklas.edu.hk": "å®¹",
            "lsysams@bcklas.edu.hk": "å‘‚",
            "twksams@bcklas.edu.hk": "æ…§",
            "wpwsams@bcklas.edu.hk": "æ¦®",
            "skysams@bcklas.edu.hk": "å…’",
            "cym2sams@bcklas.edu.hk": "ç¶º",
            "swysams@bcklas.edu.hk": "æ²ˆ",
            "whwsams@bcklas.edu.hk": "é¦¨",
            "ywysams@bcklas.edu.hk": "ä¿"
        };

        const subjectList = ["ä¸­æ–‡", "è‹±æ–‡", "æ•¸å­¸", "å¸¸è­˜/ç§‘å­¸", "äººæ–‡", "è¦–è—", "éŸ³æ¨‚", "é«”è‚²", "åœ–æ›¸", "æ™®é€šè©±", "ä½›å­¸", "ç§‘æŠ€", "åƒ¹å€¼è§€æ•™è‚²"];

        function initSubjectCheckboxes() {
            const container = document.getElementById('crossSubjectCheckboxes');
            container.innerHTML = '';
            subjectList.forEach(sub => {
                container.innerHTML += `<label class="checkbox-label"><input type="checkbox" name="crossSub" value="${sub}"> ${sub}</label>`;
            });
        }
        initSubjectCheckboxes();

        auth.onAuthStateChanged((user) => {
            if (user) {
                let finalName = teacherDirectory[user.email];
                if (!finalName) finalName = user.email.split('@')[0];
                currentUser = { name: finalName, email: user.email, uid: user.uid };
                document.getElementById('loginModal').style.display = 'none';
                updateUserDisplay();
                loadData();
            } else {
                currentUser = null;
                document.getElementById('loginModal').style.display = 'flex';
            }
        });

        function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            const msg = document.getElementById('loginMsg');
            msg.innerText = "ç™»å…¥ä¸­...";
            auth.signInWithEmailAndPassword(email, pass).catch(error => msg.innerText = "ç™»å…¥å¤±æ•—: " + error.message);
        }

        function logout() { auth.signOut().then(() => location.reload()); }
        function updateUserDisplay() { document.getElementById('currentUserDisplay').innerText = currentUser.name; }

        async function loadData() {
            try {
                const appsSnap = await db.collection('apps').orderBy('timestamp', 'desc').get();
                const apps = appsSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                const promptsSnap = await db.collection('prompts').orderBy('timestamp', 'desc').get();
                const prompts = promptsSnap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                
                renderDashboard(apps, prompts);
                renderApps(apps);
                renderPrompts(prompts);
            } catch (e) {
                console.error("Error loading data:", e);
            }
        }

        function submitRating(appId) {
            const easeVal = document.getElementById(`ease_${appId}`).value;
            const effectVal = document.getElementById(`effect_${appId}`).value;
            const updateData = {};
            updateData[`ratings.${currentUser.uid}`] = { ease: parseInt(easeVal), effect: parseInt(effectVal) };
            
            db.collection('apps').doc(appId).update(updateData)
                .then(() => { alert("è©•åˆ†æˆåŠŸï¼"); loadData(); })
                .catch(e => {
                     db.collection('apps').doc(appId).set({
                        ratings: { [currentUser.uid]: { ease: parseInt(easeVal), effect: parseInt(effectVal) } }
                     }, { merge: true }).then(() => { alert("è©•åˆ†æˆåŠŸï¼"); loadData(); });
                });
        }

        // V1.9 Comment Submission
        function submitComment(appId) {
            const input = document.getElementById(`comment_input_${appId}`);
            const text = input.value.trim();
            if(!text) return;
            
            const newComment = {
                author: currentUser.name,
                content: text,
                timestamp: Date.now()
            };

            db.collection('apps').doc(appId).update({
                comments: firebase.firestore.FieldValue.arrayUnion(newComment)
            }).then(() => {
                // alert("ç•™è¨€æˆåŠŸï¼"); // Optional: less intrusion
                loadData();
            }).catch(e => {
                 db.collection('apps').doc(appId).set({ comments: [newComment] }, { merge: true }).then(() => loadData());
            });
        }

        function renderApps(apps) {
            const container = document.getElementById('appsContainer');
            container.innerHTML = '';
            apps.forEach(app => {
                const tagsHtml = Array.isArray(app.tags) ? app.tags.map(t => `<span class="tag smart-tag">ğŸ¤– ${t}</span>`).join('') : '';
                
                let catBadge = '';
                let cardClass = app.category;
                if (app.category === 'teaching') {
                    if (app.subject === 'è·¨èª²ç¨‹') {
                        const crossSubs = (app.crossSubjects || []).join(' + ');
                        catBadge = `<span class="tag" style="background:var(--accent); color:white">è·¨èª²ç¨‹: ${crossSubs}</span>`;
                    } else if (app.subject === 'åƒ¹å€¼è§€æ•™è‚²') {
                        catBadge = `<span class="tag" style="background:var(--value-edu-color); color:white">ğŸ’— ${app.subject}</span>`;
                        cardClass = 'value-edu';
                    } else {
                        catBadge = `<span class="tag" style="background:var(--accent); color:white">å­¸æ•™è©•: ${app.subject}</span>`;
                    }
                } else {
                    catBadge = `<span class="tag" style="background:var(--admin-color); color:white">è¡Œæ”¿: ${app.adminType}</span>`;
                }
                
                const isAuthor = (app.author === currentUser.name) || (app.authorEmail && app.authorEmail === currentUser.email);
                const editBtn = isAuthor ? `<button class="btn btn-outline" style="font-size:0.7rem; float:right" onclick='editApp(${JSON.stringify(app)})'>âœï¸ ç·¨è¼¯</button>` : '';
                
                let imgHtml = `<div class="app-preview-placeholder"><span style="font-size:3rem">ğŸ“±</span></div>`;
                if(app.link && app.link.startsWith('http')) {
                    imgHtml = `<img src="https://image.thum.io/get/width/600/allowJPG/${app.link}" class="app-preview" onerror="this.style.display='none'">`;
                }

                // Ratings
                const ratings = app.ratings || {};
                const ratingValues = Object.values(ratings);
                let avgEase = "-", avgEffect = "-";
                if (ratingValues.length > 0) {
                    const totalEase = ratingValues.reduce((sum, r) => sum + (r.ease||0), 0);
                    const totalEffect = ratingValues.reduce((sum, r) => sum + (r.effect||0), 0);
                    avgEase = (totalEase / ratingValues.length).toFixed(1);
                    avgEffect = (totalEffect / ratingValues.length).toFixed(1);
                }

                const hasRated = ratings[currentUser.uid];
                let ratingHtml = hasRated 
                    ? `<div style="margin-top:5px; color:var(--success); font-size:0.85rem;">âœ… ä½ å·²è©•åƒ¹ (æ˜“: ${hasRated.ease}, æ•ˆ: ${hasRated.effect})</div>`
                    : `<div class="rating-form"><div class="rating-input-row"><label>æ˜“ç”¨:</label><select id="ease_${app.id}" class="rating-select"><option value="5">5</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option></select><label>æˆæ•ˆ:</label><select id="effect_${app.id}" class="rating-select"><option value="5">5</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option></select><button class="btn btn-primary btn-xs" onclick="submitRating('${app.id}')">è©•åˆ†</button></div></div>`;

                // Comments V1.9
                let commentsHtml = '';
                if(app.comments && app.comments.length > 0) {
                    app.comments.forEach(c => {
                        commentsHtml += `<div class="comment-item"><span class="comment-author">${c.author}ï¼š</span><span class="comment-content">${c.content}</span></div>`;
                    });
                } else {
                    commentsHtml = `<div style="color:#ccc; font-style:italic; font-size:0.8rem; padding:5px 0;">æš«ç„¡ç•™è¨€</div>`;
                }

                let html = `
                    <div class="card ${cardClass}" data-cat="${app.category}" data-sub="${app.subject}">
                        ${imgHtml}
                        <div class="card-content">
                            <h3 style="margin-top:0">${app.title} ${editBtn}</h3>
                            <div style="font-size:0.85rem; color:#7f8c8d; margin-bottom:10px;">ç”± ${app.author} æä¾›</div>
                            <div>${catBadge}</div>
                            <p style="font-size:0.9rem; color:#444"><strong>ğŸ’¡ è§£æ±ºé›£é»ï¼š</strong> ${app.painPoint}</p>
                            <p style="font-size:0.9rem; flex:1;">${app.desc}</p>
                            <div style="margin:10px 0;">${tagsHtml}</div>
                            
                            <div class="rating-badge-container">
                                <div class="badge-rate bg-ease"><span class="rate-label">æ˜“ç”¨åº¦</span><span class="rate-score">${avgEase}</span></div>
                                <div class="badge-rate bg-effect"><span class="rate-label">æˆæ•ˆ</span><span class="rate-score">${avgEffect}</span></div>
                            </div>
                            ${ratingHtml}
                            
                            <div class="comments-section">
                                <div class="comments-title">ğŸ’¬ åŒäº‹ç•™è¨€</div>
                                <div class="comment-list">${commentsHtml}</div>
                                <div class="comment-input-group">
                                    <input type="text" id="comment_input_${app.id}" class="comment-input" placeholder="æ’°å¯«ç•™è¨€...">
                                    <button class="btn btn-primary btn-xs" onclick="submitComment('${app.id}')">é€å‡º</button>
                                </div>
                            </div>

                            <a href="${app.link}" target="_blank" class="btn btn-primary" style="display:block; text-align:center; margin-top:10px;">å‰å¾€å·¥å…·</a>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function renderDashboard(apps, prompts) {
            const teachingApps = apps.filter(a => a.category === 'teaching');
            const adminApps = apps.filter(a => a.category === 'admin');
            
            document.getElementById('totalApps').innerText = teachingApps.length;
            document.getElementById('totalAdmin').innerText = adminApps.length;
            document.getElementById('totalPrompts').innerText = prompts.length;
            const authors = new Set([...apps.map(a=>a.author), ...prompts.map(p=>p.author)]);
            document.getElementById('activeTeachers').innerText = authors.size;

            // Teaching Radar
            const skillCounts = { "Communication":0, "Contribution":0, "Creativity":0, "Critical Thinking":0, "Collaboration":0 };
            teachingApps.forEach(a => { if(a.tags) a.tags.forEach(t => { if(skillCounts[t] !== undefined) skillCounts[t]++; }); });
            const ctx1 = document.getElementById('teachingChart').getContext('2d');
            if(teachingChartRef) teachingChartRef.destroy();
            teachingChartRef = new Chart(ctx1, {
                type: 'radar',
                data: {
                    labels: Object.keys(skillCounts),
                    datasets: [{ label: '5C+ ç´ é¤Š', data: Object.values(skillCounts), backgroundColor: 'rgba(52, 152, 219, 0.2)', borderColor: '#3498db' }]
                },
                options: { scales: { r: { beginAtZero: true, suggestMax: 5 } } }
            });

            // Subject Pie
            const subjectCounts = {};
            teachingApps.forEach(a => { const subj = a.subject || "æœªåˆ†é¡"; subjectCounts[subj] = (subjectCounts[subj] || 0) + 1; });
            const ctxSub = document.getElementById('subjectChart').getContext('2d');
            if(subjectChartRef) subjectChartRef.destroy();
            subjectChartRef = new Chart(ctxSub, {
                type: 'pie',
                data: {
                    labels: Object.keys(subjectCounts),
                    datasets: [{ data: Object.values(subjectCounts), backgroundColor: ['#e74c3c', '#3498db', '#f1c40f', '#2ecc71', '#9b59b6', '#e67e22', '#1abc9c', '#e91e63'] }]
                }
            });

            // Admin Bar
            const adminCounts = {};
            adminApps.forEach(a => { const type = a.adminType || "æœªåˆ†é¡"; adminCounts[type] = (adminCounts[type] || 0) + 1; });
            const categoryColors = { "æ ¡å‹™é‹ä½œ": "#3498db", "æ–‡æ›¸è™•ç†": "#9b59b6", "æ•¸æ“šåˆ†æ": "#2ecc71", "è³‡è¨Šé€šè¨Š": "#e67e22", "æ´»å‹•ç­–åŠƒ": "#e74c3c", "è³‡æºç®¡ç†": "#f1c40f", "æœªåˆ†é¡": "#95a5a6" };
            const bgColors = Object.keys(adminCounts).map(type => categoryColors[type] || "#34495e");
            const ctx2 = document.getElementById('adminChart').getContext('2d');
            if(adminChartRef) adminChartRef.destroy();
            adminChartRef = new Chart(ctx2, {
                type: 'bar',
                data: { labels: Object.keys(adminCounts), datasets: [{ label: 'è¡Œæ”¿å·¥å…·åˆ†é¡', data: Object.values(adminCounts), backgroundColor: bgColors, borderWidth: 1 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
            });

            // Leaderboard
            const authorStats = {};
            [...apps, ...prompts].forEach(item => {
                const author = item.author;
                if(!authorStats[author]) authorStats[author] = { count: 0, totalScore: 0, maxScore: 0, bestItem: null };
                
                let itemAvg = 0;
                if (item.ratings) {
                    const rVals = Object.values(item.ratings);
                    if (rVals.length > 0) {
                        const sum = rVals.reduce((acc, r) => acc + (r.ease + r.effect)/2, 0);
                        itemAvg = sum / rVals.length;
                    }
                }
                
                const s = authorStats[author];
                s.count++;
                s.totalScore += itemAvg;
                if(itemAvg > s.maxScore) { s.maxScore = itemAvg; s.bestItem = item; }
                if(!s.bestItem) s.bestItem = item; 
            });
            
            const sortedAuthors = Object.keys(authorStats).sort((a,b) => authorStats[b].count - authorStats[a].count).slice(0, 5);
            const lb = document.getElementById('leaderboardList');
            lb.innerHTML = '';
            sortedAuthors.forEach((name, index) => {
                const stat = authorStats[name];
                const bestTitle = stat.bestItem ? (stat.bestItem.title.length > 8 ? stat.bestItem.title.substring(0,8)+"..." : stat.bestItem.title) : "N/A";
                const linkAction = stat.bestItem && stat.bestItem.link ? `href="${stat.bestItem.link}" target="_blank"` : `href="#"`;
                const maxScoreDisp = stat.maxScore > 0 ? stat.maxScore.toFixed(1) : "-";

                lb.innerHTML += `
                    <div class="leaderboard-item">
                        <div class="lb-rank">#${index+1}</div>
                        <div class="lb-name">${name}</div>
                        <div class="lb-stats">
                            <div><span class="lb-highlight">${stat.count}</span> è²¢ç»</div>
                            <div style="font-size:0.75rem;">æœ€é«˜åˆ†ä½œå“: â˜…${maxScoreDisp} <a ${linkAction} class="lb-link">GO: ${bestTitle}</a></div>
                        </div>
                    </div>`;
            });
        }

        function renderPrompts(prompts) {
            const container = document.getElementById('promptsContainer');
            container.innerHTML = '';
            prompts.forEach(p => {
                const isAuthor = (p.author === currentUser.name) || (p.authorEmail && p.authorEmail === currentUser.email);
                const editBtn = isAuthor ? `<button class="btn btn-outline" style="font-size:0.7rem; float:right" onclick='editPrompt(${JSON.stringify(p)})'>âœï¸</button>` : '';
                container.innerHTML += `
                    <div class="card">
                        <div class="card-content">
                            <h3>${p.title} ${editBtn} <small style="font-size:0.8rem; display:block; margin-top:5px; font-weight:normal">${p.author}</small></h3>
                            <p><strong>ğŸ¯ ç”¨é€”ï¼š</strong>${p.purpose}</p>
                            <div style="background:#2c3e50; color:#2ecc71; padding:15px; border-radius:8px; font-family:monospace; margin:10px 0; max-height:150px; overflow-y:auto; white-space:pre-wrap; font-size:0.9rem;">${p.content}</div>
                            <button class="btn btn-outline" onclick="navigator.clipboard.writeText(\`${p.content}\`);alert('å·²è¤‡è£½ï¼')">è¤‡è£½æŒ‡ä»¤</button>
                        </div>
                    </div>`;
            });
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
                if(item.getAttribute('onclick').includes(`'${pageId}'`)) item.classList.add('active');
            });
        }

        function filterApps(type) {
            const cards = document.querySelectorAll('.card');
            cards.forEach(c => {
                c.style.display = 'none';
                const cat = c.getAttribute('data-cat');
                const sub = c.getAttribute('data-sub');
                if (type === 'all') c.style.display = 'flex';
                else if (type === 'value') { if(sub === 'åƒ¹å€¼è§€æ•™è‚²') c.style.display = 'flex'; }
                else if (cat === type) c.style.display = 'flex';
            });
        }

        function handleCategoryChange() {
            const cat = document.getElementById('appCategory').value;
            const subEl = document.getElementById('appSubject');
            const adminEl = document.getElementById('adminTypeGroup');
            const subGroup = document.getElementById('subjectGroup');
            if (cat === 'admin') { subEl.disabled = true; subGroup.style.opacity = "0.5"; adminEl.style.display = 'block'; } 
            else { subEl.disabled = false; subGroup.style.opacity = "1"; adminEl.style.display = 'none'; }
        }
        
        function handleSubjectChange() {
            const sub = document.getElementById('appSubject').value;
            const crossSection = document.getElementById('crossSubjectSection');
            if (sub === 'è·¨èª²ç¨‹') {
                crossSection.style.display = 'block';
            } else {
                crossSection.style.display = 'none';
                document.querySelectorAll('input[name="crossSub"]').forEach(cb => cb.checked = false);
            }
        }

        function triggerAutoTag() {
            const desc = document.getElementById('appDesc').value;
            const title = document.getElementById('appTitle').value;
            const currentTags = document.getElementById('appTags').value;
            if(currentTags === '' || currentTags === 'General') {
                let tags = [];
                const combined = desc + title;
                if(combined.includes("ç•«") || combined.includes("å‰µ")) tags.push("Creativity");
                if(combined.includes("å•") || combined.includes("æ€")) tags.push("Critical Thinking");
                if(combined.includes("çµ„") || combined.includes("åˆ")) tags.push("Collaboration");
                if(combined.includes("èªª") || combined.includes("è©±")) tags.push("Communication");
                if(combined.includes("å¹«") || combined.includes("äº«")) tags.push("Contribution");
                if(tags.length > 0) document.getElementById('appTags').value = tags.join(", ");
            }
        }

        function toggleUploadForm() {
            const type = document.getElementById('uploadType').value;
            document.getElementById('appForm').style.display = type === 'app' ? 'block' : 'none';
            document.getElementById('promptForm').style.display = type === 'prompt' ? 'block' : 'none';
        }

        function submitUpload() {
            const isEdit = document.getElementById('editModeId').value !== "";
            const collection = document.getElementById('uploadType').value === 'app' ? 'apps' : 'prompts';
            const data = {
                title: document.getElementById(collection === 'apps' ? 'appTitle' : 'promptTitle').value,
                author: currentUser.name,
                authorEmail: currentUser.email,
                timestamp: Date.now()
            };

            if(collection === 'apps') {
                let crossSubs = [];
                if(document.getElementById('appSubject').value === 'è·¨èª²ç¨‹') {
                    document.querySelectorAll('input[name="crossSub"]:checked').forEach(cb => crossSubs.push(cb.value));
                }
                Object.assign(data, {
                    category: document.getElementById('appCategory').value,
                    subject: document.getElementById('appSubject').value,
                    crossSubjects: crossSubs,
                    adminType: document.getElementById('appAdminType').value,
                    link: document.getElementById('appLink').value,
                    painPoint: document.getElementById('appPainPoint').value,
                    desc: document.getElementById('appDesc').value,
                    tags: document.getElementById('appTags').value.split(',').map(s=>s.trim())
                });
                if(!isEdit) data.ratings = {}; 
            } else {
                Object.assign(data, { content: document.getElementById('promptContent').value, purpose: document.getElementById('promptPurpose').value });
            }

            const action = isEdit 
                ? db.collection(collection).doc(document.getElementById('editModeId').value).update(data)
                : db.collection(collection).add(data);

            action.then(() => {
                alert(isEdit ? "æ›´æ–°æˆåŠŸ" : "ç™¼å¸ƒæˆåŠŸ");
                resetForm(true); 
                loadData();
            }).catch(e => alert("éŒ¯èª¤: " + e.message));
        }

        function deleteResource() {
            const docId = document.getElementById('editModeId').value;
            if(!docId) return;
            if(confirm("âš ï¸ ç¢ºå®šè¦åˆªé™¤é€™å€‹è³‡æºå—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•é‚„åŸã€‚")) {
                const collection = document.getElementById('uploadType').value === 'app' ? 'apps' : 'prompts';
                db.collection(collection).doc(docId).delete().then(() => { alert("å·²åˆªé™¤"); resetForm(true); loadData(); });
            }
        }

        function editApp(app) {
            showPage('upload');
            document.getElementById('editModeId').value = app.id;
            document.getElementById('uploadType').value = 'app';
            toggleUploadForm();
            document.getElementById('appTitle').value = app.title;
            document.getElementById('appCategory').value = app.category;
            handleCategoryChange();
            document.getElementById('appSubject').value = app.subject || "";
            handleSubjectChange(); 
            if (app.subject === 'è·¨èª²ç¨‹' && app.crossSubjects) {
                app.crossSubjects.forEach(sub => {
                    const cb = document.querySelector(`input[name="crossSub"][value="${sub}"]`);
                    if(cb) cb.checked = true;
                });
            }
            document.getElementById('appAdminType').value = app.adminType || "";
            document.getElementById('appLink').value = app.link;
            document.getElementById('appPainPoint').value = app.painPoint;
            document.getElementById('appDesc').value = app.desc;
            document.getElementById('appTags').value = Array.isArray(app.tags) ? app.tags.join(", ") : app.tags;
            
            const btn = document.getElementById('submitBtn');
            btn.innerText = "ç¢ºèªæ›´æ–°";
            btn.classList.replace('btn-primary', 'btn-success');
            document.getElementById('cancelBtn').style.display = 'block';
            document.getElementById('deleteBtn').style.display = 'block'; 
        }

        function editPrompt(p) {
            showPage('upload');
            document.getElementById('editModeId').value = p.id;
            document.getElementById('uploadType').value = 'prompt';
            toggleUploadForm();
            document.getElementById('promptTitle').value = p.title;
            document.getElementById('promptContent').value = p.content;
            document.getElementById('promptPurpose').value = p.purpose;
            const btn = document.getElementById('submitBtn');
            btn.innerText = "ç¢ºèªæ›´æ–°";
            btn.classList.replace('btn-primary', 'btn-success');
            document.getElementById('cancelBtn').style.display = 'block';
            document.getElementById('deleteBtn').style.display = 'block';
        }

        function resetForm(shouldRedirect = false) {
            document.getElementById('editModeId').value = "";
            document.querySelectorAll('input, textarea').forEach(i => i.value = "");
            document.getElementById('appTags').value = "General";
            document.querySelectorAll('input[name="crossSub"]').forEach(cb => cb.checked = false);
            document.getElementById('crossSubjectSection').style.display = 'none';
            const btn = document.getElementById('submitBtn');
            btn.innerText = "ç¢ºèªç™¼å¸ƒ";
            btn.classList.replace('btn-success', 'btn-primary');
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('deleteBtn').style.display = 'none';
            if (shouldRedirect) {
                const currentType = document.getElementById('uploadType').value;
                showPage(currentType === 'app' ? 'apps' : 'prompts');
            }
        }

        function exportDataReport() {
            db.collection('apps').get().then(snap => {
                let csv = "data:text/csv;charset=utf-8,\uFEFFID,Title,Category,Subject/Type,CrossSubs,Author,PainPoint\n";
                snap.forEach(doc => {
                    const d = doc.data();
                    const sub = d.category==='teaching' ? d.subject : d.adminType;
                    const cross = d.crossSubjects ? d.crossSubjects.join(';') : '';
                    csv += `${doc.id},${d.title},${d.category},${sub},${cross},${d.author},"${d.painPoint}"\n`;
                });
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csv));
                link.setAttribute("download", "BCK_Report.csv");
                document.body.appendChild(link);
                link.click();
            });
        }
    </script>
</body>
</html>
