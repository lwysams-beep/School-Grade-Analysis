<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨ç´šå­¸è¡“æˆç¸¾åˆ†æç³»çµ± (V29.7 ç™»å…¥ä¿®å¾©ç‰ˆ)</title>
    
    <!-- æ ¸å¿ƒå‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- ä¿®æ­£ï¼šæŒ‡å®š Plotly ç‰ˆæœ¬ (v2.35.2) ä»¥è§£æ±º console è­¦å‘Š -->
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-statistics/7.7.0/simple-statistics.min.js"></script>

    <!-- Firebase æ ¸å¿ƒ -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // ============================================================
        // âš ï¸âš ï¸âš ï¸ ã€ç®¡ç†å“¡è¨­å®šå€ã€‘ âš ï¸âš ï¸âš ï¸
        // ============================================================
        
        // 1. è«‹å¡«å…¥ Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyBYtaDjYgO0F2qlvWgmeMavE0SUBTzFONU",
            authDomain: "school-grade-analysis-ed4e1.firebaseapp.com",
            projectId: "school-grade-analysis-ed4e1",
            storageBucket: "school-grade-analysis-ed4e1.firebasestorage.app",
            messagingSenderId: "119965796660",
            appId: "1:119965796660:web:55e160b8eab960ab157d61",
            measurementId: "G-S36T3HV2PT"
        };

        // 2. å‰ç«¯ç®¡ç†å“¡åå–® (æ§åˆ¶æŒ‰éˆ•é¡¯ç¤º)
        const ADMIN_EMAILS = [
            "lwysams.beep@gmail.com",
            "lwysams@bcklas.edu.hk", 
            "admin@school.edu.hk",
            "principal@school.edu.hk"
        ];
        // ============================================================

        // å…¨åŸŸè®Šæ•¸
        let db = null, auth = null;
        let currentUserIsAdmin = false;
        let globalAiPromptText = ""; 
        
        // æ•¸æ“šè®Šæ•¸
        var rawInfo = [], rawOld = [], rawNew = [];
        var rawInfoHeaders = []; // ç”¨æ–¼å‹•æ…‹åˆ†ç­é¸å–®
        var cachedColIndices = {}; 
        var cachedValidRegNos = new Set();
        var cachedMapOld = {}, cachedMapNew = {}; // ç·©å­˜åˆ†æ•¸æ˜ å°„ï¼Œä¾›å‹•æ…‹åˆ‡æ›ä½¿ç”¨

        var processedData = {};
        var classStats = {}; 
        var globalMeans = {};
        var globalSDs = {};
        var processedDataExport = null; 
        var currentGrade = '1';

        // åˆå§‹åŒ– Firebase
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof firebase === 'undefined') {
                alert("âŒ ç„¡æ³•è¼‰å…¥ Firebaseï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
                return;
            }

            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                auth = firebase.auth();
                
                // ç›£è½ç™»å…¥ç‹€æ…‹
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        currentUserIsAdmin = ADMIN_EMAILS.some(email => email.toLowerCase() === user.email.toLowerCase());
                        document.getElementById('login-overlay').style.display = 'none';
                        document.getElementById('main-app').style.display = 'block';
                        
                        const roleText = currentUserIsAdmin ? "ç®¡ç†å“¡ (å¯ç·¨è¼¯)" : "è€å¸« (å”¯è®€)";
                        const roleColor = currentUserIsAdmin ? "#d32f2f" : "#2e7d32";
                        document.getElementById('user-email-display').innerHTML = `
                            <span style="color:${roleColor}; font-weight:bold; font-size:0.9em; margin-right:5px;">[${roleText}]</span> 
                            ${user.email}`;
                        
                        document.querySelectorAll('.admin-only').forEach(el => {
                            el.style.display = currentUserIsAdmin ? 'inline-flex' : 'none';
                        });

                        const statusDiv = document.getElementById('cloudStatus');
                        if(currentUserIsAdmin) {
                            statusDiv.innerText = "âœ… ç®¡ç†å“¡æ¨¡å¼ï¼šé›²ç«¯é€£ç·šæˆåŠŸ";
                            statusDiv.style.backgroundColor = "#e8f5e9";
                        } else {
                            statusDiv.innerText = "ğŸ‘ï¸ æª¢è¦–æ¨¡å¼ï¼šé›²ç«¯é€£ç·šæˆåŠŸ";
                            statusDiv.style.backgroundColor = "#e3f2fd";
                            statusDiv.style.color = "#0d47a1";
                        }

                        window.loadFromCloud_Impl('1'); 
                    } else {
                        document.getElementById('login-overlay').style.display = 'flex';
                        document.getElementById('main-app').style.display = 'none';
                    }
                });

            } catch (e) {
                console.error("Firebase Init Error:", e);
                alert("åˆå§‹åŒ–å¤±æ•—: " + e.message);
            }
        });

        // --- ç™»å…¥åŠŸèƒ½ ---
        window.performLogin = function() {
            const emailField = document.getElementById('loginEmail');
            const passField = document.getElementById('loginPass');
            const btn = document.getElementById('btnLoginBtn');
            const msg = document.getElementById('loginMsg');

            // éŒ¯èª¤æª¢æŸ¥ï¼šç¢ºä¿å…ƒç´ å­˜åœ¨
            if (!emailField || !passField || !btn || !msg) {
                console.error("æ‰¾ä¸åˆ°ç™»å…¥è¡¨å–®å…ƒç´ ");
                return;
            }

            const email = emailField.value;
            const pass = passField.value;

            if(!email || !pass) {
                msg.innerText = "è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼";
                return;
            }

            btn.disabled = true;
            btn.innerText = "é©—è­‰ä¸­...";
            msg.innerText = "";

            if (!auth) {
                 msg.innerText = "Firebase æœªåˆå§‹åŒ–ï¼Œè«‹æª¢æŸ¥è¨­å®š";
                 btn.disabled = false;
                 btn.innerText = "Login";
                 return;
            }

            auth.signInWithEmailAndPassword(email, pass)
                .catch((error) => {
                    btn.disabled = false;
                    btn.innerText = "Login";
                    let t = "ç™»å…¥å¤±æ•—";
                    if(error.code === 'auth/wrong-password') t = "å¯†ç¢¼éŒ¯èª¤";
                    if(error.code === 'auth/user-not-found') t = "æ‰¾ä¸åˆ°æ­¤å¸³è™Ÿ";
                    msg.innerText = `âŒ ${t}`;
                });
        };

        window.performLogout = function() {
            if(auth) auth.signOut().then(() => location.reload());
            else location.reload();
        };

        // --- é›²ç«¯åŠŸèƒ½ ---
        window.saveToCloud_Impl = async function() {
            if (!currentUserIsAdmin) { alert("âŒ æ¬Šé™ä¸è¶³ï¼šæ‚¨æ˜¯å”¯è®€å¸³è™Ÿã€‚"); return; }
            if(!processedDataExport) { alert("âŒ æ²’æœ‰æ•¸æ“šå¯å„²å­˜ï¼"); return; }
            
            const grade = window.currentGrade;
            const btn = document.getElementById('btnSaveCloud');
            const originalText = btn.innerText;
            btn.innerText = "â˜ï¸ å„²å­˜ä¸­...";
            btn.disabled = true;

            try {
                const jsonString = JSON.stringify(processedDataExport, (key, val) => 
                    (typeof val === 'number' && isNaN(val)) ? "###NaN###" : val
                );
                
                await db.collection("grades").doc(grade).set({
                    data: JSON.parse(jsonString),
                    updatedAt: new Date().toLocaleString(),
                    editor: auth.currentUser.email
                });
                
                alert(`âœ… P${grade} æ•¸æ“šå·²æˆåŠŸä¸Šå‚³ï¼`);
                document.getElementById('cloudStatus').innerText = `âœ… P${grade} æ•¸æ“šå·²åŒæ­¥ (æ›´æ–°æ–¼: ${new Date().toLocaleString()})`;
            } catch (e) {
                console.error(e);
                alert("âŒ å„²å­˜å¤±æ•—ï¼\n" + e.message);
            }
            btn.innerText = originalText;
            btn.disabled = false;
        };

        window.loadFromCloud_Impl = async function(grade) {
            const statusDiv = document.getElementById('cloudStatus');
            statusDiv.innerText = `â³ è®€å– P${grade} ä¸­...`;
            try {
                const docRef = db.collection("grades").doc(grade);
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    const d = docSnap.data().data;
                    const cleanData = JSON.parse(JSON.stringify(d), (k, v) => v === "###NaN###" ? NaN : v);
                    
                    window.processedData = cleanData.processedData;
                    window.classStats = cleanData.classStats;
                    window.globalMeans = cleanData.globalMeans;
                    window.globalSDs = cleanData.globalSDs;
                    window.processedDataExport = cleanData;
                    
                    document.getElementById('grouping-bar').style.display = 'none'; 
                    
                    window.restoreDashboardUI(true);
                    
                    let roleMsg = currentUserIsAdmin ? "" : " (å”¯è®€)";
                    statusDiv.innerText = `âœ… å·²è¼‰å…¥ P${grade}${roleMsg} (æ›´æ–°æ–¼: ${docSnap.data().updatedAt})`;
                } else {
                    statusDiv.innerText = `â„¹ï¸ P${grade} ç„¡æ•¸æ“š`;
                    if(currentUserIsAdmin) window.resetToUploadMode();
                    else alert("æ­¤å¹´ç´šå°šç„¡æ•¸æ“šã€‚");
                }
            } catch (e) {
                console.error(e);
                statusDiv.innerText = `âŒ è®€å–éŒ¯èª¤: ${e.message}`;
            }
        };

        window.switchGradeUI = function(grade) {
            currentGrade = grade;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.nav-btn')[grade-1].classList.add('active');
            document.getElementById('currentGradeBadge').innerText = `P${grade}`;
            if(auth && auth.currentUser) window.loadFromCloud_Impl(grade);
        };

        // --- æ ¸å¿ƒé‚è¼¯ ---
        window.handleFileSelect = function(input, type) { 
            if (input.files[0]) parseCSV(input.files[0], type); 
        };

        function parseCSV(file, type) {
            Papa.parse(file, {
                header: false, skipEmptyLines: true, encoding: document.getElementById('encodingSelect').value,
                complete: (res) => {
                    const h = res.data[0];
                    if(type === 'info') { 
                        rawInfo = res.data; 
                        rawInfoHeaders = h; 
                        initDropdown('stuSettings', h, [
                            {id:'colClass', keys:['ç­','class']},
                            {id:'colName', keys:['å§“å','name']},
                            {id:'colRegInfo', keys:['è¨»å†Š','reg']}
                        ]); 
                    }
                    if(type === 'old') { rawOld = res.data; initDropdown('oldScoreSettings', h, [{id:'colOldReg',keys:['è¨»å†Š','reg']},{id:'colOldChi',keys:['ä¸­æ–‡','chi']},{id:'colOldEng',keys:['è‹±æ–‡','eng']},{id:'colOldMath',keys:['æ•¸å­¸','math']}]); }
                    if(type === 'new') { rawNew = res.data; initDropdown('newScoreSettings', h, [{id:'colNewReg',keys:['è¨»å†Š','reg']},{id:'colNewClassNum',keys:['ç­è™Ÿ','class no']},{id:'colNewChi',keys:['ä¸­æ–‡','chi']},{id:'colNewEng',keys:['è‹±æ–‡','eng']},{id:'colNewMath',keys:['æ•¸å­¸','math']}]); }
                    document.getElementById('msg-'+type).innerText = "âœ… OK";
                }
            });
        }

        function initDropdown(pid, headers, cfgs) {
            document.getElementById(pid).style.display = 'block';
            cfgs.forEach(c => {
                const s = document.getElementById(c.id);
                s.innerHTML='';
                let def = 0;
                headers.forEach((h,i) => { 
                    s.add(new Option(`[${i}] ${h}`, i)); 
                    if(c.keys.some(k=>String(h).toLowerCase().includes(k))) def=i;
                });
                s.value = def;
            });
        }

        window.processData = function() {
            if (!rawInfo.length || !rawOld.length || !rawNew.length) return alert("è«‹ä¸Šå‚³æ‰€æœ‰æª”æ¡ˆ");
            
            const getVal = (id) => parseInt(document.getElementById(id).value);
            
            cachedColIndices = {
                regInfo: getVal('colRegInfo'),
                name: getVal('colName'),
                class: getVal('colClass'), 
                newClassNum: getVal('colNewClassNum')
            };

            const cleanReg = (v) => v ? String(v).replace(/[\s\uFEFF\xA0]/g, '').toUpperCase() : "";
            cachedValidRegNos = new Set();
            rawInfo.slice(1).forEach(r => { const reg = cleanReg(r[cachedColIndices.regInfo]); if(reg) cachedValidRegNos.add(reg); });

            if(cachedValidRegNos.size === 0) return alert("æ‰¾ä¸åˆ°æœ‰æ•ˆçš„è¨»å†Šç·¨è™Ÿ");

            const parseScore = (v) => {
                const s = String(v).trim();
                return (s===''||['abs','--'].includes(s.toLowerCase())) ? NaN : parseFloat(s);
            };

            const getScores = (data, idxReg, idxChi, idxEng, idxMath, idxClassNum=null) => {
                const map = {};
                data.slice(1).forEach(r => {
                    const reg = cleanReg(r[idxReg]);
                    if(reg) {
                        const num = idxClassNum!==null ? parseInt(String(r[idxClassNum]).replace(/\D/g,'')) : 0;
                        map[reg] = { chi: parseScore(r[idxChi]), eng: parseScore(r[idxEng]), math: parseScore(r[idxMath]), classNum: isNaN(num)?0:num };
                    }
                });
                return map;
            };

            cachedMapOld = getScores(rawOld, getVal('colOldReg'), getVal('colOldChi'), getVal('colOldEng'), getVal('colOldMath'));
            cachedMapNew = getScores(rawNew, getVal('colNewReg'), getVal('colNewChi'), getVal('colNewEng'), getVal('colNewMath'), getVal('colNewClassNum'));

            // è¨ˆç®—å…¨ç´šå¹³å‡
            let sums = {chi:{o:0,n:0,c:0,arr:[]}, eng:{o:0,n:0,c:0,arr:[]}, math:{o:0,n:0,c:0,arr:[]}};
            [cachedMapOld, cachedMapNew].forEach((map, isNew) => {
                Object.keys(map).forEach(reg => {
                    if (cachedValidRegNos.has(reg)) {
                        ['chi','eng','math'].forEach(sub => {
                            const val = map[reg][sub];
                            if(!isNaN(val)) {
                                if(isNew) { sums[sub].n += val; sums[sub].c++; sums[sub].arr.push(val); }
                                else { sums[sub].o += val; }
                            }
                        });
                    }
                });
            });

            globalMeans = {}; globalSDs = {};
            ['chi','eng','math'].forEach(sub => {
                globalMeans[sub] = { old: sums[sub].c ? (sums[sub].o / sums[sub].c) : 0, new: sums[sub].c ? (sums[sub].n / sums[sub].c) : 0 };
                globalSDs[sub] = sums[sub].arr.length > 1 ? ss.standardDeviation(sums[sub].arr) : 15;
            });

            initGroupingSwitcher(cachedColIndices.class);
            applyGrouping(cachedColIndices.class);
        };

        function initGroupingSwitcher(defaultIdx) {
            const bar = document.getElementById('grouping-bar');
            const sel = document.getElementById('groupingSelect');
            bar.style.display = 'flex';
            sel.innerHTML = '';
            rawInfoHeaders.forEach((h, i) => { sel.add(new Option(h, i)); });
            sel.value = defaultIdx;
        }

        window.handleGroupingChange = function() {
            const newIdx = parseInt(document.getElementById('groupingSelect').value);
            applyGrouping(newIdx);
        };

        window.applyGrouping = function(classColIdx) {
            processedData = {};
            const cleanReg = (v) => v ? String(v).replace(/[\s\uFEFF\xA0]/g, '').toUpperCase() : "";
            
            rawInfo.slice(1).forEach(r => {
                const reg = cleanReg(r[cachedColIndices.regInfo]);
                if(reg && cachedValidRegNos.has(reg)) {
                    const clsVal = r[classColIdx];
                    const cls = clsVal ? clsVal.trim() : "æœªåˆ†ç­";
                    const name = r[cachedColIndices.name] ? r[cachedColIndices.name].trim() : "Unknown";
                    
                    const o = cachedMapOld[reg] || { chi: NaN, eng: NaN, math: NaN };
                    const n = cachedMapNew[reg] || { chi: NaN, eng: NaN, math: NaN, classNum: 0 };
                    
                    if(['chi','eng','math'].some(sub => !isNaN(o[sub]) || !isNaN(n[sub]))) {
                        const student = { name: name, cls: cls, classNum: n.classNum || 0 };
                        
                        let totalNew = 0, countNew = 0;
                        ['chi','eng','math'].forEach(sub => {
                            const oldScore = o[sub];
                            const newScore = n[sub];
                            if (!isNaN(newScore)) { totalNew += newScore; countNew++; }
                            
                            let diff = NaN;
                            if(!isNaN(oldScore) && !isNaN(newScore)) {
                                diff = (newScore - globalMeans[sub].new) - (oldScore - globalMeans[sub].old);
                            }
                            student[sub] = { old: oldScore, new: newScore, diff: diff };
                        });

                        student.avg = countNew > 0 ? (totalNew / countNew) : 0;

                        if(!processedData[cls]) processedData[cls] = [];
                        processedData[cls].push(student);
                    }
                }
            });

            if (Object.keys(processedData).length === 0) { alert("âš ï¸ æ­¤åˆ†ç­æ¬„ä½æ²’æœ‰ç”¢ç”Ÿæœ‰æ•ˆæ•¸æ“šï¼"); return; }

            classStats = {};
            Object.keys(processedData).sort().forEach(cls => {
                classStats[cls] = {};
                ['chi','eng','math'].forEach(sub => {
                    let imp = 0, reg = 0, sOld = 0, cOld = 0, sNew = 0, cNew = 0, arrNew = [];
                    processedData[cls].forEach(s => {
                        if(!isNaN(s[sub].old)) { sOld+=s[sub].old; cOld++; }
                        if(!isNaN(s[sub].new)) { sNew+=s[sub].new; cNew++; arrNew.push(s[sub].new); }
                        if(!isNaN(s[sub].diff)) { if(s[sub].diff >= 0) imp++; else reg++; }
                    });
                    classStats[cls][sub] = { 
                        improved: imp, regressed: reg, 
                        avgOld: cOld?sOld/cOld:0, avgNew: cNew?sNew/cNew:0, 
                        sd: arrNew.length>1 ? ss.standardDeviation(arrNew):0 
                    };
                });
            });

            processedDataExport = { processedData, classStats, globalMeans: globalMeans, globalSDs: globalSDs };
            restoreDashboardUI(false);
        };

        window.restoreDashboardUI = function(isCloudMode) {
            document.getElementById('mainControlPanel').style.display = 'none';
            document.getElementById('reportHeader').style.display = 'block';
            
            if(isCloudMode) {
                 document.getElementById('reportHeader').innerHTML = "ğŸ‘ï¸ <b>é›²ç«¯æª¢è¦–æ¨¡å¼</b>";
            } else {
                 document.getElementById('reportHeader').innerHTML = "ğŸ“Š <b>å³æ™‚åˆ†ææ¨¡å¼</b>";
                 document.getElementById('cloudActions').style.display = currentUserIsAdmin ? 'flex' : 'none';
            }

            const select = document.getElementById('classSelect');
            select.innerHTML = '<option value="">-- è«‹é¸æ“‡ç­åˆ¥ --</option>';
            Object.keys(processedData).sort().forEach(c => select.add(new Option(c, c)));

            ['stats-banner', 'macro-section', 'risk-section', 'ranking-section', 'detail-section', 'ai-section'].forEach(id => {
                document.getElementById(id).style.display = 'block';
            });

            window.renderAllCharts();
        };

        window.renderAllCharts = function() {
            updateMacroCharts();
            const riskList = [];
            Object.values(processedData).flat().forEach(s => {
                let drop=0, valid=0;
                ['chi','eng','math'].forEach(sub => { if(!isNaN(s[sub].diff)) { valid++; if(s[sub].diff < -0.5) drop++; } });
                if(valid >= 2 && drop === valid) riskList.push(s);
            });
            updateRiskTable(riskList);
            updateRankings();
            window.updateDetailControls();
            generateAIReport();
        };

        window.updateMacroCharts = function() {
            const subject = document.getElementById('macroSubjectSelect').value;
            const classes = Object.keys(classStats).sort();
            
            const t1 = { x: classes, y: classes.map(c => classStats[c][subject].improved), name: 'ç›¸å°é€²æ­¥', type: 'bar', marker: { color: '#2ca02c' } };
            const t2 = { x: classes, y: classes.map(c => classStats[c][subject].regressed), name: 'ç›¸å°é€€æ­¥', type: 'bar', marker: { color: '#d62728' } };
            Plotly.newPlot('chart-bar-stats', [t1, t2], { barmode: 'group', margin: {t:30,b:40} });

            const lines = [];
            classes.forEach(cls => {
                const o = classStats[cls][subject].avgOld, n = classStats[cls][subject].avgNew;
                if(o && n) lines.push({ x: ['èˆŠå¹³å‡', 'æ–°å¹³å‡'], y: [o, n], mode: 'lines+markers', name: cls });
            });
            lines.push({ x: ['èˆŠå¹³å‡', 'æ–°å¹³å‡'], y: [globalMeans[subject].old, globalMeans[subject].new], mode: 'lines+markers', name: 'å…¨ç´šå¹³å‡', line: { color: 'black', width: 4, dash: 'dot' } });
            Plotly.newPlot('chart-line-avg', lines, { margin: {t:30,b:40} });

            const hists = [];
            classes.forEach((cls, i) => {
                const scores = [];
                if(processedData[cls]) processedData[cls].forEach(s => { if(!isNaN(s[subject].new)) scores.push(s[subject].new); });
                hists.push({ x: scores, type: 'histogram', name: cls, opacity: 0.75, xbins: { size: 5 } });
            });
            Plotly.newPlot('chart-dist', hists, { barmode: 'stack', margin: {t:30,b:40} });
            
            const diff = (globalMeans[subject].new - globalMeans[subject].old).toFixed(1);
            document.getElementById('macro-score-diff').innerText = `å…¨ç´šè®Šå‹•: ${diff>0?'+':''}${diff}`;
        };

        window.updateRiskTable = function(list) {
            const t = document.querySelector('#riskTable tbody'); t.innerHTML = '';
            list.forEach(s => { t.innerHTML += `<tr><td>${s.cls}</td><td>${s.name}</td><td style="color:red">${(s.chi.diff||0).toFixed(1)}</td><td style="color:red">${(s.eng.diff||0).toFixed(1)}</td><td style="color:red">${(s.math.diff||0).toFixed(1)}</td></tr>`; });
        };

        window.updateRankings = function() {
            const sub = document.getElementById('rankSubjectSelect').value;
            let all = [];
            Object.values(processedData).flat().forEach(s => { if(!isNaN(s[sub].diff)) all.push({ ...s, val: s[sub].diff }); });
            all.sort((a,b) => b.val - a.val);
            const r = (s, i, c) => `<tr><td>${i+1}</td><td>${s.cls}</td><td>${s.name}</td><td style="color:${c}">${s.val>0?'+':''}${s.val.toFixed(1)}</td></tr>`;
            document.getElementById('rankBodyImpContent').innerHTML = all.slice(0,20).map((s,i) => r(s,i,'green')).join('');
            document.getElementById('rankBodyRegContent').innerHTML = all.slice().reverse().slice(0,20).map((s,i) => r(s,i,'red')).join('');
        };

        window.updateDetailControls = function() {
            const m = document.getElementById('viewMode').value;
            document.getElementById('sortControl').style.display = (m !== 'all') ? 'inline-block' : 'none';
            window.drawDetailChart();
        };

        window.drawDetailChart = function() {
            const cls = document.getElementById('classSelect').value;
            const viewMode = document.getElementById('viewMode').value; 
            const sortMode = document.getElementById('sortMode').value;
            if(!cls || !processedData[cls]) return;
            
            let students = [...processedData[cls]];
            
            if (viewMode === 'all') { 
                students.sort((a, b) => (b.classNum || 0) - (a.classNum || 0)); 
            } else { 
                const sub = viewMode; 
                students.sort((a, b) => { 
                    if (sortMode === 'avg') return (a.avg || 0) - (b.avg || 0); 
                    if (sortMode === 'scoreNew') return (a[sub].new || 0) - (b[sub].new || 0);
                    if (sortMode === 'scoreOld') return (a[sub].old || 0) - (b[sub].old || 0);
                    if (sortMode === 'diff') return (a[sub].diff || 0) - (b[sub].diff || 0);
                    return (b.classNum || 0) - (a.classNum || 0); 
                }); 
            }

            const names = students.map(s => s.name);
            const traces = [], shapes = [], annotations = [];
            const layouts = { chi: {d:[0,0.32],t:'ä¸­æ–‡',k:'chi'}, eng: {d:[0.34,0.66],t:'è‹±æ–‡',k:'eng'}, math: {d:[0.68,1],t:'æ•¸å­¸',k:'math'} };
            const active = viewMode === 'all' ? [layouts.chi, layouts.eng, layouts.math] : [layouts[viewMode]];

            active.forEach((L, i) => {
                const axis = viewMode==='all' ? (i===0?'x':(i===1?'x2':'x3')) : 'x';
                const gm = globalMeans[L.k];
                shapes.push({ type: 'line', x0: gm.old, x1: gm.old, y0:0, y1:1, xref: axis, yref: 'paper', line: { color: '#ccc', dash: 'dot' } });
                shapes.push({ type: 'line', x0: gm.new, x1: gm.new, y0:0, y1:1, xref: axis, yref: 'paper', line: { color: '#666', dash: 'dash' } });

                const colors = students.map(s => isNaN(s[L.k].diff) ? 'grey' : (s[L.k].diff>=0?'#2ca02c':'#d62728'));
                traces.push({ x: students.map(s=>s[L.k].old), y: names, xaxis: axis, yaxis: 'y', mode: 'markers', marker: {color:'#eee', size:8} });
                traces.push({ x: students.map(s=>s[L.k].new), y: names, xaxis: axis, yaxis: 'y', mode: 'markers', marker: {color:colors, size:10} });

                students.forEach(s => {
                    if(!isNaN(s[L.k].old) && !isNaN(s[L.k].new)) {
                        const c = s[L.k].diff>=0?'#2ca02c':'#d62728';
                        annotations.push({ x: s[L.k].new, y: s.name, ax: s[L.k].old, ay: s.name, xref: axis, yref:'y', axref: axis, ayref:'y', showarrow:true, arrowcolor:c });
                        annotations.push({ x: Math.max(s[L.k].old, s[L.k].new)+3, y: s.name, xref: axis, yref:'y', text: String(s[L.k].new), showarrow:false, font:{color:c, size:10}, xanchor:'left' });
                    }
                });
            });

            const layout = { 
                title: `ç­åˆ¥ ${cls} åˆ†æ`, height: Math.max(600, students.length*30), margin: {l:150,t:50,b:50}, shapes: shapes, annotations: annotations, showlegend: false,
                xaxis: { title: 'åˆ†æ•¸', range: [0, 110] }, yaxis: { automargin: true }
            };
            if(viewMode === 'all') {
                layout.grid = { rows: 1, columns: 3, pattern: 'independent' };
                layout.xaxis = { domain: layouts.chi.d, range:[0,110] }; layout.xaxis2 = { domain: layouts.eng.d, range:[0,110] }; layout.xaxis3 = { domain: layouts.math.d, range:[0,110] };
            } else { mainLayout.xaxis = { domain: [0, 1], title: layouts[viewMode].title, range: [0, 115] }; }
            Plotly.newPlot('chart-main', traces, layout);
        };

        function generateAIReport() {
            globalAiPromptText = "åˆ†æå ±å‘Š...";
            document.getElementById('chatWindow').innerHTML = '<div class="chat-bubble chat-ai">æ•¸æ“šåˆ†æå·²æ›´æ–°ã€‚</div>';
        }
        window.copyAiPrompt = function() { navigator.clipboard.writeText(globalAiPromptText); alert("å·²è¤‡è£½"); };
        window.downloadChart = function(id, name) { Plotly.downloadImage(id, {format:'png', width:1200, height:800, filename:name}); };
        window.downloadDiv = function(id, name) { html2canvas(document.getElementById(id)).then(c => { const a=document.createElement('a'); a.download=name+'.png'; a.href=c.toDataURL(); a.click(); }); };
        window.editSettings = function() { window.location.reload(); }; 
        window.resetToUploadMode = function() { window.location.reload(); };
    </script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f4f9; margin: 0; padding: 10px; color: #333; }
        .admin-only { display: none; }
        #login-overlay { 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0; 
            width: 100%; height: 100%; 
            background: #2c3e50; 
            z-index: 9999; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
        }
        .login-box {
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            width: 320px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .login-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            box-sizing: border-box; 
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .nav-bar { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .nav-btn { flex: 1; padding: 10px; border: none; background: #e0e0e0; cursor: pointer; border-radius: 8px 8px 0 0; font-weight: bold; }
        .nav-btn.active { background: #007bff; color: white; }
        .control-panel { background: #e9ecef; padding: 15px; border-radius: 8px; display: grid; gap: 10px; }
        .cloud-actions { display: none; gap: 10px; padding: 15px; background: #f1f8ff; margin-top: 10px; border-radius: 8px; justify-content: center; }
        
        .grouping-bar { 
            display: none; 
            background: #fff3cd; border: 1px solid #ffeeba; color: #856404; 
            padding: 10px 20px; margin-bottom: 20px; border-radius: 8px; 
            align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .grouping-bar select { padding: 8px; border-radius: 4px; border: 1px solid #d6d8db; font-weight: bold; min-width: 200px; }

        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-box { border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: white; }
        .chart-box.full { grid-column: 1 / -1; }
        .risk-table { width: 100%; border-collapse: collapse; text-align: center; }
        .risk-table th { background: #c53030; color: white; padding: 5px; }
        .risk-table td { border: 1px solid #ddd; padding: 5px; }
        .detail-control { background: #e3f2fd; padding: 15px; margin: 20px 0; border-radius: 5px; display: flex; gap: 20px; align-items: center; justify-content: center; }
        button { padding: 10px; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; }
        .primary-btn { background: #007bff; color: white; width: 100%; }
        .download-btn { background: #6c757d; color: white; font-size: 0.8em; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2 style="color:#007bff; margin-bottom:10px;">å…¨ç´šå­¸è¡“æˆç¸¾åˆ†æç³»çµ±</h2>
        <h3>ğŸ” ç™»å…¥</h3>
        <input type="email" id="loginEmail" placeholder="Email" class="login-input">
        <input type="password" id="loginPass" placeholder="Password" class="login-input">
        <button onclick="window.performLogin()" class="primary-btn">Login</button>
        <div id="loginMsg" style="color:red; margin-top:10px;"></div>
    </div>
</div>

<div id="main-app" style="display:none;">
    <div class="container">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1>ğŸ“Š å…¨ç´šå­¸è¡“æˆç¸¾åˆ†æç³»çµ± <span id="currentGradeBadge" style="background:#007bff; color:white; padding:2px 8px; border-radius:10px; font-size:0.6em;">P1</span></h1>
            <div id="user-email-display"></div>
            <button onclick="window.performLogout()" style="background:#d9534f; color:white;">ç™»å‡º</button>
        </div>
        
        <div class="nav-bar">
            <button class="nav-btn active" onclick="window.switchGradeUI('1')">P1</button>
            <button class="nav-btn" onclick="window.switchGradeUI('2')">P2</button>
            <button class="nav-btn" onclick="window.switchGradeUI('3')">P3</button>
            <button class="nav-btn" onclick="window.switchGradeUI('4')">P4</button>
            <button class="nav-btn" onclick="window.switchGradeUI('5')">P5</button>
            <button class="nav-btn" onclick="window.switchGradeUI('6')">P6</button>
        </div>

        <div id="cloudStatus" style="text-align:center; padding:10px; background:#fff3e0; margin-bottom:10px;">æº–å‚™å°±ç·’</div>

        <div id="reportHeader" style="text-align:center; padding:15px; background:#e3f2fd; display:none; margin-bottom:15px;"></div>

        <!-- 1. å‹•æ…‹åˆ†ç­åˆ— (Grouping Bar) -->
        <div id="grouping-bar" class="grouping-bar">
            <span>ğŸ“¦ <b>åˆ†ç­æ¨¡å¼åˆ‡æ› (Grouping By)ï¼š</b></span>
            <select id="groupingSelect" onchange="window.handleGroupingChange()"></select>
            <span style="font-size:0.9em; color:#666;">(åˆ‡æ›å¾Œç³»çµ±å°‡å³æ™‚é‡æ–°è¨ˆç®—çµ±è¨ˆæ•¸æ“š)</span>
        </div>

        <div class="control-panel" id="mainControlPanel">
            <label>ç·¨ç¢¼: <select id="encodingSelect"><option value="Big5">Big5 (Excel)</option><option value="UTF-8">UTF-8</option></select></label>
            <div>1. å­¸ç”Ÿè³‡æ–™: <input type="file" onchange="handleFileSelect(this,'info')"> <span id="msg-info"></span></div>
            <div>2. èˆŠæˆç¸¾: <input type="file" onchange="handleFileSelect(this,'old')"> <span id="msg-old"></span></div>
            <div>3. æ–°æˆç¸¾: <input type="file" onchange="handleFileSelect(this,'new')"> <span id="msg-new"></span></div>
            
            <div id="stuSettings" style="display:none; background:white; padding:10px;">
                <h4>1. å­¸ç”Ÿè³‡æ–™è¨­å®š</h4>
                ç­åˆ¥(é è¨­): <select id="colClass"></select> 
                å§“å: <select id="colName"></select> 
                è¨»å†Šè™Ÿ: <select id="colRegInfo"></select>
            </div>
            <div id="oldScoreSettings" style="display:none; background:white; padding:10px;">
                <h4>2. èˆŠæˆç¸¾æ¬„ä½</h4>
                è¨»å†Šè™Ÿ: <select id="colOldReg"></select> ä¸­: <select id="colOldChi"></select> è‹±: <select id="colOldEng"></select> æ•¸: <select id="colOldMath"></select>
            </div>
            <div id="newScoreSettings" style="display:none; background:white; padding:10px;">
                <h4>3. æ–°æˆç¸¾æ¬„ä½</h4>
                è¨»å†Šè™Ÿ: <select id="colNewReg"></select> ç­è™Ÿ: <select id="colNewClassNum"></select> ä¸­: <select id="colNewChi"></select> è‹±: <select id="colNewEng"></select> æ•¸: <select id="colNewMath"></select>
            </div>

            <button class="primary-btn" onclick="window.processData()">ğŸš€ é–‹å§‹åˆ†æ</button>
        </div>

        <div id="cloudActions" class="cloud-actions">
            <button onclick="window.resetToUploadMode()" style="background:#6c757d; color:white;">ğŸ—‘ï¸ é‡æ–°ä¸Šå‚³</button>
            <button id="btnSaveCloud" onclick="window.saveToCloud_Impl()" style="background:#17a2b8; color:white;">â˜ï¸ å„²å­˜è‡³é›²ç«¯</button>
        </div>

        <div id="stats-banner" style="display:none;"></div>
        
        <div id="macro-section" style="display:none;">
            <h3>å®è§€åˆ†æ</h3>
            <select id="macroSubjectSelect" onchange="updateMacroCharts()"><option value="chi">ä¸­æ–‡</option><option value="eng">è‹±æ–‡</option><option value="math">æ•¸å­¸</option></select>
            <span id="macro-score-diff" style="font-weight:bold; margin-left:10px;"></span>
            <div class="dashboard-grid">
                <div class="chart-box"><div id="chart-bar-stats"></div><button class="download-btn" onclick="downloadChart('chart-bar-stats','Bar')">ä¸‹è¼‰</button></div>
                <div class="chart-box"><div id="chart-line-avg"></div><button class="download-btn" onclick="downloadChart('chart-line-avg','Line')">ä¸‹è¼‰</button></div>
                <div class="chart-box full"><div id="chart-dist"></div><button class="download-btn" onclick="downloadChart('chart-dist','Dist')">ä¸‹è¼‰</button></div>
            </div>
        </div>

        <div id="risk-section" style="display:none; margin-top:20px;">
            <div style="background:#c53030; color:white; padding:10px;">âš ï¸ é‡é»é—œæ³¨ (å…¨ç§‘ç›¸å°é€€æ­¥)</div>
            <table class="risk-table" id="riskTable"><tbody></tbody></table>
        </div>

        <div id="ranking-section" style="display:none; margin-top:20px;">
            <h3>æ’è¡Œæ¦œ</h3>
            <select id="rankSubjectSelect" onchange="updateRankings()"><option value="chi">ä¸­æ–‡</option><option value="eng">è‹±æ–‡</option><option value="math">æ•¸å­¸</option></select>
            <div class="dashboard-grid">
                <div class="chart-box"><h4>ğŸš€ é€²æ­¥</h4><table class="risk-table"><tbody id="rankBodyImpContent"></tbody></table></div>
                <div class="chart-box"><h4>ğŸ“‰ é€€æ­¥</h4><table class="risk-table"><tbody id="rankBodyRegContent"></tbody></table></div>
            </div>
        </div>

        <div id="detail-section" style="display:none;">
            <div class="detail-control">
                ç­åˆ¥: <select id="classSelect" onchange="drawDetailChart()"></select>
                æ¨¡å¼: <select id="viewMode" onchange="updateDetailControls()"><option value="all">ä¸‰ç§‘ (ç¶“å…¸)</option><option value="chi">ä¸­æ–‡</option><option value="eng">è‹±æ–‡</option><option value="math">æ•¸å­¸</option></select>
                <span id="sortControl" style="display:none;">
                    æ’åº: <select id="sortMode" onchange="drawDetailChart()">
                        <option value="classNum">ä¾ç­è™Ÿ</option>
                        <option value="avg">ä¾å¹³å‡åˆ†(æ–°)</option> <!-- 2. å¹³å‡åˆ†æ’åº -->
                        <option value="scoreNew">ä¾æ–°åˆ†æ•¸(é«˜è‡³ä½)</option>
                        <option value="scoreOld">ä¾èˆŠåˆ†æ•¸(é«˜è‡³ä½)</option>
                        <option value="diff">ä¾é€²æ­¥å¹…åº¦</option>
                    </select>
                </span>
                <button class="download-btn" onclick="downloadChart('chart-main','Detail')">ä¸‹è¼‰åœ–è¡¨</button>
            </div>
            <div id="chart-main"></div>
        </div>

        <div id="ai-section" style="display:none; margin-top:20px;">
            <h3>AI é¡§å•</h3>
            <div id="chatWindow" style="background:#f5f7fa; padding:10px; height:100px; overflow-y:auto; border:1px solid #ddd;"></div>
            <button onclick="window.copyAiPrompt()" style="margin-top:5px; background:#28a745; color:white; width:100%;">è¤‡è£½æŒ‡ä»¤</button>
        </div>
    </div>
</div>

</body>
</html>
