<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨ç´šå­¸è¡“æˆç¸¾åˆ†æç³»çµ± (V28.5 å®‰å…¨ç®¡ç†ç‰ˆ)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-statistics/7.7.0/simple-statistics.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // ============================================================
        // âš ï¸âš ï¸âš ï¸ ã€è¨­å®šå€ã€‘ âš ï¸âš ï¸âš ï¸
        // ============================================================
        
        // 1. è«‹å¡«å…¥ Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyBYtaDjYgO0F2qlvWgmeMavE0SUBTzFONU",
            authDomain: "school-grade-analysis-ed4e1.firebaseapp.com",
            projectId: "school-grade-analysis-ed4e1",
            storageBucket: "school-grade-analysis-ed4e1.firebasestorage.app",
            messagingSenderId: "119965796660",
            appId: "1:119965796660:web:55e160b8eab960ab157d61",
            measurementId: "G-S36T3HV2PT"
        };

        // 2. å‰ç«¯ç®¡ç†å“¡åå–® (æ§åˆ¶æŒ‰éˆ•é¡¯ç¤º)
        // âš ï¸ è«‹ç¢ºä¿é€™è£¡çš„ Email èˆ‡ Firebase Console > Rules ä¸­çš„åå–®ä¸€è‡´
        const ADMIN_EMAILS = [
            "lwysamsp@bcklas.edu.hk"
        ];
        // ============================================================

        // å…¨åŸŸè®Šæ•¸
        let db = null;
        let auth = null;
        let currentUserIsAdmin = false;
        let globalAiPromptText = ""; 
        
        // æ•¸æ“šè®Šæ•¸
        var rawInfo = [], rawOld = [], rawNew = [];
        var processedData = {};
        var classStats = {}; 
        var globalMeans = {}; 
        var globalSDs = {};
        var processedDataExport = null;
        var currentGrade = '1';

        // åˆå§‹åŒ– Firebase
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof firebase === 'undefined') {
                alert("âŒ ç„¡æ³•è¼‰å…¥ Firebaseï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚");
                return;
            }

            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                auth = firebase.auth();
                
                // ç›£è½ç™»å…¥ç‹€æ…‹
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        console.log("ç›®å‰ç™»å…¥å¸³è™Ÿ:", user.email);
                        // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡ (ä¸å€åˆ†å¤§å°å¯«)
                        currentUserIsAdmin = ADMIN_EMAILS.some(email => email.toLowerCase() === user.email.toLowerCase());

                        document.getElementById('login-overlay').style.display = 'none';
                        document.getElementById('main-app').style.display = 'block';
                        
                        const roleText = currentUserIsAdmin ? "ç®¡ç†å“¡ (å¯ç·¨è¼¯)" : "è€å¸« (å”¯è®€)";
                        const roleColor = currentUserIsAdmin ? "#d32f2f" : "#2e7d32";
                        document.getElementById('user-email-display').innerHTML = `
                            <span style="color:${roleColor}; font-weight:bold; font-size:0.9em; margin-right:5px;">[${roleText}]</span> 
                            ${user.email}`;
                        
                        // æ ¹æ“šæ¬Šé™é¡¯ç¤º/éš±è—æŒ‰éˆ•
                        const adminElements = document.querySelectorAll('.admin-only');
                        adminElements.forEach(el => {
                            el.style.display = currentUserIsAdmin ? 'inline-flex' : 'none';
                        });

                        const statusDiv = document.getElementById('cloudStatus');
                        if(currentUserIsAdmin) {
                            statusDiv.innerText = "âœ… ç®¡ç†å“¡æ¨¡å¼ï¼šé›²ç«¯é€£ç·šæˆåŠŸ";
                            statusDiv.style.backgroundColor = "#e8f5e9";
                        } else {
                            statusDiv.innerText = "ğŸ‘ï¸ æª¢è¦–æ¨¡å¼ï¼šé›²ç«¯é€£ç·šæˆåŠŸ";
                            statusDiv.style.backgroundColor = "#e3f2fd";
                            statusDiv.style.color = "#0d47a1";
                        }

                        window.loadFromCloud_Impl('1'); 
                    } else {
                        document.getElementById('login-overlay').style.display = 'flex';
                        document.getElementById('main-app').style.display = 'none';
                    }
                });

            } catch (e) {
                console.error("Firebase Init Error:", e);
                alert("åˆå§‹åŒ–å¤±æ•—: " + e.message);
            }
        });

        // --- ç™»å…¥åŠŸèƒ½ ---
        window.performLogin = function() {
            const btn = document.getElementById('btnLoginBtn');
            const msg = document.getElementById('loginMsg');
            const emailField = document.getElementById('loginEmail');
            const passField = document.getElementById('loginPass');

            if (!auth) { alert("ç³»çµ±éŒ¯èª¤ï¼šFirebase æœªé€£æ¥"); return; }
            if(!emailField.value || !passField.value) { msg.innerText = "è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼"; return; }

            btn.disabled = true; btn.innerText = "é©—è­‰ä¸­..."; msg.innerText = "";

            auth.signInWithEmailAndPassword(emailField.value, passField.value)
                .catch((error) => {
                    btn.disabled = false; btn.innerText = "ç™»å…¥ç³»çµ±";
                    let t = "ç™»å…¥å¤±æ•—";
                    if(error.code === 'auth/wrong-password') t = "å¯†ç¢¼éŒ¯èª¤";
                    if(error.code === 'auth/user-not-found') t = "æ‰¾ä¸åˆ°æ­¤å¸³è™Ÿ";
                    msg.innerText = `âŒ ${t}`;
                });
        };

        window.performLogout = function() {
            if(auth) auth.signOut().then(() => location.reload());
            else location.reload();
        };

        // --- é›²ç«¯åŠŸèƒ½ (å®‰å…¨æ ¸å¿ƒ) ---
        window.saveToCloud_Impl = async function() {
            // å‰ç«¯ç¬¬ä¸€å±¤é˜»æ“‹
            if (!currentUserIsAdmin) { 
                alert("âŒ æ¬Šé™ä¸è¶³ï¼šæ‚¨çš„å¸³è™Ÿåƒ…ä¾›æª¢è¦–ï¼Œç„¡æ³•ä¿®æ”¹è³‡æ–™åº«ã€‚"); 
                return; 
            }
            if (!window.processedDataExport) { alert("âŒ æ²’æœ‰æ•¸æ“šå¯å„²å­˜ï¼"); return; }
            
            const grade = window.currentGrade;
            const btn = document.getElementById('btnSaveCloud');
            const originalText = btn.innerText;
            btn.innerText = "â˜ï¸ é©—è­‰æ¬Šé™ä¸¦å„²å­˜...";
            btn.disabled = true;

            try {
                const jsonString = JSON.stringify(window.processedDataExport, (key, val) => 
                    (typeof val === 'number' && isNaN(val)) ? "###NaN###" : val
                );
                
                // å˜—è©¦å¯«å…¥ (å¦‚æœ Firebase Rules é˜»æ“‹ï¼Œé€™è£¡æœƒå ±éŒ¯)
                await db.collection("grades").doc(grade).set({
                    data: JSON.parse(jsonString),
                    updatedAt: new Date().toLocaleString(),
                    editor: auth.currentUser.email,
                    editorUid: auth.currentUser.uid
                });
                
                alert(`âœ… P${grade} æ•¸æ“šå·²æˆåŠŸä¸Šå‚³ï¼`);
                document.getElementById('cloudStatus').innerText = `âœ… P${grade} æ•¸æ“šå·²åŒæ­¥ (æ›´æ–°æ–¼: ${new Date().toLocaleString()})`;
            } catch (e) {
                console.error("Write Error:", e);
                let specificMsg = e.message;
                // æ•æ‰æ¬Šé™éŒ¯èª¤
                if (e.code === 'permission-denied') {
                    specificMsg = `â›” æ¬Šé™ä¸è¶³ (Permission Denied)\n\nå³ä½¿æ‚¨çœ‹åˆ°äº†æŒ‰éˆ•ï¼Œé›²ç«¯å®‰å…¨è¦å‰‡ä»æ‹’çµ•äº†æ‚¨çš„å¯«å…¥è«‹æ±‚ã€‚\nè«‹ç¢ºèªæ‚¨çš„ Email æ˜¯å¦å·²åŠ å…¥ Firebase Console çš„ Rules ç™½åå–®ä¸­ã€‚`;
                }
                alert("âŒ å„²å­˜å¤±æ•—ï¼\n" + specificMsg);
            }
            btn.innerText = originalText;
            btn.disabled = false;
        };

        window.loadFromCloud_Impl = async function(grade) {
            const statusDiv = document.getElementById('cloudStatus');
            statusDiv.innerText = `â³ è®€å– P${grade} ä¸­...`;
            try {
                const docRef = db.collection("grades").doc(grade);
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    const savedData = docSnap.data().data;
                    const cleanData = JSON.parse(JSON.stringify(savedData), (k, v) => v === "###NaN###" ? NaN : v);
                    window.processedData = cleanData.processedData;
                    window.classStats = cleanData.classStats;
                    window.globalMeans = cleanData.globalMeans;
                    window.globalSDs = cleanData.globalSDs;
                    window.processedDataExport = cleanData;
                    window.restoreDashboardUI();
                    
                    let updateTime = docSnap.data().updatedAt || "æœªçŸ¥æ™‚é–“";
                    let editor = docSnap.data().editor || "æœªçŸ¥";
                    let roleMsg = currentUserIsAdmin ? " (ç®¡ç†å“¡)" : " (å”¯è®€)";
                    statusDiv.innerText = `âœ… P${grade} å·²è¼‰å…¥${roleMsg} | æœ€å¾Œæ›´æ–°: ${updateTime} by ${editor}`;
                } else {
                    statusDiv.innerText = `â„¹ï¸ P${grade} å°šç„¡é›²ç«¯æ•¸æ“šã€‚`;
                    if (currentUserIsAdmin) window.resetToUploadMode();
                    else alert("æ­¤å¹´ç´šå°šç„¡æ•¸æ“šï¼Œè«‹ç­‰å¾…ç®¡ç†å“¡ä¸Šå‚³ã€‚");
                }
            } catch (e) {
                console.error(e);
                statusDiv.innerText = `âŒ è®€å–éŒ¯èª¤: ${e.message}`;
            }
        };

        window.switchGradeUI = function(grade) {
            currentGrade = grade;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.nav-btn')[grade-1].classList.add('active');
            document.getElementById('currentGradeBadge').innerText = `P${grade}`;
            document.getElementById('btnSaveCloud').innerText = `â˜ï¸ å„²å­˜ P${grade} è‡³é›²ç«¯`;
            if (auth && auth.currentUser) window.loadFromCloud_Impl(grade);
        };

        // --- æ ¸å¿ƒæ¥­å‹™é‚è¼¯ (ä¿æŒä¸è®Š) ---
        window.editSettings = function() {
            document.getElementById('mainControlPanel').style.display = 'grid';
            document.getElementById('reportHeader').style.display = 'none';
            document.getElementById('cloudActions').style.display = 'none';
            ['stats-banner', 'macro-section', 'risk-section', 'ranking-section', 'detail-section', 'ai-section'].forEach(id => document.getElementById(id).style.display = 'none');
            ['stuSettings', 'oldScoreSettings', 'newScoreSettings'].forEach(id => document.getElementById(id).style.display = 'block');
            document.getElementById('mainControlPanel').scrollIntoView({ behavior: 'smooth' });
        };

        window.resetToUploadMode = function() { window.editSettings(); window.resetData(); };
        window.resetData = function() {
            rawInfo = []; rawOld = []; rawNew = [];
            ['stuSettings', 'oldScoreSettings', 'newScoreSettings'].forEach(id => document.getElementById(id).style.display = 'none');
            ['msg-info', 'msg-old', 'msg-new'].forEach(id => document.getElementById(id).innerText = '');
        };

        window.handleFileSelect = function(input, type) { if (input.files && input.files[0]) parseCSV(input.files[0], type); };

        function parseCSV(file, type) {
            const enc = document.getElementById('encodingSelect').value;
            const status = document.getElementById('statusMsg');
            status.innerText = "è®€å–ä¸­...";

            Papa.parse(file, {
                header: false, skipEmptyLines: true, encoding: enc,
                complete: (res) => {
                    if(!res.data || res.data.length < 1) { status.innerText = "éŒ¯èª¤ï¼šæª”æ¡ˆç‚ºç©º"; return; }
                    document.getElementById('msg-' + type).innerText = `âœ… å·²è®€å– ${res.data.length} è¡Œ`;
                    status.innerText = "";
                    
                    const h = res.data[0];
                    if(type === 'info') { 
                        rawInfo = res.data; 
                        initDropdown('stuSettings', h, [
                            {id:'colClass', keys:['ç­','class']},
                            {id:'colName', keys:['ä¸­æ–‡å§“å', 'chinese name', 'ä¸­æ–‡', 'chi name', 'c.name', 'å§“å', 'name']},
                            {id:'colRegInfo', keys:['è¨»å†Š','reg']}
                        ]); 
                    }
                    if(type === 'old') { 
                        rawOld = res.data; 
                        initDropdown('oldScoreSettings', h, [{id:'colOldReg',keys:['è¨»å†Š','reg']},{id:'colOldChi',keys:['ä¸­æ–‡','chi']},{id:'colOldEng',keys:['è‹±æ–‡','eng']},{id:'colOldMath',keys:['æ•¸å­¸','math']}]); 
                    }
                    if(type === 'new') { 
                        rawNew = res.data; 
                        initDropdown('newScoreSettings', h, [{id:'colNewReg',keys:['è¨»å†Š','reg']},{id:'colNewClassNum',keys:['ç­è™Ÿ','class no','no.','number']},{id:'colNewChi',keys:['ä¸­æ–‡','chi']},{id:'colNewEng',keys:['è‹±æ–‡','eng']},{id:'colNewMath',keys:['æ•¸å­¸','math']}]); 
                    }
                },
                error: (err) => { status.innerText = "è®€å–å¤±æ•—: " + err.message; }
            });
        }

        function initDropdown(panelId, headers, configs) {
            document.getElementById(panelId).style.display = 'block'; 
            configs.forEach(cfg => {
                const sel = document.getElementById(cfg.id);
                if(!sel) return;
                sel.innerHTML = '';
                let foundIdx = -1;
                cfg.keys.some(key => {
                    const idx = headers.findIndex(h => String(h).toLowerCase().includes(key));
                    if (idx !== -1) { foundIdx = idx; return true; }
                    return false;
                });
                headers.forEach((h, i) => { sel.add(new Option(`[${i}] ${h}`, i)); });
                if(foundIdx !== -1) { 
                    sel.value = foundIdx; 
                    const label = sel.previousElementSibling; 
                    if(label && !label.innerHTML.includes('è‡ªå‹•')) label.innerHTML += ' <span class="auto-tag">âœ” è‡ªå‹•åµæ¸¬</span>'; 
                } else { sel.value = 0; }
            });
        }

        window.processData = function() {
            const status = document.getElementById('statusMsg');
            if (!rawInfo.length || !rawOld.length || !rawNew.length) { alert("è«‹å…ˆä¸Šå‚³æ‰€æœ‰æª”æ¡ˆ"); return; }

            const getVal = (id) => parseInt(document.getElementById(id).value);
            const idxClass = getVal('colClass'), idxName = getVal('colName'), idxRegInfo = getVal('colRegInfo');
            const idxOldReg = getVal('colOldReg'), idxOldChi = getVal('colOldChi'), idxOldEng = getVal('colOldEng'), idxOldMath = getVal('colOldMath');
            const idxNewReg = getVal('colNewReg'), idxNewChi = getVal('colNewChi'), idxNewEng = getVal('colNewEng'), idxNewMath = getVal('colNewMath');
            const idxNewClassNum = getVal('colNewClassNum');

            const cleanReg = (val) => val ? String(val).replace(/[\s\uFEFF\xA0]/g, '').toUpperCase() : "";
            const validRegNos = new Set();
            rawInfo.slice(1).forEach(r => { const reg = cleanReg(r[idxRegInfo]); if(reg) validRegNos.add(reg); });

            if(validRegNos.size === 0) { status.innerText = "è­¦å‘Šï¼šæ‰¾ä¸åˆ°æœ‰æ•ˆçš„è¨»å†Šç·¨è™Ÿã€‚"; return; }

            function parseScore(val) {
                if (val === null || val === undefined) return NaN;
                const clean = String(val).trim();
                if (clean === '' || ['abs', 'absent', 'ops', '--'].includes(clean.toLowerCase())) return NaN;
                const num = parseFloat(clean);
                return isNaN(num) ? NaN : num;
            }

            function getScoresWithClassNum(data, idxReg, idxChi, idxEng, idxMath, idxClassNum) {
                const map = {};
                data.slice(1).forEach(r => {
                    const reg = cleanReg(r[idxReg]);
                    if(reg) {
                        const cNum = r[idxClassNum] ? parseInt(String(r[idxClassNum]).replace(/\D/g,'')) : 0;
                        map[reg] = { chi: parseScore(r[idxChi]), eng: parseScore(r[idxEng]), math: parseScore(r[idxMath]), classNum: isNaN(cNum) ? 0 : cNum };
                    }
                });
                return map;
            }

            function getScores(data, idxReg, idxChi, idxEng, idxMath) {
                const map = {};
                data.slice(1).forEach(r => {
                    const reg = cleanReg(r[idxReg]);
                    if(reg) map[reg] = { chi: parseScore(r[idxChi]), eng: parseScore(r[idxEng]), math: parseScore(r[idxMath]) };
                });
                return map;
            }

            const mapOld = getScores(rawOld, idxOldReg, idxOldChi, idxOldEng, idxOldMath);
            const mapNew = getScoresWithClassNum(rawNew, idxNewReg, idxNewChi, idxNewEng, idxNewMath, idxNewClassNum);

            let sums = {chi:{o:0,n:0,c:0,arr:[]}, eng:{o:0,n:0,c:0,arr:[]}, math:{o:0,n:0,c:0,arr:[]}};

            [mapOld, mapNew].forEach((map, isNew) => {
                Object.keys(map).forEach(reg => {
                    if (validRegNos.has(reg)) {
                        ['chi','eng','math'].forEach(sub => {
                            const val = map[reg][sub];
                            if(!isNaN(val)) {
                                if(isNew) { sums[sub].n += val; sums[sub].c++; sums[sub].arr.push(val); }
                                else { sums[sub].o += val; }
                            }
                        });
                    }
                });
            });

            globalMeans = {}; globalSDs = {};
            ['chi','eng','math'].forEach(sub => {
                globalMeans[sub] = { old: sums[sub].c ? (sums[sub].o / sums[sub].c) : 0, new: sums[sub].c ? (sums[sub].n / sums[sub].c) : 0 };
                globalSDs[sub] = sums[sub].arr.length > 1 ? ss.standardDeviation(sums[sub].arr) : 15;
            });

            processedData = {};
            const classesFound = new Set();

            rawInfo.slice(1).forEach(r => {
                const reg = cleanReg(r[idxRegInfo]);
                if(reg && validRegNos.has(reg)) {
                    const cls = r[idxClass] ? r[idxClass].trim() : "Unknown";
                    const name = r[idxName] ? r[idxName].trim() : "Unknown";
                    const o = mapOld[reg] || { chi: NaN, eng: NaN, math: NaN };
                    const n = mapNew[reg] || { chi: NaN, eng: NaN, math: NaN, classNum: 0 };
                    
                    if(['chi','eng','math'].some(sub => !isNaN(o[sub]) || !isNaN(n[sub]))) {
                        const student = { name: name, cls: cls, classNum: n.classNum || 0 };
                        ['chi','eng','math'].forEach(sub => {
                            const oldScore = o[sub];
                            const newScore = n[sub];
                            let relativeDiff = NaN;
                            if(!isNaN(oldScore) && !isNaN(newScore)) {
                                relativeDiff = (newScore - globalMeans[sub].new) - (oldScore - globalMeans[sub].old);
                            }
                            student[sub] = { old: oldScore, new: newScore, diff: relativeDiff };
                        });
                        if(!processedData[cls]) processedData[cls] = [];
                        processedData[cls].push(student);
                        classesFound.add(cls);
                    }
                }
            });
            
            if (Object.keys(processedData).length === 0) { alert("âš ï¸ åˆ†æå®Œæˆï¼Œä½†æ²’æœ‰ç”¢ç”Ÿä»»ä½•æ•¸æ“šï¼"); return; }

            classStats = {};
            const sortedClasses = Array.from(classesFound).sort();
            sortedClasses.forEach(cls => {
                classStats[cls] = {};
                ['chi','eng','math'].forEach(sub => {
                    let imp = 0, reg = 0, sumOld = 0, cntOld = 0, sumNew = 0, cntNew = 0;
                    let scoresNew = [];
                    processedData[cls].forEach(s => {
                        if(!isNaN(s[sub].old)) { sumOld += s[sub].old; cntOld++; }
                        if(!isNaN(s[sub].new)) { sumNew += s[sub].new; cntNew++; scoresNew.push(s[sub].new); }
                        if(!isNaN(s[sub].diff)) { if(s[sub].diff >= 0) imp++; else reg++; }
                    });
                    let meanNew = cntNew ? sumNew/cntNew : 0;
                    let meanOld = cntOld ? sumOld/cntOld : 0;
                    let sd = scoresNew.length > 1 ? ss.standardDeviation(scoresNew) : 0;
                    classStats[cls][sub] = { improved: imp, regressed: reg, avgOld: meanOld, avgNew: meanNew, sd: sd, count: cntNew };
                });
            });

            processedDataExport = { processedData, classStats, globalMeans, globalSDs };
            window.restoreDashboardUI();
        };

        window.restoreDashboardUI = function() {
            const sortedClasses = Object.keys(processedData).sort();
            const select = document.getElementById('classSelect');
            select.innerHTML = '<option value="">-- è«‹é¸æ“‡ç­åˆ¥ --</option>';
            sortedClasses.forEach(c => select.add(new Option(c, c)));

            document.getElementById('mainControlPanel').style.display = 'none';
            
            if (currentUserIsAdmin) {
                document.getElementById('cloudActions').style.display = 'flex';
                document.getElementById('reportHeader').innerHTML = "âœ… <b>ç®¡ç†å“¡æ¨¡å¼</b>ï¼šå¯ç·¨è¼¯æ•¸æ“š";
                document.getElementById('reportHeader').style.background = "#d4edda";
                document.getElementById('reportHeader').style.color = "#155724";
            } else {
                document.getElementById('cloudActions').style.display = 'none';
                document.getElementById('reportHeader').innerHTML = "ğŸ‘ï¸ <b>æª¢è¦–æ¨¡å¼</b>ï¼šåƒ…ä¾›æŸ¥é–± (ç„¡æ³•ä¿®æ”¹)";
                document.getElementById('reportHeader').style.background = "#e3f2fd";
                document.getElementById('reportHeader').style.color = "#0c5460";
            }
            document.getElementById('reportHeader').style.display = 'block';
            
            ['stats-banner', 'macro-section', 'risk-section', 'ranking-section', 'detail-section', 'ai-section'].forEach(id => {
                document.getElementById(id).style.display = 'block';
            });
            
            setTimeout(() => { window.renderAllCharts(); }, 100);
        };

        window.renderAllCharts = function() {
            updateMacroCharts();
            const riskList = [];
            Object.values(processedData).flat().forEach(s => {
                let drop=0, valid=0;
                ['chi','eng','math'].forEach(sub => { if(!isNaN(s[sub].diff)) { valid++; if(s[sub].diff < -0.5) drop++; } });
                if(valid >= 2 && drop === valid) riskList.push(s);
            });
            updateRiskTable(riskList);
            updateRankings();
            window.updateDetailControls();
            generateAIReport(classStats, globalMeans);
        };

        window.updateMacroCharts = function() {
            const subject = document.getElementById('macroSubjectSelect').value;
            const classes = Object.keys(classStats).sort();
            
            const traceImp = { x: classes, y: classes.map(c => classStats[c][subject].improved), name: 'ç›¸å°é€²æ­¥', type: 'bar', marker: { color: '#2ca02c' } };
            const traceReg = { x: classes, y: classes.map(c => classStats[c][subject].regressed), name: 'ç›¸å°é€€æ­¥', type: 'bar', marker: { color: '#d62728' } };
            Plotly.newPlot('chart-bar-stats', [traceImp, traceReg], { barmode: 'group', margin: {t:30,l:40,r:20,b:40}, showlegend: true, legend: {x:0, y:1.1, orientation:'h'} });

            const tracesLine = [];
            classes.forEach(cls => {
                const oldVal = classStats[cls][subject].avgOld;
                const newVal = classStats[cls][subject].avgNew;
                if(!isNaN(oldVal) && !isNaN(newVal)) {
                    tracesLine.push({ x: ['èˆŠå¹³å‡', 'æ–°å¹³å‡'], y: [oldVal, newVal], mode: 'lines+markers', name: cls, line: { width: 3 }, marker: { size: 6 } });
                }
            });
            const gOld = globalMeans[subject].old;
            const gNew = globalMeans[subject].new;
            if(!isNaN(gOld) && !isNaN(gNew)) {
                tracesLine.push({ x: ['èˆŠå¹³å‡', 'æ–°å¹³å‡'], y: [gOld, gNew], mode: 'lines+markers', name: 'å…¨ç´šå¹³å‡', line: { color: 'grey', dash: 'dot', width: 4 }, marker: { size: 8, symbol: 'diamond', color: 'grey' } });
            }
            Plotly.newPlot('chart-line-avg', tracesLine, { margin: {t:30,l:40,r:50,b:40}, showlegend: true, legend: {x: 1.05, y: 1}, xaxis: { type: 'category' } });

            const histTraces = [];
            const colorPalette = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'];
            const allScores = []; 
            Object.values(processedData).flat().forEach(s => { if(!isNaN(s[subject].new)) allScores.push(s[subject].new); });

            classes.forEach((cls, index) => {
                const clsScores = [];
                if(processedData[cls]) processedData[cls].forEach(s => { if(!isNaN(s[subject].new)) clsScores.push(s[subject].new); });
                histTraces.push({ x: clsScores, type: 'histogram', name: cls, xbins: { start:0, end:120, size: 4 }, marker: { color: colorPalette[index % colorPalette.length] }, opacity: 0.8 });
            });

            const mean = globalMeans[subject].new;
            const sd = globalSDs[subject];
            const xValues = [], yValues = [];
            for (let x = 0; x <= 120; x += 1) {
                xValues.push(x);
                yValues.push((Math.exp(-0.5 * Math.pow((x - mean) / sd, 2)) / (sd * Math.sqrt(2 * Math.PI))) * allScores.length * 4);
            }
            const traceCurve = { x: xValues, y: yValues, type: 'scatter', mode: 'lines', line: { color: 'red', width: 3, dash:'solid' }, name: 'å¸¸æ…‹åˆ†ä½ˆ (ç†è«–)' };

            Plotly.newPlot('chart-dist', [...histTraces, traceCurve], { margin: {t:30,l:40,r:20,b:40}, xaxis: {title:'åˆ†æ•¸', range:[0, 110]}, yaxis: {title:'äººæ•¸'}, barmode: 'stack', bargap: 0.05, showlegend: true, legend: {x:0.8, y:1} });
            
            const diffVal = (globalMeans[subject].new - globalMeans[subject].old).toFixed(1);
            const diffElem = document.getElementById('macro-score-diff');
            diffElem.innerText = `å…¨ç´šå¹³å‡è®Šå‹•: ${diffVal > 0 ? '+' : ''}${diffVal}`;
            diffElem.style.color = diffVal >= 0 ? 'green' : 'red';
        };

        window.updateRiskTable = function(list) {
            const tbody = document.querySelector('#riskTable tbody');
            tbody.innerHTML = '';
            list.forEach(s => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${s.cls}</td><td>${s.name}</td><td class="risk-val">${(s.chi.diff||0).toFixed(1)}</td><td class="risk-val">${(s.eng.diff||0).toFixed(1)}</td><td class="risk-val">${(s.math.diff||0).toFixed(1)}</td>`;
                tbody.appendChild(tr);
            });
        };

        window.updateRankings = function() {
            const sub = document.getElementById('rankSubjectSelect').value;
            let all = [];
            Object.values(processedData).flat().forEach(s => { if(!isNaN(s[sub].diff)) all.push({ ...s, val: s[sub].diff }); });
            all.sort((a,b) => b.val - a.val);
            const top20 = all.slice(0, 20);
            const bot20 = all.slice().reverse().slice(0, 20);
            const renderRow = (s, i, type) => `<tr><td>${i+1}</td><td>${s.cls}</td><td>${s.name}</td><td class="${type}">${s.val > 0 ? '+':''}${s.val.toFixed(1)}</td></tr>`;
            document.getElementById('rankBodyImpContent').innerHTML = top20.map((s,i) => renderRow(s,i,'val-imp')).join('');
            document.getElementById('rankBodyRegContent').innerHTML = bot20.map((s,i) => renderRow(s,i,'val-reg')).join('');
        };

        window.updateDetailControls = function() {
            const viewMode = document.getElementById('viewMode').value;
            document.getElementById('sortControl').style.display = (viewMode !== 'all') ? 'inline-block' : 'none';
            window.drawDetailChart();
        };

        window.drawDetailChart = function() {
            const cls = document.getElementById('classSelect').value;
            const viewMode = document.getElementById('viewMode').value; 
            const sortMode = document.getElementById('sortMode').value;
            if(!cls || !processedData[cls]) return;
            
            let students = [...processedData[cls]];
            if (viewMode === 'all') { students.sort((a, b) => (b.classNum || 0) - (a.classNum || 0)); } 
            else { const sub = viewMode; students.sort((a, b) => { if (sortMode === 'score') return (a[sub].new || 0) - (b[sub].new || 0); if (sortMode === 'diff') return (a[sub].diff || 0) - (b[sub].diff || 0); return (b.classNum || 0) - (a.classNum || 0); }); }

            const names = students.map(s => s.name);
            const traces = [], annotations = [], shapes = [];
            const layouts = { chi: { domain: [0, 0.32], title: 'ä¸­æ–‡ç§‘', key: 'chi' }, eng: { domain: [0.34, 0.66], title: 'è‹±æ–‡ç§‘', key: 'eng' }, math: { domain: [0.68, 1], title: 'æ•¸å­¸ç§‘', key: 'math' } };
            const activeLayouts = viewMode === 'all' ? [layouts.chi, layouts.eng, layouts.math] : [layouts[viewMode]];

            activeLayouts.forEach((L, idx) => {
                const axisName = viewMode === 'all' ? (idx === 0 ? 'x' : (idx === 1 ? 'x2' : 'x3')) : 'x';
                const gOld = globalMeans[L.key].old, gNew = globalMeans[L.key].new;
                shapes.push({ type: 'line', x0: gOld, x1: gOld, y0: 0, y1: 1, xref: axisName, yref: 'paper', line: { color: '#ccc', width: 1, dash: 'dot' } });
                shapes.push({ type: 'line', x0: gNew, x1: gNew, y0: 0, y1: 1, xref: axisName, yref: 'paper', line: { color: '#666', width: 1, dash: 'dash' } });

                const colors = students.map(s => isNaN(s[L.key].diff) ? 'grey' : (s[L.key].diff >= 0 ? '#2ca02c' : '#d62728'));
                traces.push({ x: students.map(s => s[L.key].old), y: names, xaxis: axisName, yaxis: 'y', mode: 'markers', marker: { color: '#e0e0e0', size: 10, line: {color:'#ccc', width:1} }, hoverinfo: 'x+y', showlegend: false });
                traces.push({ x: students.map(s => s[L.key].new), y: names, xaxis: axisName, yaxis: 'y', mode: 'markers', marker: { color: colors, size: 12, line: {width:1,color:'white'} }, hoverinfo: 'x+y', showlegend: false });

                students.forEach(s => {
                    if(isNaN(s[L.key].old) || isNaN(s[L.key].new)) return;
                    const c = s[L.key].diff >= 0 ? '#2ca02c' : '#d62728';
                    annotations.push({ x: s[L.key].new, y: s.name, ax: s[L.key].old, ay: s.name, xref: axisName, yref: 'y', axref: axisName, ayref: 'y', showarrow: true, arrowhead: 2, arrowsize: 1, arrowwidth: 2, arrowcolor: c });
                    annotations.push({ x: Math.max(s[L.key].old, s[L.key].new)+3, y: s.name, xref: axisName, yref: 'y', text: `${s[L.key].new}`, showarrow: false, font: { color: c, size: 13, weight:'bold' }, xanchor: 'left' });
                });
                annotations.push({ x: gNew, y: 1.02, xref: axisName, yref: 'paper', text: `Avg:${gNew.toFixed(0)}`, showarrow: false, font: {size: 11, color: '#666'}, xanchor: 'center' });
            });

            const mainLayout = { title: `ç­åˆ¥ ${cls} è©³ç´°åˆ†æ`, height: Math.max(600, students.length * 40), margin: { l: 150, r: 50, t: 80, b: 50 }, shapes: shapes, yaxis: { automargin: true, title: '', dtick: 1 }, annotations: annotations, showlegend: false, hovermode: 'closest' };
            if(viewMode === 'all') {
                mainLayout.xaxis = { domain: layouts.chi.domain, title: 'ä¸­æ–‡', range: [0, 115] };
                mainLayout.xaxis2 = { domain: layouts.eng.domain, title: 'è‹±æ–‡', range: [0, 115] };
                mainLayout.xaxis3 = { domain: layouts.math.domain, title: 'æ•¸å­¸', range: [0, 115] };
                mainLayout.grid = { rows: 1, columns: 3, pattern: 'independent' };
            } else { mainLayout.xaxis = { domain: [0, 1], title: layouts[viewMode].title, range: [0, 115] }; }
            Plotly.newPlot('chart-main', traces, mainLayout);
        };

        function generateAIReport(stats, gMeans) {
            let promptText = `å…¨ç´šå¹³å‡ - ä¸­:${gMeans.chi.new.toFixed(1)}, è‹±:${gMeans.eng.new.toFixed(1)}, æ•¸:${gMeans.math.new.toFixed(1)}\n`;
            Object.keys(stats).sort().forEach(cls => { promptText += `ã€${cls}ã€‘ä¸­${stats[cls].chi.avgNew.toFixed(1)} è‹±${stats[cls].eng.avgNew.toFixed(1)} æ•¸${stats[cls].math.avgNew.toFixed(1)}\n`; });
            globalAiPromptText = promptText; 
        }
        
        window.copyAiPrompt = function() { navigator.clipboard.writeText(globalAiPromptText).then(() => alert("å·²è¤‡è£½æ•¸æ“šæŒ‡ä»¤ï¼")); };
        window.downloadChart = function(divId, filename) { Plotly.downloadImage(divId, {format: 'png', width: 1200, height: 800, filename: filename}); };
        window.downloadDiv = function(divId, filename) { html2canvas(document.getElementById(divId)).then(canvas => { const link = document.createElement('a'); link.download = filename + '.png'; link.href = canvas.toDataURL(); link.click(); }); };
    </script>

    <style>
        .admin-only { display: none; }
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #f4f4f9; margin: 0; padding: 10px; color: #333; }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .login-box { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 300px; text-align: center; }
        .login-box h2 { margin-top: 0; color: #333; }
        .login-input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px; }
        .login-btn:hover { background: #0056b3; }
        .login-msg { color: #d32f2f; margin-top: 15px; font-size: 0.9em; min-height: 20px; }
        #main-app { display: none; }
        .container { width: 98%; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); box-sizing: border-box; }
        .nav-bar { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; overflow-x: auto; }
        .nav-btn { flex: 1; min-width: 60px; padding: 12px; border: none; background: #e0e0e0; cursor: pointer; font-size: 1.1em; font-weight: bold; border-radius: 8px 8px 0 0; color: #555; transition: 0.2s; }
        .nav-btn:hover { background: #d0d0d0; }
        .nav-btn.active { background: #007bff; color: white; transform: translateY(-2px); box-shadow: 0 -2px 5px rgba(0,0,0,0.1); }
        .grade-badge { background: #007bff; color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.6em; vertical-align: middle; margin-left: 8px; }
        .cloud-status-bar { background: #fff3e0; color: #e65100; padding: 10px; text-align: center; border-radius: 5px; border: 1px solid #ffe0b2; font-weight: bold; margin-bottom: 20px; transition: all 0.3s; word-break: break-all; }
        .cloud-actions { display: none; gap: 15px; justify-content: center; margin-bottom: 20px; padding: 15px; background: #f1f8ff; border-radius: 8px; border: 1px solid #cce5ff; flex-wrap: wrap; }
        .cloud-btn { padding: 10px 20px; background-color: #17a2b8; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .reset-btn { padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .modify-btn { padding: 10px 20px; background-color: #ffc107; color: #333; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        h1, h2 { text-align: center; color: #2c3e50; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 40px; background-color: #e8f5e9; padding: 10px; border-radius: 5px; color: #2e7d32; }
        .control-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; padding: 15px; background-color: #e9ecef; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dee2e6; }
        .encoding-setting { grid-column: 1 / -1; background: #fff3cd; padding: 8px; border-radius: 5px; text-align: center; border: 1px solid #ffeeba; }
        .settings-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; grid-column: 1 / -1; }
        .settings-group { background: #fff; padding: 15px; border-radius: 5px; border: 1px solid #ced4da; margin-top: 10px; display: none; }
        .settings-group.full-width { grid-column: 1 / -1; }
        .selector-item { margin-bottom: 10px; }
        .selector-item label { font-weight: bold; font-size: 0.9em; display: block; margin-bottom: 3px; color: #555; }
        .selector-item select { width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #aaa; }
        .auto-tag { font-size: 0.8em; color: #28a745; margin-left: 5px; background: #e6ffed; padding: 2px 5px; border-radius: 3px; }
        button.primary-btn { grid-column: 1 / -1; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 5px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.3s; width: 100%; }
        button.primary-btn:hover { background-color: #0056b3; }
        .error-msg { color: red; font-weight: bold; text-align: center; margin-top: 10px; }
        .success-msg { color: green; font-weight: bold; font-size: 0.9em; margin-top: 5px; }
        .report-header { display: none; background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; border: 1px solid #c3e6cb; }
        .stats-banner { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; display: none; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-box { border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #fff; position: relative; margin-bottom: 20px; min-height: 400px; }
        .chart-box.full { grid-column: 1 / -1; } 
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .chart-title { font-weight: bold; font-size: 1.1em; color: #444; }
        .download-btn { background-color: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.85em; display: flex; align-items: center; gap: 5px; }
        .risk-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .risk-table th { background-color: #c53030; color: white; padding: 8px; text-align: center; }
        .risk-table td { border: 1px solid #feb2b2; padding: 8px; text-align: center; background: white; }
        .ranking-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px; }
        .rank-table th.imp { background-color: #2ca02c; } .rank-table th.reg { background-color: #d62728; }
        .rank-table td { border: 1px solid #ddd; }
        .val-imp { color: #2ca02c; font-weight: bold; } .val-reg { color: #d62728; font-weight: bold; }
        .detail-control { text-align: center; margin: 20px 0; background: #e3f2fd; padding: 15px; border-radius: 5px; display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; align-items: center; }
        .chart-wrapper { width: 100%; overflow-x: auto; border: 1px solid #eee; border-radius: 4px; padding: 10px; position: relative; }
        #chart-main { width: 100%; min-width: 1200px; height: 900px; }
        .score-display { font-weight: bold; color: #d35400; background: #fff; padding: 5px 10px; border-radius: 4px; margin-left: 10px; border: 1px solid #eee; }
        .ai-container { display: flex; flex-direction: column; height: 600px; border: 1px solid #ddd; border-radius: 8px; background: #fdfdfd; overflow: hidden; }
        .ai-chat-window { flex: 1; padding: 20px; overflow-y: auto; background-color: #f5f7fa; }
        .chat-bubble { max-width: 80%; margin-bottom: 15px; padding: 15px; border-radius: 15px; line-height: 1.5; font-size: 15px; }
        .chat-ai { background-color: #ffffff; border: 1px solid #e1e4e8; align-self: flex-start; margin-right: auto; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .ai-input-area { padding: 15px; background: white; border-top: 1px solid #ddd; }
        .copy-prompt-btn { padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%; }
        .footer { text-align: center; margin-top: 30px; color: #777; font-size: 0.9em; }
        .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .logout-btn { background: #d9534f; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.9em; }
        @media (max-width: 1000px) { .dashboard-grid, .ranking-grid, .settings-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2>ğŸ”’ å®‰å…¨ç™»å…¥ç³»çµ±</h2>
        <div style="font-size: 0.9em; color: #666; margin-bottom: 15px;">è«‹è¼¸å…¥ç²æˆæ¬Šçš„å¸³è™Ÿå¯†ç¢¼</div>
        <input type="email" id="loginEmail" class="login-input" placeholder="é›»å­éƒµä»¶ (Email)" />
        <input type="password" id="loginPass" class="login-input" placeholder="å¯†ç¢¼ (Password)" onkeypress="if(event.key==='Enter') window.performLogin()"/>
        <button id="btnLoginBtn" class="login-btn" onclick="window.performLogin()">ç™»å…¥ç³»çµ±</button>
        <div id="loginMsg" class="login-msg"></div>
    </div>
</div>

<div id="main-app">
    <div class="container">
        <div class="header-controls">
            <h1>ğŸ“Š å…¨ç´šå­¸è¡“æˆç¸¾åˆ†æç³»çµ± <span id="currentGradeBadge" class="grade-badge">P1</span></h1>
            <div style="text-align: right;">
                <span id="user-email-display" style="font-size: 0.9em; color: #555; margin-right: 10px;"></span>
                <button class="logout-btn" onclick="window.performLogout()">ç™»å‡º</button>
            </div>
        </div>
        <div style="text-align: center; color: #666; font-size: 0.9em; margin-bottom: 15px;">V28.5 (å®‰å…¨ç®¡ç†ç‰ˆ)</div>

        <div class="nav-bar">
            <button class="nav-btn active" onclick="window.switchGradeUI('1')">P1</button>
            <button class="nav-btn" onclick="window.switchGradeUI('2')">P2</button>
            <button class="nav-btn" onclick="window.switchGradeUI('3')">P3</button>
            <button class="nav-btn" onclick="window.switchGradeUI('4')">P4</button>
            <button class="nav-btn" onclick="window.switchGradeUI('5')">P5</button>
            <button class="nav-btn" onclick="window.switchGradeUI('6')">P6</button>
        </div>

        <div id="cloudStatus" class="cloud-status-bar">æº–å‚™å°±ç·’</div>

        <div id="reportHeader" class="report-header">
            âœ… <b>é›²ç«¯è³‡æ–™æª¢è¦–æ¨¡å¼</b>
        </div>

        <div class="control-panel" id="mainControlPanel">
            <div class="encoding-setting">
                <label>ğŸ”§ æª”æ¡ˆç·¨ç¢¼ï¼š</label>
                <select id="encodingSelect" onchange="window.resetData()">
                    <option value="Big5" selected>Big5 (Excel é è¨­)</option>
                    <option value="UTF-8">UTF-8 (é€šç”¨)</option>
                </select>
            </div>
            
            <div><label>1. å­¸ç”Ÿè³‡æ–™ (StuInfo)</label><input type="file" id="fileInfo" accept=".csv" onchange="window.handleFileSelect(this, 'info')"><div id="msg-info" class="success-msg"></div></div>
            <div><label>2. èˆŠæˆç¸¾ (ä¸Šå­¸æœŸ)</label><input type="file" id="fileOld" accept=".csv" onchange="window.handleFileSelect(this, 'old')"><div id="msg-old" class="success-msg"></div></div>
            <div><label>3. æ–°æˆç¸¾ (ä¸‹å­¸æœŸ)</label><input type="file" id="fileNew" accept=".csv" onchange="window.handleFileSelect(this, 'new')"><div id="msg-new" class="success-msg"></div></div>

            <div class="settings-container">
                <div id="stuSettings" class="settings-group full-width">
                    <h3>ğŸ‘¤ 1. å­¸ç”Ÿè³‡æ–™æ¬„ä½è¨­å®š</h3>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div class="selector-item" style="flex: 1;"><label>ğŸ« ç­åˆ¥:</label><select id="colClass"></select></div>
                        <div class="selector-item" style="flex: 1;"><label>ğŸ“› å§“å (å„ªå…ˆé¸å–ä¸­æ–‡):</label><select id="colName"></select></div>
                        <div class="selector-item" style="flex: 1;"><label>ğŸ†” è¨»å†Šç·¨è™Ÿ:</label><select id="colRegInfo"></select></div>
                    </div>
                </div>
                <div id="oldScoreSettings" class="settings-group">
                    <h3>ğŸ“‚ 2. èˆŠæˆç¸¾æ¬„ä½</h3>
                    <div class="selector-item"><label>ğŸ†” è¨»å†Šç·¨è™Ÿ:</label><select id="colOldReg"></select></div>
                    <div class="selector-item"><label>ğŸ“– ä¸­æ–‡ç§‘:</label><select id="colOldChi"></select></div>
                    <div class="selector-item"><label>ğŸ”¤ è‹±æ–‡ç§‘:</label><select id="colOldEng"></select></div>
                    <div class="selector-item"><label>ğŸ”¢ æ•¸å­¸ç§‘:</label><select id="colOldMath"></select></div>
                </div>
                <div id="newScoreSettings" class="settings-group">
                    <h3>ğŸ“‚ 3. æ–°æˆç¸¾æ¬„ä½</h3>
                    <div class="selector-item"><label>ğŸ†” è¨»å†Šç·¨è™Ÿ:</label><select id="colNewReg"></select></div>
                    <div class="selector-item"><label>ğŸ”¢ ç­è™Ÿ (Class No.):</label><select id="colNewClassNum"></select></div>
                    <div class="selector-item"><label>ğŸ“– ä¸­æ–‡ç§‘:</label><select id="colNewChi"></select></div>
                    <div class="selector-item"><label>ğŸ”¤ è‹±æ–‡ç§‘:</label><select id="colNewEng"></select></div>
                    <div class="selector-item"><label>ğŸ”¢ æ•¸å­¸ç§‘:</label><select id="colNewMath"></select></div>
                </div>
            </div>

            <button class="primary-btn" onclick="window.processData()">ğŸš€ é–‹å§‹åˆ†æ</button>
            <div id="statusMsg" class="error-msg"></div>
        </div>

        <div id="cloudActions" class="cloud-actions admin-only">
            <button class="reset-btn admin-only" onclick="window.resetToUploadMode()">ğŸ—‘ï¸ æ¸…é™¤/é‡æ–°ä¸Šå‚³</button>
            <button class="modify-btn admin-only" onclick="window.editSettings()">ğŸ“ ä¿®æ”¹æ¬„ä½/é‡æ–°åˆ†æ</button>
            <button id="btnSaveCloud" class="cloud-btn admin-only" onclick="window.saveToCloud_Impl()">â˜ï¸ å„²å­˜ P1 è‡³é›²ç«¯</button>
        </div>

        <div id="stats-banner" class="stats-banner"></div>

        <div id="macro-section" style="display:none;">
            <h2>ğŸ« ç¬¬ä¸€éƒ¨åˆ†ï¼šå…¨ç´šå®è§€åˆ†æ (ç›¸å°é€²é€€æ­¥)</h2>
            <div style="text-align:center; margin-bottom:15px;">
                <label style="font-weight:bold;">é¸æ“‡ç§‘ç›®ï¼š</label>
                <select id="macroSubjectSelect" onchange="updateMacroCharts()" style="padding:5px 15px; font-size:16px;">
                    <option value="chi">ä¸­æ–‡ç§‘</option>
                    <option value="eng">è‹±æ–‡ç§‘</option>
                    <option value="math">æ•¸å­¸ç§‘</option>
                </select>
                <span id="macro-score-diff" class="score-display">--</span>
            </div>
            <div class="dashboard-grid">
                <div class="chart-box"><div class="chart-header"><span class="chart-title">å„ç­ ç›¸å°é€²æ­¥ vs ç›¸å°é€€æ­¥ äººæ•¸</span><button class="download-btn" onclick="downloadChart('chart-bar-stats', 'ç­ç´šé€²é€€æ­¥åˆ†ä½ˆ')">ğŸ“¸ ä¸‹è¼‰</button></div><div id="chart-bar-stats" style="height: 400px;"></div></div>
                <div class="chart-box"><div class="chart-header"><span class="chart-title">å„ç­å¹³å‡åˆ†èµ°å‹¢ (èˆŠ vs æ–°)</span><button class="download-btn" onclick="downloadChart('chart-line-avg', 'ç­ç´šå¹³å‡åˆ†èµ°å‹¢')">ğŸ“¸ ä¸‹è¼‰</button></div><div id="chart-line-avg" style="height: 400px;"></div></div>
                <div class="chart-box full"><div class="chart-header"><span class="chart-title">ğŸ“ˆ å…¨ç´šæˆç¸¾åˆ†ä½ˆéšŠå½¢ vs å¸¸æ…‹åˆ†ä½ˆç·š (åˆ†ç­å †ç–Šé¡¯ç¤º, Bins=4)</span><button class="download-btn" onclick="downloadChart('chart-dist', 'å…¨ç´šæˆç¸¾åˆ†ä½ˆ')">ğŸ“¸ ä¸‹è¼‰</button></div><div id="chart-dist" style="height: 500px;"></div></div>
            </div>
        </div>

        <div id="risk-section" class="alert-box" style="display:none;">
            <div class="alert-title" style="background:#c53030; color:white; padding:10px; font-weight:bold; border-radius:5px 5px 0 0;">âš ï¸ ç¬¬äºŒéƒ¨åˆ†ï¼šé‡é»é—œæ³¨ - å…¨ç§‘ç›¸å°é€€æ­¥ (ä¸­+è‹±+æ•¸)</div>
            <table class="risk-table" id="riskTable"><thead><tr><th>ç­åˆ¥</th><th>å§“å</th><th>ä¸­</th><th>è‹±</th><th>æ•¸</th></tr></thead><tbody></tbody></table>
        </div>

        <div id="ranking-section" class="chart-box" style="display:none; margin-top:40px;">
            <div class="chart-header"><span class="chart-title">ğŸ† ç¬¬ä¸‰éƒ¨åˆ†ï¼šå„ç§‘ç›¸å°è¡¨ç¾æ’è¡Œæ¦œ (å‰20å)</span><button class="download-btn" onclick="downloadDiv('ranking-container', 'æ’è¡Œæ¦œ')">ğŸ“¸ ä¸‹è¼‰</button></div>
            <div id="ranking-container">
                <div style="text-align:center; padding: 10px;"><label>ç§‘ç›®ï¼š</label><select id="rankSubjectSelect" onchange="updateRankings()"><option value="chi">ä¸­æ–‡</option><option value="eng">è‹±æ–‡</option><option value="math">æ•¸å­¸</option></select></div>
                <div class="ranking-grid">
                    <div class="ranking-col"><h3 style="color:#2ca02c; text-align:center;">ğŸš€ ç›¸å°é€²æ­¥</h3><table class="risk-table rank-table"><thead><tr><th>#</th><th>ç­</th><th>å</th><th>åˆ†</th></tr></thead><tbody id="rankBodyImpContent"></tbody></table></div>
                    <div class="ranking-col"><h3 style="color:#d62728; text-align:center;">ğŸ“‰ ç›¸å°é€€æ­¥</h3><table class="risk-table rank-table"><thead><tr><th>#</th><th>ç­</th><th>å</th><th>åˆ†</th></tr></thead><tbody id="rankBodyRegContent"></tbody></table></div>
                </div>
            </div>
        </div>

        <div id="detail-section" style="display:none;">
            <h2>ğŸ” ç¬¬å››éƒ¨åˆ†ï¼šå­¸ç”Ÿæˆç¸¾è©³ç´°åˆ†æ (ç¶“å…¸æ¨¡å¼)</h2>
            <div class="detail-control">
                <div><label>ç­åˆ¥ï¼š</label><select id="classSelect" onchange="drawDetailChart()"><option value="">--</option></select></div>
                <div>
                    <label>æ¨¡å¼ï¼š</label>
                    <select id="viewMode" onchange="updateDetailControls()">
                        <option value="all">ä¸‰ç§‘ä¸¦åˆ— (ç¶“å…¸)</option>
                        <option value="chi">ä¸­æ–‡ç§‘</option>
                        <option value="eng">è‹±æ–‡ç§‘</option>
                        <option value="math">æ•¸å­¸ç§‘</option>
                    </select>
                </div>
                <div id="sortControl" style="display:none; margin-left: 15px;">
                    <label>æ’åºæ–¹å¼ï¼š</label>
                    <select id="sortMode" onchange="drawDetailChart()">
                        <option value="classNum">ä¾ç­è™Ÿ (*Class Number)</option>
                        <option value="score">ä¾åˆ†æ•¸ (é«˜è‡³ä½)</option>
                        <option value="diff">ä¾é€²æ­¥å¹…åº¦ (å¤§è‡³å°)</option>
                    </select>
                </div>
                <div style="margin-left:auto;"><button class="download-btn" onclick="downloadChart('chart-main', 'è©³ç´°åˆ†æ')">ğŸ“¸ ä¸‹è¼‰</button></div>
            </div>
            <div class="chart-wrapper"><div id="chart-main"></div></div>
        </div>

        <div id="ai-section" style="display:none; margin-top:40px;">
            <h2>ğŸ¤– ç¬¬äº”éƒ¨åˆ†ï¼šAI æ™ºèƒ½æ•™å­¸é¡§å• (Beta)</h2>
            <div class="ai-container">
                <div id="chatWindow" class="ai-chat-window"><div class="chat-bubble chat-ai">ğŸ‘‹ åˆ†æå®Œæˆï¼</div></div>
                <div class="ai-input-area"><button class="copy-prompt-btn" onclick="copyAiPrompt()">ğŸ“‹ è¤‡è£½æ•¸æ“šåˆ†ææŒ‡ä»¤</button></div>
            </div>
        </div>

        <div class="footer">ç³»çµ±ç”±ç¨‹å¼å¤¥ä¼´å”åŠ©å»ºç«‹</div>
    </div>
</div>

</body>
</html>