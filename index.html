<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨ç´šå­¸è¡“æˆç¸¾åˆ†æç³»çµ± (V17 é›²ç«¯æ——è‰¦ç‰ˆ)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-statistics/7.7.0/simple-statistics.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

       // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBYtaDjYgO0F2qlvWgmeMavE0SUBTzFONU",
  authDomain: "school-grade-analysis-ed4e1.firebaseapp.com",
  projectId: "school-grade-analysis-ed4e1",
  storageBucket: "school-grade-analysis-ed4e1.firebasestorage.app",
  messagingSenderId: "119965796660",
  appId: "1:119965796660:web:55e160b8eab960ab157d61",
  measurementId: "G-S36T3HV2PT"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // --- é›²ç«¯åŠŸèƒ½æ›è¼‰ ---
        
        // 1. å„²å­˜æ•¸æ“š
        window.saveToCloud = async function() {
            const grade = window.currentGrade;
            // æª¢æŸ¥æ˜¯å¦æœ‰æ•¸æ“šå¯å­˜ (æª¢æŸ¥ global è®Šæ•¸)
            if(!window.processedDataExport || Object.keys(window.processedDataExport).length === 0) { 
                alert("æ²’æœ‰åˆ†ææ•¸æ“šå¯ä¾›å„²å­˜ï¼è«‹å…ˆä¸Šå‚³æª”æ¡ˆä¸¦åˆ†æã€‚"); return; 
            }
            
            const btn = document.getElementById('btnSaveCloud');
            const originalText = btn.innerHTML;
            btn.innerHTML = "â˜ï¸ å„²å­˜ä¸­...";
            btn.disabled = true;

            try {
                // JSON åºåˆ—åŒ– (è™•ç† NaN å•é¡Œ)
                const jsonString = JSON.stringify(window.processedDataExport, (key, value) => 
                    (typeof value === 'number' && isNaN(value)) ? "###NaN###" : value
                );
                
                await setDoc(doc(db, "grades", grade), { 
                    data: JSON.parse(jsonString), 
                    updatedAt: new Date().toLocaleString() 
                });
                
                alert(`âœ… P${grade} æ•¸æ“šå·²æˆåŠŸä¸Šå‚³è‡³é›²ç«¯ï¼`);
                document.getElementById('cloudStatus').innerHTML = `âœ… P${grade} æ•¸æ“šå·²åŒæ­¥ (æœ€å¾Œæ›´æ–°: ${new Date().toLocaleString()})`;
            } catch (e) {
                console.error(e);
                alert("å„²å­˜å¤±æ•—ï¼š" + e.message);
            }
            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        // 2. è®€å–æ•¸æ“š
        window.loadFromCloud = async function(grade) {
            window.switchGradeUI(grade);
            const statusDiv = document.getElementById('cloudStatus');
            statusDiv.innerHTML = `â³ æ­£åœ¨è®€å– P${grade} é›²ç«¯æ•¸æ“š...`;
            
            try {
                const docRef = doc(db, "grades", grade);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const savedData = docSnap.data().data;
                    
                    // é‚„åŸ NaN
                    const cleanData = JSON.parse(JSON.stringify(savedData), (key, value) => 
                        value === "###NaN###" ? NaN : value
                    );

                    // é‚„åŸå…¨åŸŸè®Šæ•¸
                    window.processedData = cleanData.processedData; // æ³¨æ„ V16 è®Šæ•¸å
                    window.classStats = cleanData.classStats;
                    window.globalMeans = cleanData.globalMeans;
                    window.globalSDs = cleanData.globalSDs;
                    window.processedDataExport = cleanData; // é‚„åŸå°å‡ºç‰©ä»¶

                    // æ¢å¾©ä»‹é¢
                    document.getElementById('uploadPanel').style.display = 'none';
                    document.getElementById('stats-banner').style.display = 'grid';
                    document.getElementById('macro-section').style.display = 'block';
                    document.getElementById('risk-section').style.display = 'block';
                    document.getElementById('ranking-section').style.display = 'block';
                    document.getElementById('detail-section').style.display = 'block';
                    document.getElementById('ai-section').style.display = 'block';
                    document.getElementById('exportSection').style.display = 'flex'; // é¡¯ç¤ºé›²ç«¯æŒ‰éˆ•å€

                    statusDiv.innerHTML = `âœ… å·²è¼‰å…¥ P${grade} é›²ç«¯æ•¸æ“š (æ›´æ–°æ–¼: ${docSnap.data().updatedAt})`;
                    
                    // é‡æ–°æ¸²æŸ“æ‰€æœ‰åœ–è¡¨
                    window.renderDashboard();

                } else {
                    statusDiv.innerHTML = `â„¹ï¸ P${grade} å°šç„¡é›²ç«¯æ•¸æ“šï¼Œè«‹ä¸Šå‚³æª”æ¡ˆé€²è¡Œåˆ†æã€‚`;
                    window.resetToUploadMode();
                }
            } catch (e) {
                console.error(e);
                statusDiv.innerHTML = `âŒ è®€å–éŒ¯èª¤ (è«‹æª¢æŸ¥ç¶²çµ¡æˆ– API Key): ${e.message}`;
            }
        }
    </script>

    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #f4f4f9; margin: 0; padding: 10px; color: #333; }
        .container { width: 98%; max-width: 1400px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); box-sizing: border-box; }
        
        /* å°èˆªåˆ— Styles */
        .nav-bar { display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; overflow-x: auto; }
        .nav-btn { flex: 1; min-width: 60px; padding: 12px; border: none; background: #e0e0e0; cursor: pointer; font-size: 1.1em; font-weight: bold; border-radius: 8px 8px 0 0; color: #555; transition: 0.2s; }
        .nav-btn:hover { background: #d0d0d0; }
        .nav-btn.active { background: #007bff; color: white; transform: translateY(-2px); box-shadow: 0 -2px 5px rgba(0,0,0,0.1); }
        .grade-badge { background: #007bff; color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.6em; vertical-align: middle; margin-left: 8px; }

        h1, h2 { text-align: center; color: #2c3e50; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 40px; background-color: #e8f5e9; padding: 10px; border-radius: 5px; color: #2e7d32; }

        /* Control Panel */
        .control-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; padding: 15px; background-color: #e9ecef; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dee2e6; }
        .encoding-setting { grid-column: 1 / -1; background: #fff3cd; padding: 8px; border-radius: 5px; text-align: center; border: 1px solid #ffeeba; }
        
        /* é›²ç«¯ç‹€æ…‹åˆ— */
        .cloud-status-bar { background: #fff3e0; color: #e65100; padding: 10px; text-align: center; border-radius: 5px; border: 1px solid #ffe0b2; font-weight: bold; margin-bottom: 20px; }

        .settings-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; grid-column: 1 / -1; }
        .settings-group { background: #fff; padding: 15px; border-radius: 5px; border: 1px solid #ced4da; margin-top: 10px; display: none; }
        .settings-group.full-width { grid-column: 1 / -1; }
        .settings-group h3 { margin-top: 0; margin-bottom: 10px; font-size: 1.1em; color: #495057; border-bottom: 2px solid #007bff; display: inline-block; padding-bottom: 3px; }
        .selector-item { margin-bottom: 10px; }
        .selector-item label { font-weight: bold; font-size: 0.9em; display: block; margin-bottom: 3px; color: #555; }
        .selector-item select { width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #aaa; }
        .auto-tag { font-size: 0.8em; color: #28a745; margin-left: 5px; background: #e6ffed; padding: 2px 5px; border-radius: 3px; }

        button.primary-btn { grid-column: 1 / -1; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 5px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        button.primary-btn:hover { background-color: #0056b3; }
        .error-msg { color: red; font-weight: bold; text-align: center; margin-top: 10px; }
        .success-msg { color: green; font-weight: bold; font-size: 0.9em; margin-top: 5px; }

        /* Cloud Actions Section */
        .cloud-actions { display: none; gap: 15px; justify-content: center; margin-bottom: 20px; padding: 15px; background: #f1f8ff; border-radius: 8px; border: 1px solid #cce5ff; }
        .cloud-btn { padding: 10px 20px; background-color: #17a2b8; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .cloud-btn:hover { background-color: #138496; }
        .reset-btn { padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .reset-btn:hover { background-color: #5a6268; }

        /* Banner */
        .stats-banner { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; display: none; }
        .stat-card { background: #f8f9fa; padding: 10px; border-radius: 5px; text-align: center; border: 1px solid #ddd; }
        .stat-val { font-weight: bold; color: #007bff; font-size: 1.1em; }
        
        /* Dashboard & Charts */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-box { border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #fff; position: relative; margin-bottom: 20px; }
        .chart-box.full { grid-column: 1 / -1; } 
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .chart-title { font-weight: bold; font-size: 1.1em; color: #444; }
        .download-btn { background-color: #6c757d; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; display: flex; align-items: center; gap: 5px; }
        .download-btn:hover { background-color: #5a6268; }
        
        .risk-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .risk-table th { background-color: #c53030; color: white; padding: 8px; text-align: center; }
        .risk-table td { border: 1px solid #feb2b2; padding: 8px; text-align: center; background: white; }
        .risk-val { color: #c53030; font-weight: bold; }
        
        .ranking-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px; }
        .rank-table th.imp { background-color: #2ca02c; color: white; }
        .rank-table th.reg { background-color: #d62728; color: white; }
        .rank-table td { border: 1px solid #ddd; text-align: center; padding: 8px; }
        .val-imp { color: #2ca02c; font-weight: bold; }
        .val-reg { color: #d62728; font-weight: bold; }

        .detail-control { text-align: center; margin: 20px 0; background: #e3f2fd; padding: 15px; border-radius: 5px; display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; align-items: center; }
        .chart-wrapper { width: 100%; overflow-x: auto; border: 1px solid #eee; border-radius: 4px; padding: 10px; position: relative; }
        #chart-main { width: 100%; min-width: 1200px; height: 900px; }
        .score-display { font-weight: bold; color: #d35400; background: #fff; padding: 5px 10px; border-radius: 4px; margin-left: 10px; border: 1px solid #eee; }

        /* AI Chat */
        .ai-container { display: flex; flex-direction: column; height: 600px; border: 1px solid #ddd; border-radius: 8px; background: #fdfdfd; overflow: hidden; }
        .ai-chat-window { flex: 1; padding: 20px; overflow-y: auto; background-color: #f5f7fa; }
        .chat-bubble { max-width: 80%; margin-bottom: 15px; padding: 15px; border-radius: 15px; line-height: 1.5; font-size: 15px; }
        .chat-ai { background-color: #ffffff; border: 1px solid #e1e4e8; align-self: flex-start; margin-right: auto; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .ai-input-area { padding: 15px; background: white; border-top: 1px solid #ddd; }
        .copy-prompt-btn { padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%; }

        .footer { text-align: center; margin-top: 30px; color: #777; font-size: 0.9em; }
        @media (max-width: 1000px) { .dashboard-grid, .ranking-grid, .settings-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <h1 id="mainTitle">å…¨ç´šå­¸è¡“æˆç¸¾åˆ†æç³»çµ± <span id="currentGradeBadge" class="grade-badge">P1</span></h1>
    <div style="text-align: center; color: #666; font-size: 0.9em; margin-bottom: 15px;">V17 é›²ç«¯æ——è‰¦ç‰ˆ (Firebase Integration)</div>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="window.loadFromCloud('1')">P1</button>
        <button class="nav-btn" onclick="window.loadFromCloud('2')">P2</button>
        <button class="nav-btn" onclick="window.loadFromCloud('3')">P3</button>
        <button class="nav-btn" onclick="window.loadFromCloud('4')">P4</button>
        <button class="nav-btn" onclick="window.loadFromCloud('5')">P5</button>
        <button class="nav-btn" onclick="window.loadFromCloud('6')">P6</button>
    </div>

    <div id="cloudStatus" class="cloud-status-bar">æº–å‚™å°±ç·’ï¼Œè«‹ä¸Šå‚³æª”æ¡ˆæˆ–åˆ‡æ›å¹´ç´šè®€å–æ•¸æ“šã€‚</div>

    <div class="control-panel" id="uploadPanel">
        <div class="encoding-setting">
            <label>ğŸ”§ æª”æ¡ˆç·¨ç¢¼ï¼š</label>
            <select id="encodingSelect" onchange="resetData()">
                <option value="Big5" selected>Big5 (Excel é è¨­)</option>
                <option value="UTF-8">UTF-8 (é€šç”¨)</option>
            </select>
        </div>
        
        <div><label>1. å­¸ç”Ÿè³‡æ–™ (StuInfo)</label><input type="file" id="fileInfo" accept=".csv"><div id="msg-info" class="success-msg"></div></div>
        <div><label>2. èˆŠæˆç¸¾ (ä¸Šå­¸æœŸ)</label><input type="file" id="fileOld" accept=".csv"><div id="msg-old" class="success-msg"></div></div>
        <div><label>3. æ–°æˆç¸¾ (ä¸‹å­¸æœŸ)</label><input type="file" id="fileNew" accept=".csv"><div id="msg-new" class="success-msg"></div></div>

        <div class="settings-container">
            <div id="stuSettings" class="settings-group full-width">
                <h3>ğŸ‘¤ 1. å­¸ç”Ÿè³‡æ–™æ¬„ä½è¨­å®š</h3>
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div class="selector-item" style="flex: 1;"><label>ğŸ« ç­åˆ¥:</label><select id="colClass"></select></div>
                    <div class="selector-item" style="flex: 1;"><label>ğŸ“› å§“å:</label><select id="colName"></select></div>
                    <div class="selector-item" style="flex: 1;"><label>ğŸ†” è¨»å†Šç·¨è™Ÿ:</label><select id="colRegInfo"></select></div>
                </div>
            </div>
            <div id="oldScoreSettings" class="settings-group">
                <h3>ğŸ“‚ 2. èˆŠæˆç¸¾æ¬„ä½</h3>
                <div class="selector-item"><label>ğŸ†” è¨»å†Šç·¨è™Ÿ:</label><select id="colOldReg"></select></div>
                <div class="selector-item"><label>ğŸ“– ä¸­æ–‡ç§‘:</label><select id="colOldChi"></select></div>
                <div class="selector-item"><label>ğŸ”¤ è‹±æ–‡ç§‘:</label><select id="colOldEng"></select></div>
                <div class="selector-item"><label>ğŸ”¢ æ•¸å­¸ç§‘:</label><select id="colOldMath"></select></div>
            </div>
            <div id="newScoreSettings" class="settings-group">
                <h3>ğŸ“‚ 3. æ–°æˆç¸¾æ¬„ä½</h3>
                <div class="selector-item"><label>ğŸ†” è¨»å†Šç·¨è™Ÿ:</label><select id="colNewReg"></select></div>
                <div class="selector-item"><label>ğŸ“– ä¸­æ–‡ç§‘:</label><select id="colNewChi"></select></div>
                <div class="selector-item"><label>ğŸ”¤ è‹±æ–‡ç§‘:</label><select id="colNewEng"></select></div>
                <div class="selector-item"><label>ğŸ”¢ æ•¸å­¸ç§‘:</label><select id="colNewMath"></select></div>
            </div>
        </div>

        <button class="primary-btn" onclick="processData()">é–‹å§‹åˆ†æ</button>
        <div id="statusMsg" class="error-msg"></div>
    </div>

    <div id="exportSection" class="cloud-actions">
        <button class="reset-btn" onclick="window.resetToUploadMode()">â†©ï¸ é‡æ–°ä¸Šå‚³/ä¿®æ­£</button>
        <button id="btnSaveCloud" class="cloud-btn" onclick="window.saveToCloud()">â˜ï¸ å„²å­˜ P1 æ•¸æ“šè‡³é›²ç«¯</button>
    </div>

    <div id="stats-banner" class="stats-banner"></div>

    <div id="macro-section" style="display:none;">
        <h2>ğŸ« ç¬¬ä¸€éƒ¨åˆ†ï¼šå…¨ç´šå®è§€åˆ†æ</h2>
        <div style="text-align:center; margin-bottom:15px;">
            <label style="font-weight:bold;">é¸æ“‡ç§‘ç›®ï¼š</label>
            <select id="macroSubjectSelect" onchange="window.renderDashboard()" style="padding:5px 15px; font-size:16px;">
                <option value="chi">ä¸­æ–‡ç§‘</option>
                <option value="eng">è‹±æ–‡ç§‘</option>
                <option value="math">æ•¸å­¸ç§‘</option>
            </select>
            <span id="macro-score-diff" class="score-display">--</span>
        </div>
        
        <div class="dashboard-grid">
            <div class="chart-box">
                <div class="chart-header">
                    <span class="chart-title">å„ç­ ç›¸å°é€²æ­¥ vs ç›¸å°é€€æ­¥ äººæ•¸</span>
                    <button class="download-btn" onclick="downloadChart('chart-bar-stats', 'ç­ç´šé€²é€€æ­¥åˆ†ä½ˆ')">ğŸ“¸ ä¸‹è¼‰</button>
                </div>
                <div id="chart-bar-stats" style="height: 400px;"></div>
            </div>
            <div class="chart-box">
                <div class="chart-header">
                    <span class="chart-title">å„ç­å¹³å‡åˆ† vs å…¨ç´šå¹³å‡ç·š</span>
                    <button class="download-btn" onclick="downloadChart('chart-line-avg', 'ç­ç´šå¹³å‡åˆ†è¶¨å‹¢')">ğŸ“¸ ä¸‹è¼‰</button>
                </div>
                <div id="chart-line-avg" style="height: 400px;"></div>
            </div>
            
            <div class="chart-box full">
                <div class="chart-header">
                    <span class="chart-title">ğŸ“ˆ å…¨ç´šæˆç¸¾åˆ†ä½ˆéšŠå½¢ vs å¸¸æ…‹åˆ†ä½ˆç·š (Bell Curve)</span>
                    <button class="download-btn" onclick="downloadChart('chart-dist', 'å…¨ç´šæˆç¸¾åˆ†ä½ˆ')">ğŸ“¸ ä¸‹è¼‰</button>
                </div>
                <p style="font-size:0.9em; color:#666; margin:0 0 10px 10px;">
                    * <b>å½©è‰²æŸ±ç‹€åœ–</b>ï¼šå„ç­å¯¦éš›äººæ•¸å †ç–Š (æ¯ 2 åˆ†ç‚ºä¸€çµ„)ã€‚ 
                    * <b>é»‘è‰²è™›ç·š</b>ï¼šç†æƒ³å¸¸æ…‹åˆ†ä½ˆ (è‹¥æŸ±ç‹€åœ–æ¯”è™›ç·šæ‰å¹³ï¼Œä»£è¡¨å·®ç•°éå¤§)ã€‚
                </p>
                <div id="chart-dist" style="height: 500px;"></div>
            </div>
        </div>
    </div>

    <div id="risk-section" class="alert-box" style="display:none;">
        <div class="alert-title" style="background:#c53030; color:white; padding:10px; font-weight:bold; border-radius:5px 5px 0 0;">âš ï¸ ç¬¬äºŒéƒ¨åˆ†ï¼šé‡é»é—œæ³¨ - å…¨ç§‘ç›¸å°é€€æ­¥ (ä¸­+è‹±+æ•¸)</div>
        <table class="risk-table" id="riskTable">
            <thead><tr><th>ç­åˆ¥</th><th>å§“å</th><th>ä¸­æ–‡ç›¸å°è®ŠåŒ–</th><th>è‹±æ–‡ç›¸å°è®ŠåŒ–</th><th>æ•¸å­¸ç›¸å°è®ŠåŒ–</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="ranking-section" class="chart-box" style="display:none; margin-top:40px;">
        <div class="chart-header">
            <span class="chart-title">ğŸ† ç¬¬ä¸‰éƒ¨åˆ†ï¼šå„ç§‘ç›¸å°è¡¨ç¾æ’è¡Œæ¦œ (å‰20å)</span>
            <button class="download-btn" onclick="downloadDiv('ranking-container', 'å„ç§‘æ’è¡Œæ¦œ')">ğŸ“¸ ä¸‹è¼‰</button>
        </div>
        <div id="ranking-container">
            <div style="text-align:center; padding: 10px;">
                <label style="font-weight:bold;">é¸æ“‡ç§‘ç›®ï¼š</label>
                <select id="rankSubjectSelect" onchange="updateRankings()" style="padding:5px 15px; font-size:16px;">
                    <option value="chi">ä¸­æ–‡ç§‘</option>
                    <option value="eng">è‹±æ–‡ç§‘</option>
                    <option value="math">æ•¸å­¸ç§‘</option>
                </select>
            </div>
            <div class="ranking-grid">
                <div class="ranking-col">
                    <h3 style="color:#2ca02c; text-align:center;">ğŸš€ ç›¸å°é€²æ­¥ (Top 20)</h3>
                    <table class="risk-table rank-table"><thead><tr><th class="imp">æ’å</th><th class="imp">ç­åˆ¥</th><th class="imp">å§“å</th><th class="imp">ç›¸å°åˆ†æ•¸</th></tr></thead><tbody id="rankBodyImpContent"></tbody></table>
                </div>
                <div class="ranking-col">
                    <h3 style="color:#d62728; text-align:center;">ğŸ“‰ ç›¸å°é€€æ­¥ (Bottom 20)</h3>
                    <table class="risk-table rank-table"><thead><tr><th class="reg">æ’å</th><th class="reg">ç­åˆ¥</th><th class="reg">å§“å</th><th class="reg">ç›¸å°åˆ†æ•¸</th></tr></thead><tbody id="rankBodyRegContent"></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <div id="detail-section" style="display:none;">
        <h2>ğŸ” ç¬¬å››éƒ¨åˆ†ï¼šå­¸ç”Ÿæˆç¸¾è©³ç´°åˆ†æ</h2>
        <div class="detail-control">
            <div><label>1. é¸æ“‡ç­åˆ¥ï¼š</label><select id="classSelect" onchange="drawDetailChart()"><option value="">-- è«‹é¸æ“‡ --</option></select></div>
            <div><label>2. é¡¯ç¤ºæ¨¡å¼ï¼š</label><select id="viewMode" onchange="drawDetailChart()">
                <option value="all">ä¸‰ç§‘ä¸¦åˆ— (ç¸½è¦½)</option><option value="chi">ä¸­æ–‡ç§‘ (å–®ç§‘æ”¾å¤§)</option><option value="eng">è‹±æ–‡ç§‘ (å–®ç§‘æ”¾å¤§)</option><option value="math">æ•¸å­¸ç§‘ (å–®ç§‘æ”¾å¤§)</option>
            </select></div>
            <div style="margin-left:auto;"><button class="download-btn" onclick="downloadChart('chart-main', 'è©³ç´°æˆç¸¾åˆ†æ')">ğŸ“¸ ä¸‹è¼‰åœ–è¡¨</button></div>
        </div>
        <div class="chart-wrapper"><div id="chart-main"></div></div>
    </div>

    <div id="ai-section" style="display:none; margin-top:40px;">
        <h2>ğŸ¤– ç¬¬äº”éƒ¨åˆ†ï¼šAI æ™ºèƒ½æ•™å­¸é¡§å• (Beta)</h2>
        <div class="ai-container">
            <div id="chatWindow" class="ai-chat-window">
                <div class="chat-bubble chat-ai">ğŸ‘‹ è€å¸«æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„æ•¸æ“šåˆ†æåŠ©ç†ã€‚<br>åˆ†æå®Œæˆï¼è«‹è¤‡è£½ä¸‹æ–¹æŒ‡ä»¤è²¼åˆ° ChatGPT ä»¥ç²å¾—è©³ç´°å»ºè­°ã€‚</div>
            </div>
            <div class="ai-input-area">
                <button class="copy-prompt-btn" onclick="copyAiPrompt()">ğŸ“‹ è¤‡è£½æ•¸æ“šåˆ†ææŒ‡ä»¤ (è²¼çµ¦ ChatGPT ç²å¾—æ•™å­¸å»ºè­°)</button>
            </div>
        </div>
    </div>

    <div class="footer">ç³»çµ±ç”±ç¨‹å¼å¤¥ä¼´å”åŠ©å»ºç«‹</div>
</div>

<script>
    // --- Global Variables ---
    let rawInfo = [], rawOld = [], rawNew = [];
    window.processedData = {};
    window.classStats = {}; 
    window.globalMeans = {}; 
    window.globalSDs = {};
    let aiAnalysisReport = "";
    window.currentGrade = '1';
    window.processedDataExport = {}; // Object to be saved to Cloud

    // --- Init ---
    window.addEventListener('DOMContentLoaded', () => {
        // Default load P1
        window.loadFromCloud('1');
    });

    // --- UI Switch Logic ---
    window.switchGradeUI = function(grade) {
        window.currentGrade = grade;
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.nav-btn')[grade-1].classList.add('active');
        document.getElementById('currentGradeBadge').innerText = `P${grade}`;
        document.getElementById('btnSaveCloud').innerText = `â˜ï¸ å„²å­˜ P${grade} æ•¸æ“šè‡³é›²ç«¯`;
        
        // Default to upload mode visually until data is confirmed
        window.resetToUploadMode();
    }

    window.resetToUploadMode = function() {
        document.getElementById('uploadPanel').style.display = 'grid';
        ['stats-banner', 'macro-section', 'risk-section', 'ranking-section', 'detail-section', 'ai-section', 'exportSection'].forEach(id => {
            document.getElementById(id).style.display = 'none';
        });
        resetData(); // Clear memory
    }

    // --- CSV Handling (V16 Logic) ---
    ['fileInfo', 'fileOld', 'fileNew'].forEach(id => {
        document.getElementById(id).addEventListener('change', (e) => {
            const type = id.replace('file', '').toLowerCase();
            parseCSV(e.target.files[0], type);
        });
    });

    function resetData() {
        rawInfo = []; rawOld = []; rawNew = [];
        ['stuSettings', 'oldScoreSettings', 'newScoreSettings'].forEach(id => { document.getElementById(id).style.display = 'none'; });
        ['msg-info', 'msg-old', 'msg-new'].forEach(id => { document.getElementById(id).innerText = ''; });
    }

    function parseCSV(file, type) {
        if(!file) return;
        const enc = document.getElementById('encodingSelect').value;
        const status = document.getElementById('statusMsg');
        status.innerText = "è®€å–ä¸­...";

        Papa.parse(file, {
            header: false, skipEmptyLines: true, encoding: enc,
            complete: (res) => {
                if(!res.data || res.data.length < 1) { status.innerText = "éŒ¯èª¤ï¼šæª”æ¡ˆå…§å®¹ç‚ºç©ºã€‚"; return; }
                document.getElementById('msg-' + type).innerText = `âœ… å·²è®€å– ${res.data.length} è¡Œ`;
                if(type === 'info') { rawInfo = res.data; initStuSelectors(); }
                if(type === 'old') { rawOld = res.data; initScoreSelectors(rawOld, 'old'); }
                if(type === 'new') { rawNew = res.data; initScoreSelectors(rawNew, 'new'); }
                status.innerText = "";
            }
        });
    }

    function populateSelect(selectId, headers, keywords = [], defaultIdx = -1) {
        const sel = document.getElementById(selectId);
        if(!sel) return;
        sel.innerHTML = '';
        let foundIdx = -1;
        headers.forEach((h, index) => {
            if(!h) return;
            const opt = document.createElement('option');
            opt.value = index; opt.text = `[${index}] ${h}`;
            sel.appendChild(opt);
            if (foundIdx === -1 && keywords.length > 0) {
                const lowerH = h.toLowerCase();
                if (keywords.every(k => lowerH.includes(k))) foundIdx = index;
            }
        });
        if (foundIdx !== -1) {
            sel.value = foundIdx;
            const label = sel.previousElementSibling;
            if(label && !label.innerHTML.includes('è‡ªå‹•åµæ¸¬')) label.innerHTML += ' <span class="auto-tag">âœ” è‡ªå‹•åµæ¸¬</span>';
        } else if (defaultIdx >= 0 && defaultIdx < headers.length) sel.value = defaultIdx;
    }

    function initStuSelectors() {
        if (!rawInfo || rawInfo.length < 1) return;
        const headers = rawInfo[0];
        document.getElementById('stuSettings').style.display = 'block';
        populateSelect('colClass', headers, ['ç­åˆ¥', 'class'], 3);
        populateSelect('colName', headers, ['ä¸­æ–‡å§“å', 'chinese name'], 7);
        populateSelect('colRegInfo', headers, ['è¨»å†Š', 'reg'], 0);
    }

    function initScoreSelectors(data, type) {
        if (!data || data.length < 1) return;
        const headers = data[0];
        const prefix = type === 'old' ? 'colOld' : 'colNew';
        document.getElementById(type === 'old' ? 'oldScoreSettings' : 'newScoreSettings').style.display = 'block';
        populateSelect(`${prefix}Reg`, headers, ['reg', 'è¨»å†Š'], 8);
        populateSelect(`${prefix}Chi`, headers, ['ä¸­æ–‡', 'chi'], 9);
        populateSelect(`${prefix}Eng`, headers, ['è‹±æ–‡', 'eng'], 10);
        populateSelect(`${prefix}Math`, headers, ['æ•¸å­¸', 'math'], 12);
    }

    // --- Main Processing Logic ---
    window.processData = function() {
        const status = document.getElementById('statusMsg');
        if (!rawInfo.length || !rawOld.length || !rawNew.length) {
            status.innerText = "éŒ¯èª¤ï¼šè«‹ç¢ºä¿ä¸‰å€‹æª”æ¡ˆéƒ½å·²ä¸Šå‚³ã€‚"; return;
        }

        const idxClass = parseInt(document.getElementById('colClass').value);
        const idxName = parseInt(document.getElementById('colName').value);
        const idxRegInfo = parseInt(document.getElementById('colRegInfo').value);
        const idxOldReg = parseInt(document.getElementById('colOldReg').value);
        const idxOldChi = parseInt(document.getElementById('colOldChi').value);
        const idxOldEng = parseInt(document.getElementById('colOldEng').value);
        const idxOldMath = parseInt(document.getElementById('colOldMath').value);
        const idxNewReg = parseInt(document.getElementById('colNewReg').value);
        const idxNewChi = parseInt(document.getElementById('colNewChi').value);
        const idxNewEng = parseInt(document.getElementById('colNewEng').value);
        const idxNewMath = parseInt(document.getElementById('colNewMath').value);

        const validRegNos = new Set();
        rawInfo.slice(1).forEach(r => {
            const reg = r[idxRegInfo] ? r[idxRegInfo].trim() : "";
            if(reg) validRegNos.add(reg);
        });

        if(validRegNos.size === 0) { status.innerText = "è­¦å‘Šï¼šæ‰¾ä¸åˆ°æœ‰æ•ˆçš„è¨»å†Šç·¨è™Ÿã€‚"; return; }

        function getScores(data, idxReg, idxChi, idxEng, idxMath) {
            const map = {};
            data.slice(1).forEach(r => {
                const reg = r[idxReg] ? r[idxReg].trim() : null;
                if(reg) {
                    map[reg] = { chi: parseScore(r[idxChi]), eng: parseScore(r[idxEng]), math: parseScore(r[idxMath]) };
                }
            });
            return map;
        }

        function parseScore(val) {
            if (!val) return NaN;
            const clean = val.toString().trim();
            if (clean === '' || ['abs', 'absent', 'ops', '--'].includes(clean.toLowerCase())) return NaN;
            return parseFloat(clean);
        }

        const mapOld = getScores(rawOld, idxOldReg, idxOldChi, idxOldEng, idxOldMath);
        const mapNew = getScores(rawNew, idxNewReg, idxNewChi, idxNewEng, idxNewMath);

        const subjects = ['chi', 'eng', 'math'];
        let sums = {}, allNewScores = {chi:[], eng:[], math:[]};
        subjects.forEach(sub => sums[sub] = { oldSum:0, oldCnt:0, newSum:0, newCnt:0 });

        [mapOld, mapNew].forEach((map, isNew) => {
            Object.keys(map).forEach(reg => {
                if (validRegNos.has(reg)) {
                    subjects.forEach(sub => {
                        const val = map[reg][sub];
                        if(!isNaN(val)) {
                            if(isNew) { 
                                sums[sub].newSum += val; sums[sub].newCnt++; 
                                allNewScores[sub].push(val);
                            }
                            else { sums[sub].oldSum += val; sums[sub].oldCnt++; }
                        }
                    });
                }
            });
        });

        window.globalMeans = {}; window.globalSDs = {};
        subjects.forEach(sub => {
            window.globalMeans[sub] = {
                old: sums[sub].oldCnt ? (sums[sub].oldSum / sums[sub].oldCnt) : 0,
                new: sums[sub].newCnt ? (sums[sub].newSum / sums[sub].newCnt) : 0
            };
            if(allNewScores[sub].length > 1) {
                window.globalSDs[sub] = ss.standardDeviation(allNewScores[sub]);
            } else { window.globalSDs[sub] = 15; }
        });

        window.processedData = {};
        const riskList = [];
        const classesFound = new Set();

        rawInfo.slice(1).forEach(r => {
            const reg = r[idxRegInfo] ? r[idxRegInfo].trim() : null;
            if(reg && validRegNos.has(reg)) {
                const cls = r[idxClass] ? r[idxClass].trim() : "Unknown";
                const name = r[idxName] ? r[idxName].trim() : "Unknown";
                
                const o = mapOld[reg] || { chi: NaN, eng: NaN, math: NaN };
                const n = mapNew[reg] || { chi: NaN, eng: NaN, math: NaN };
                
                if(subjects.some(sub => !isNaN(o[sub]) || !isNaN(n[sub]))) {
                    const student = { name: name, cls: cls };
                    subjects.forEach(sub => {
                        const oldScore = o[sub];
                        const newScore = n[sub];
                        let relativeDiff = NaN;
                        if(!isNaN(oldScore) && !isNaN(newScore)) {
                            relativeDiff = (newScore - window.globalMeans[sub].new) - (oldScore - window.globalMeans[sub].old);
                        }
                        student[sub] = { old: oldScore, new: newScore, diff: relativeDiff };
                    });

                    if(!window.processedData[cls]) window.processedData[cls] = [];
                    window.processedData[cls].push(student);
                    classesFound.add(cls);
                }
            }
        });

        window.classStats = {};
        const sortedClasses = Array.from(classesFound).sort();
        
        sortedClasses.forEach(cls => {
            window.classStats[cls] = {};
            subjects.forEach(sub => {
                let imp = 0, reg = 0, sumOld = 0, cntOld = 0, sumNew = 0, cntNew = 0;
                let scoresNew = [];
                
                window.processedData[cls].forEach(s => {
                    if(!isNaN(s[sub].old)) { sumOld += s[sub].old; cntOld++; }
                    if(!isNaN(s[sub].new)) { 
                        sumNew += s[sub].new; cntNew++; 
                        scoresNew.push(s[sub].new);
                    }
                    if(!isNaN(s[sub].diff)) { if(s[sub].diff >= 0) imp++; else reg++; }
                });

                let median = 0;
                scoresNew.sort((a,b)=>a-b);
                if(scoresNew.length > 0) {
                    const mid = Math.floor(scoresNew.length/2);
                    median = scoresNew.length % 2 !== 0 ? scoresNew[mid] : (scoresNew[mid-1] + scoresNew[mid])/2;
                }
                
                let meanNew = cntNew ? sumNew/cntNew : 0;
                let sd = scoresNew.length > 1 ? ss.standardDeviation(scoresNew) : 0;

                window.classStats[cls][sub] = { 
                    improved: imp, regressed: reg,
                    avgOld: cntOld ? sumOld/cntOld : 0, 
                    avgNew: meanNew,
                    median: median,
                    sd: sd,
                    count: cntNew
                };
            });
        });

        // æº–å‚™å„²å­˜ç‰©ä»¶
        window.processedDataExport = {
            processedData: window.processedData,
            classStats: window.classStats,
            globalMeans: window.globalMeans,
            globalSDs: window.globalSDs
        };

        // UI Updates
        const select = document.getElementById('classSelect');
        select.innerHTML = '<option value="">-- è«‹é¸æ“‡ç­åˆ¥ --</option>';
        sortedClasses.forEach(c => select.add(new Option(c, c)));
        
        document.getElementById('uploadPanel').style.display = 'none';
        document.getElementById('stats-banner').style.display = 'grid';
        document.getElementById('macro-section').style.display = 'block';
        document.getElementById('risk-section').style.display = 'block';
        document.getElementById('ranking-section').style.display = 'block';
        document.getElementById('detail-section').style.display = 'block';
        document.getElementById('ai-section').style.display = 'block';
        document.getElementById('exportSection').style.display = 'flex'; // Show Cloud buttons
        
        document.getElementById('cloudStatus').innerHTML = `âš ï¸ æ•¸æ“šæœªå„²å­˜ (P${window.currentGrade})`;

        window.renderDashboard();
    }

    // --- Rendering Functions (Copied & Adapted from V16) ---
    window.renderDashboard = function() {
        if(!window.processedDataExport) return;
        
        updateMacroCharts();
        
        // Stats Banner
        const subjects = ['chi', 'eng', 'math'];
        document.getElementById('stats-banner').innerHTML = subjects.map(sub => {
            const title = sub==='chi'?'ä¸­æ–‡':(sub==='eng'?'è‹±æ–‡':'æ•¸å­¸');
            return `<div class="stat-card">
                <div>${title}å…¨ç´šå¹³å‡</div>
                <div class="stat-val">èˆŠ: ${window.globalMeans[sub].old.toFixed(1)} â®• æ–°: ${window.globalMeans[sub].new.toFixed(1)}</div>
            </div>`;
        }).join('');

        // Risk Table
        const riskList = [];
        Object.values(window.processedData).flat().forEach(s => {
            let dropCount = 0, validCount = 0;
            subjects.forEach(sub => {
                if(!isNaN(s[sub].diff)) {
                    validCount++;
                    if(s[sub].diff < -0.5) dropCount++; 
                }
            });
            if(validCount >= 2 && dropCount === validCount) riskList.push(s);
        });
        updateRiskTable(riskList);

        updateRankings();
        drawDetailChart();
        generateAIReport();
    }

    function normalPDF(x, mu, sigma) {
        return (1 / (sigma * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * Math.pow((x - mu) / sigma, 2));
    }

    window.updateMacroCharts = function() {
        const subject = document.getElementById('macroSubjectSelect').value;
        const classes = Object.keys(window.classStats).sort();
        const gOld = window.globalMeans[subject].old;
        const gNew = window.globalMeans[subject].new;
        const gSD = window.globalSDs[subject] || 15;
        const diff = gNew - gOld;
        
        document.getElementById('macro-score-diff').innerHTML = `å¹³å‡åˆ†: ${gOld.toFixed(1)} â®• ${gNew.toFixed(1)} (${diff>=0?'+':''}${diff.toFixed(1)})`;
        document.getElementById('macro-score-diff').style.color = diff >= 0 ? '#2e7d32' : '#c53030';
        
        // 1. Bar Chart
        Plotly.newPlot('chart-bar-stats', [
            { x: classes, y: classes.map(c => window.classStats[c][subject].improved), name: 'ç›¸å°é€²æ­¥', type: 'bar', marker: { color: '#2ca02c' } },
            { x: classes, y: classes.map(c => window.classStats[c][subject].regressed), name: 'ç›¸å°é€€æ­¥', type: 'bar', marker: { color: '#d62728' } }
        ], { title: `å„ç­[${getSubjectName(subject)}]ç›¸å°è¡¨ç¾`, barmode: 'group', margin: { t: 40, l: 30, r: 20, b: 30 } }, {responsive:true});

        // 2. Line Chart
        const lineTraces = classes.map(c => ({
            x: ['èˆŠå¹³å‡', 'æ–°å¹³å‡'], y: [window.classStats[c][subject].avgOld, window.classStats[c][subject].avgNew],
            mode: 'lines+markers', name: c, line: { width: 3 }, marker: { size: 8 }
        }));
        lineTraces.push({ x: ['èˆŠå¹³å‡', 'æ–°å¹³å‡'], y: [gOld, gNew], mode: 'lines', name: 'å…¨ç´šå¹³å‡', line: { width: 4, color: 'black', dash: 'dot' }, opacity: 0.5 });
        Plotly.newPlot('chart-line-avg', lineTraces, { title: `å„ç­[${getSubjectName(subject)}]å¹³å‡åˆ†`, margin: { t: 40, l: 40, r: 20, b: 30 } }, {responsive:true});

        // 3. Distribution Chart
        const tracesDist = [];
        const binSize = 2;
        let totalStudents = 0;
        classes.forEach(cls => {
            const scores = [];
            if(window.processedData[cls]) {
                window.processedData[cls].forEach(s => {
                    const sc = s[subject].new;
                    if(!isNaN(sc)) { scores.push(sc); totalStudents++; }
                });
            }
            tracesDist.push({ x: scores, type: 'histogram', name: cls, xbins: { start: 0, end: 100, size: binSize }, opacity: 0.7 });
        });
        const xValues = [], yValues = [];
        for (let x = 0; x <= 100; x += 1) {
            xValues.push(x);
            yValues.push(normalPDF(x, gNew, gSD) * totalStudents * binSize); 
        }
        tracesDist.push({ x: xValues, y: yValues, mode: 'lines', name: 'ç†æƒ³å¸¸æ…‹åˆ†ä½ˆ', line: { color: 'black', width: 3, dash: 'dash' } });

        Plotly.newPlot('chart-dist', tracesDist, {
            title: `å…¨ç´š${getSubjectName(subject)}æˆç¸¾åˆ†ä½ˆ (Bins=${binSize})`,
            barmode: 'stack', xaxis: { title: 'åˆ†æ•¸ (0-100)', range: [0, 105] }, yaxis: { title: 'äººæ•¸' }, margin: { t: 40, l: 50, r: 20, b: 50 }
        }, {responsive:true});
    }

    function getSubjectName(code) { return code==='chi'?'ä¸­æ–‡':(code==='eng'?'è‹±æ–‡':'æ•¸å­¸'); }
    window.downloadChart = function(divId, filename) { Plotly.downloadImage(divId, {format: 'png', width: 1200, height: 800, filename: filename + '_P' + window.currentGrade}); }
    window.downloadDiv = function(divId, filename) {
        html2canvas(document.getElementById(divId)).then(canvas => {
            const link = document.createElement('a'); link.download = filename + '_P' + window.currentGrade + '.png'; link.href = canvas.toDataURL(); link.click();
        });
    }

    window.updateRankings = function() {
        const subject = document.getElementById('rankSubjectSelect').value;
        let allStudents = [];
        Object.values(window.processedData).forEach(clsList => {
            clsList.forEach(s => { if (!isNaN(s[subject].diff)) allStudents.push(s); });
        });
        const sortedImp = [...allStudents].sort((a, b) => b[subject].diff - a[subject].diff).slice(0, 20);
        const sortedReg = [...allStudents].sort((a, b) => a[subject].diff - b[subject].diff).slice(0, 20);
        renderRankTable('rankBodyImpContent', sortedImp, subject, 'imp');
        renderRankTable('rankBodyRegContent', sortedReg, subject, 'reg');
    }

    function renderRankTable(tbodyId, list, subject, type) {
        const tbody = document.getElementById(tbodyId);
        tbody.innerHTML = '';
        list.forEach((s, idx) => {
            const val = s[subject].diff;
            const valStr = val > 0 ? `+${val.toFixed(1)}` : val.toFixed(1);
            const classColor = type === 'imp' ? 'val-imp' : 'val-reg';
            tbody.innerHTML += `<tr><td>${idx+1}</td><td>${s.cls}</td><td>${s.name}</td><td class="${classColor}">${valStr}</td></tr>`;
        });
    }

    function updateRiskTable(list) {
        const tbody = document.querySelector('#riskTable tbody');
        tbody.innerHTML = '';
        if(list.length === 0) { document.getElementById('risk-section').style.display = 'none'; return; }
        document.getElementById('risk-section').style.display = 'block';
        list.sort((a,b) => a.cls.localeCompare(b.cls));
        list.forEach(s => {
            const fmt = (val) => isNaN(val) ? '-' : (val > 0 ? '+'+val.toFixed(1) : val.toFixed(1));
            tbody.innerHTML += `<tr><td><b>${s.cls}</b></td><td>${s.name}</td><td class="risk-val">${fmt(s.chi.diff)}</td><td class="risk-val">${fmt(s.eng.diff)}</td><td class="risk-val">${fmt(s.math.diff)}</td></tr>`;
        });
    }

    window.drawDetailChart = function() {
        const cls = document.getElementById('classSelect').value;
        const viewMode = document.getElementById('viewMode').value; 
        if(!cls || !window.processedData[cls]) return; // Check if data exists

        const students = window.processedData[cls];
        students.sort((a, b) => a.name.localeCompare(b.name));
        const names = students.map(s => s.name);
        
        const allSubjects = [{ key: 'chi', title: 'ä¸­æ–‡ç§‘' }, { key: 'eng', title: 'è‹±æ–‡ç§‘' }, { key: 'math', title: 'æ•¸å­¸ç§‘' }];
        let targetSubjects = [], gridLayout = {};

        if (viewMode === 'all') {
            targetSubjects = [
                { ...allSubjects[0], domain: [0, 0.32], axis: 'x' },
                { ...allSubjects[1], domain: [0.34, 0.66], axis: 'x2' },
                { ...allSubjects[2], domain: [0.68, 1], axis: 'x3' }
            ];
            gridLayout = { rows: 1, columns: 3, pattern: 'independent' };
        } else {
            const sub = allSubjects.find(s => s.key === viewMode);
            targetSubjects = [{ ...sub, domain: [0, 1], axis: 'x' }];
            gridLayout = { rows: 1, columns: 1, pattern: 'independent' };
        }

        const traces = [], annotations = [], shapes = [];
        targetSubjects.forEach((sub) => {
            const axisX = sub.axis;
            const gOld = window.globalMeans[sub.key].old;
            const gNew = window.globalMeans[sub.key].new;

            shapes.push({ type: 'line', x0: gOld, x1: gOld, y0: 0, y1: 1, xref: axisX, yref: 'paper', line: { color: '#999', width: 1, dash: 'dot' } });
            shapes.push({ type: 'line', x0: gNew, x1: gNew, y0: 0, y1: 1, xref: axisX, yref: 'paper', line: { color: '#333', width: 1, dash: 'dash' } });

            const colors = students.map(s => isNaN(s[sub.key].diff) ? 'grey' : (s[sub.key].diff >= 0 ? '#2ca02c' : '#d62728'));

            traces.push({ x: students.map(s => s[sub.key].old), y: names, xaxis: axisX, yaxis: 'y', mode: 'markers', marker: { color: '#ccc', size: viewMode==='all'?8:12 }, hoverinfo: 'x+y', name: 'èˆŠ', showlegend: false });
            traces.push({ x: students.map(s => s[sub.key].new), y: names, xaxis: axisX, yaxis: 'y', mode: 'markers', marker: { color: colors, size: viewMode==='all'?10:15, line:{width:1,color:'white'} }, hoverinfo: 'x+y', name: 'æ–°', showlegend: false });

            students.forEach(s => {
                if(isNaN(s[sub.key].old) || isNaN(s[sub.key].new)) return;
                const c = s[sub.key].diff >= 0 ? '#2ca02c' : '#d62728';
                annotations.push({ x: s[sub.key].new, y: s.name, ax: s[sub.key].old, ay: s.name, xref: axisX, yref: 'y', axref: axisX, ayref: 'y', showarrow: true, arrowhead: 2, arrowsize: 1, arrowwidth: viewMode==='all'?1.5:2, arrowcolor: c });
                annotations.push({ x: Math.max(s[sub.key].old, s[sub.key].new)+2, y: s.name, xref: axisX, yref: 'y', text: `${s[sub.key].new}`, showarrow: false, font: { color: c, size: viewMode==='all'?11:14 }, xanchor: 'left' });
            });
            annotations.push({ x: gNew, y: 1.02, xref: axisX, yref: 'paper', text: `Avg:${gNew.toFixed(0)}`, showarrow: false, font: {size: 12, color: '#333'}, xanchor: 'center' });
        });

        const layout = {
            title: `ç­åˆ¥ ${cls} è©³ç´°åˆ†æ`, height: Math.max(600, students.length * 35), 
            margin: { l: 150, r: 50, t: 80, b: 50 }, grid: gridLayout, shapes: shapes,
            yaxis: { automargin: true, title: '', dtick: 1 }, annotations: annotations, showlegend: false, hovermode: 'closest'
        };

        if(viewMode === 'all') {
            layout.xaxis = { domain: targetSubjects[0].domain, title: 'ä¸­æ–‡', range: [0, 115] };
            layout.xaxis2 = { domain: targetSubjects[1].domain, title: 'è‹±æ–‡', range: [0, 115] };
            layout.xaxis3 = { domain: targetSubjects[2].domain, title: 'æ•¸å­¸', range: [0, 115] };
        } else {
            layout.xaxis = { domain: targetSubjects[0].domain, title: targetSubjects[0].title, range: [0, 115] };
        }
        Plotly.newPlot('chart-main', traces, layout);
    }

    function generateAIReport() {
        const chatWindow = document.getElementById('chatWindow');
        chatWindow.innerHTML = '<div class="chat-bubble chat-ai">ğŸ‘‹ è€å¸«æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„æ•¸æ“šåˆ†æåŠ©ç†ã€‚è«‹çœ‹ä¸‹æ–¹çš„è‡ªå‹•è¨ºæ–·å ±å‘Šã€‚</div>';
        
        let reportHTML = "";
        let promptText = "æˆ‘æ˜¯ä¸€å€‹å°å­¸èª²ç¨‹ä¸»ä»»ï¼Œä»¥ä¸‹æ˜¯å„ç­çš„æˆç¸¾çµ±è¨ˆæ•¸æ“šï¼Œè«‹å¹«æˆ‘åˆ†æä¸¦çµ¦äºˆæ•™å­¸å»ºè­°ï¼š\n\n";
        promptText += `å…¨ç´šå¹³å‡åˆ† - ä¸­æ–‡:${window.globalMeans.chi.new.toFixed(1)}, è‹±æ–‡:${window.globalMeans.eng.new.toFixed(1)}, æ•¸å­¸:${window.globalMeans.math.new.toFixed(1)}\n\n`;

        const subjects = [{k:'chi', n:'ä¸­æ–‡'}, {k:'eng', n:'è‹±æ–‡'}, {k:'math', n:'æ•¸å­¸'}];
        
        Object.keys(window.classStats).sort().forEach(cls => {
            promptText += `ã€ç­åˆ¥ ${cls}ã€‘\n`;
            let issues = [];
            subjects.forEach(sub => {
                const s = window.classStats[cls][sub.k];
                const gMean = window.globalMeans[sub.k].new;
                const isLagging = s.avgNew < (gMean - 5);
                const isPolarized = s.sd > 18;
                let status = [];
                if(isLagging) status.push(`<span style="color:red">è½å¾Œ</span>`);
                if(isPolarized) status.push(`<span style="color:orange">å…©æ¥µåŒ–</span>`);
                if(status.length > 0) issues.push(`${sub.n}: ${status.join(' ')}`);
                promptText += `  - ${sub.n}: å¹³å‡${s.avgNew.toFixed(1)} (ç´šå¹³å‡${gMean.toFixed(1)}), SD:${s.sd.toFixed(1)}\n`;
            });
            if(issues.length > 0) {
                reportHTML += `<div style="margin-bottom:10px; border-bottom:1px solid #eee;"><b>${cls} ç­ï¼š</b> ${issues.join(', ')}</div>`;
            }
        });
        
        if(reportHTML === "") reportHTML = "âœ… åˆæ­¥åˆ†æï¼šå„ç­è¡¨ç¾å¹³ç©©ã€‚";
        const bubble = document.createElement('div');
        bubble.className = "chat-bubble chat-ai";
        bubble.innerHTML = reportHTML + "<br><i>(æ‚¨å¯ä»¥è¤‡è£½ä¸‹æ–¹æŒ‡ä»¤ï¼Œèˆ‡ ChatGPT é€²ä¸€æ­¥è¨è«–)</i>";
        chatWindow.appendChild(bubble);
        aiAnalysisReport = promptText;
    }

    window.copyAiPrompt = function() {
        if(!aiAnalysisReport) return;
        navigator.clipboard.writeText(aiAnalysisReport).then(() => alert("å·²è¤‡è£½æ•¸æ“šæŒ‡ä»¤ï¼"));
    }
</script>

</body>
</html>