<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡æœ¬å­¸è¡“æˆç¸¾é›²ç«¯æ•¸æ“šä¸­å¿ƒ</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-statistics/7.7.0/simple-statistics.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // Import the functions you need from the SDKs you need
        import { initializeApp } from "firebase/app";
        import { getAnalytics } from "firebase/analytics";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyBYtaDjYgO0F2qlvWgmeMavE0SUBTzFONU",
          authDomain: "school-grade-analysis-ed4e1.firebaseapp.com",
          projectId: "school-grade-analysis-ed4e1",
          storageBucket: "school-grade-analysis-ed4e1.firebasestorage.app",
          messagingSenderId: "119965796660",
          appId: "1:119965796660:web:55e160b8eab960ab157d61",
          measurementId: "G-S36T3HV2PT"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // å°‡ Firebase åŠŸèƒ½æ›è¼‰åˆ° window ä»¥ä¾¿å…¨å±€èª¿ç”¨
        window.saveToCloud = async function() {
            const grade = window.currentGrade;
            if(!window.processedDataExport) { alert("æ²’æœ‰å¯å„²å­˜çš„æ•¸æ“šï¼è«‹å…ˆé€²è¡Œåˆ†æã€‚"); return; }
            
            const btn = document.getElementById('btnSaveCloud');
            btn.innerText = "â˜ï¸ å„²å­˜ä¸­...";
            try {
                // å°‡ NaN è½‰æ›ç‚ºå­—ä¸²ä»¥é¿å… Firebase å ±éŒ¯
                const jsonString = JSON.stringify(window.processedDataExport, (key, value) => 
                    (typeof value === 'number' && isNaN(value)) ? "###NaN###" : value
                );
                const dataToSave = JSON.parse(jsonString);

                await setDoc(doc(db, "grades", grade), {
                    data: dataToSave,
                    updatedAt: new Date().toLocaleString()
                });
                alert(`âœ… P${grade} æ•¸æ“šå·²æˆåŠŸä¸Šå‚³é›²ç«¯ï¼`);
            } catch (e) {
                console.error(e);
                alert("å„²å­˜å¤±æ•—ï¼š" + e.message);
            }
            btn.innerText = "â˜ï¸ ä¸Šå‚³è‡³é›²ç«¯æ•¸æ“šåº«";
        }

        window.loadFromCloud = async function(grade) {
            window.switchGradeUI(grade);
            const statusDiv = document.getElementById('cloudStatus');
            statusDiv.innerHTML = `â³ æ­£åœ¨è®€å– P${grade} é›²ç«¯æ•¸æ“š...`;
            
            try {
                const docRef = doc(db, "grades", grade);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const savedData = docSnap.data().data;
                    // é‚„åŸ NaN
                    const cleanData = JSON.parse(JSON.stringify(savedData), (key, value) => 
                        value === "###NaN###" ? NaN : value
                    );
                    
                    // é‚„åŸå…¨åŸŸè®Šæ•¸
                    window.processed = cleanData.processed;
                    window.globalStats = cleanData.globalStats;
                    
                    // æ¢å¾©ä»‹é¢
                    document.getElementById('uploadPanel').style.display = 'none';
                    document.getElementById('resultArea').style.display = 'block';
                    document.getElementById('btnBackUpload').style.display = 'inline-block';
                    statusDiv.innerHTML = `âœ… å·²è¼‰å…¥ P${grade} æ•¸æ“š (æœ€å¾Œæ›´æ–°: ${docSnap.data().updatedAt})`;
                    
                    window.renderDashboard();
                } else {
                    statusDiv.innerHTML = `â„¹ï¸ P${grade} å°šç„¡é›²ç«¯æ•¸æ“šï¼Œè«‹ä¸Šå‚³æª”æ¡ˆé€²è¡Œåˆ†æã€‚`;
                    window.resetToUploadMode();
                }
            } catch (e) {
                console.error(e);
                statusDiv.innerHTML = `âŒ è®€å–éŒ¯èª¤: ${e.message}`;
            }
        }
    </script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f4f4f9; padding: 20px; margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* å°èˆªåˆ—æ¨£å¼ */
        .nav-bar { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .nav-btn { flex: 1; padding: 15px; border: none; background: #e0e0e0; cursor: pointer; font-size: 1.2em; font-weight: bold; border-radius: 8px 8px 0 0; color: #555; transition: 0.3s; }
        .nav-btn:hover { background: #d0d0d0; }
        .nav-btn.active { background: #007bff; color: white; transform: translateY(-2px); box-shadow: 0 -2px 5px rgba(0,0,0,0.1); }

        h1 { text-align: center; color: #2c3e50; margin-bottom: 5px; }
        .grade-badge { background: #007bff; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.8em; vertical-align: middle; margin-left: 10px; }
        .sub-title { text-align: center; color: #7f8c8d; font-size: 0.9em; margin-bottom: 20px; }

        .control-panel { background: #e9ecef; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: grid; gap: 15px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
        
        /* é›²ç«¯ç‹€æ…‹åˆ— */
        .cloud-status-bar { grid-column: 1/-1; background: #fff3e0; color: #e65100; padding: 10px; text-align: center; border-radius: 5px; border: 1px solid #ffe0b2; font-weight: bold; margin-bottom: 10px; }

        /* Mapping & Inputs */
        .encoding-setting { grid-column: 1 / -1; background: #fff3cd; padding: 10px; border-radius: 5px; border: 1px solid #ffeeba; }
        .mapping-box { grid-column: 1 / -1; background: #fff; padding: 15px; border: 1px solid #ced4da; border-radius: 5px; display: none; margin-top: 10px; }
        .mapping-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .section-box { border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #fff; display: none; margin-bottom: 20px; }
        .section-box.active { display: block; }

        label { font-weight: bold; display: block; margin-bottom: 5px; }
        select, input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .auto-tag { color: #28a745; font-size: 0.8em; margin-left: 5px; }

        /* Buttons */
        button.primary-btn { grid-column: 1 / -1; background: #28a745; color: white; padding: 12px; border: none; border-radius: 5px; font-size: 1.1em; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        button.primary-btn:hover { background: #218838; }
        
        .cloud-btn { background: #17a2b8; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; width: 100%; font-size: 1.1em; margin-top: 10px; }
        .cloud-btn:hover { background: #138496; }
        
        .reset-btn { background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-bottom: 15px; }

        /* Charts & Tables */
        .risk-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .risk-table th { background: #c0392b; color: white; padding: 10px; }
        .risk-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .risk-val { color: #c0392b; font-weight: bold; }
        
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center; margin-bottom: 20px; }
        .stat-item { background: #f8f9fa; padding: 10px; border-radius: 5px; border: 1px solid #dee2e6; }

        .ai-box { background: #e8f5e9; padding: 15px; border-radius: 8px; border: 1px solid #c8e6c9; margin-top: 20px; }
        .copy-btn { background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; float: right; }
    </style>
</head>
<body>

<div class="container">
    <h1 id="mainTitle">å…¨ç´šå­¸è¡“æˆç¸¾åˆ†æç³»çµ± <span id="currentGradeBadge" class="grade-badge">P1</span></h1>
    <div class="sub-title">é›²ç«¯æ•¸æ“šä¸­å¿ƒ (V16-Cloud)</div>

    <div class="nav-bar">
        <button class="nav-btn active" onclick="window.loadFromCloud('1')">P1</button>
        <button class="nav-btn" onclick="window.loadFromCloud('2')">P2</button>
        <button class="nav-btn" onclick="window.loadFromCloud('3')">P3</button>
        <button class="nav-btn" onclick="window.loadFromCloud('4')">P4</button>
        <button class="nav-btn" onclick="window.loadFromCloud('5')">P5</button>
        <button class="nav-btn" onclick="window.loadFromCloud('6')">P6</button>
    </div>

    <div id="cloudStatus" class="cloud-status-bar">æº–å‚™å°±ç·’ï¼Œè«‹ä¸Šå‚³æª”æ¡ˆæˆ–è®€å–é›²ç«¯æ•¸æ“šã€‚</div>

    <div class="control-panel" id="uploadPanel">
        <div class="encoding-setting">
            <label style="display:inline;">ğŸ”§ æª”æ¡ˆç·¨ç¢¼ï¼š</label>
            <select id="encodingSelect" onchange="resetInputs()">
                <option value="Big5" selected>Big5 (Excel é è¨­)</option>
                <option value="UTF-8">UTF-8 (é€šç”¨)</option>
            </select>
        </div>

        <div><label>1. å­¸ç”Ÿè³‡æ–™ (Info)</label><input type="file" id="fileInfo" accept=".csv"></div>
        <div><label>2. èˆŠæˆç¸¾ (Old)</label><input type="file" id="fileOld" accept=".csv"></div>
        <div><label>3. æ–°æˆç¸¾ (New)</label><input type="file" id="fileNew" accept=".csv"></div>
        
        <div id="panelInfo" class="mapping-box">
            <h3>ğŸ‘¤ 1. å­¸ç”Ÿè³‡æ–™å°æ‡‰</h3>
            <div class="mapping-grid">
                <div><label>ç­åˆ¥</label><select id="colClass"></select></div>
                <div><label>å§“å</label><select id="colName"></select></div>
                <div><label>è¨»å†Šç·¨è™Ÿ</label><select id="colRegInfo"></select></div>
            </div>
        </div>

        <div id="panelOld" class="mapping-box">
            <h3>ğŸ“‚ 2. èˆŠæˆç¸¾å°æ‡‰</h3>
            <div class="mapping-grid">
                <div><label>è¨»å†Šç·¨è™Ÿ</label><select id="oldReg"></select></div>
                <div><label>ä¸­æ–‡ç§‘</label><select id="oldChi"></select></div>
                <div><label>è‹±æ–‡ç§‘</label><select id="oldEng"></select></div>
                <div><label>æ•¸å­¸ç§‘</label><select id="oldMath"></select></div>
            </div>
        </div>

        <div id="panelNew" class="mapping-box">
            <h3>ğŸ“‚ 3. æ–°æˆç¸¾å°æ‡‰</h3>
            <div class="mapping-grid">
                <div><label>è¨»å†Šç·¨è™Ÿ</label><select id="newReg"></select></div>
                <div><label>ä¸­æ–‡ç§‘</label><select id="newChi"></select></div>
                <div><label>è‹±æ–‡ç§‘</label><select id="newEng"></select></div>
                <div><label>æ•¸å­¸ç§‘</label><select id="newMath"></select></div>
            </div>
        </div>

        <button class="primary-btn" onclick="processData()">ğŸš€ é–‹å§‹åˆ†æ</button>
    </div>

    <div id="resultArea" style="display:none;">
        <button id="btnBackUpload" class="reset-btn" onclick="resetToUploadMode()">â†©ï¸ é‡æ–°ä¸Šå‚³ / ä¿®æ­£</button>
        <button id="btnSaveCloud" class="cloud-btn" onclick="window.saveToCloud()">â˜ï¸ ä¸Šå‚³è‡³é›²ç«¯æ•¸æ“šåº«</button>
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

        <div class="section-box active">
            <h2>ğŸ“Š å…¨ç´šå®è§€è¡¨ç¾</h2>
            <div class="stat-grid" id="globalStats"></div>
            <div id="chart-macro" style="height: 400px;"></div>
        </div>

        <div class="section-box active">
            <h2>âš ï¸ é‡é»é—œæ³¨åå–® (å…¨ç§‘é€€æ­¥)</h2>
            <table class="risk-table">
                <thead><tr><th>ç­åˆ¥</th><th>å§“å</th><th>ä¸­æ–‡è®ŠåŒ–</th><th>è‹±æ–‡è®ŠåŒ–</th><th>æ•¸å­¸è®ŠåŒ–</th></tr></thead>
                <tbody id="riskBody"></tbody>
            </table>
        </div>

        <div class="section-box active">
            <h2>ğŸ” ç­ç´šè©³ç´°åˆ†æ</h2>
            <div style="text-align: center; margin-bottom: 15px;">
                <label style="display:inline;">é¸æ“‡ç­åˆ¥ï¼š</label>
                <select id="classSelect" style="width: auto; padding: 5px;" onchange="updateDetailChart()"></select>
                <label style="display:inline; margin-left:15px;">ç§‘ç›®ï¼š</label>
                <select id="subjectSelect" style="width: auto; padding: 5px;" onchange="updateDetailChart()">
                    <option value="all">ä¸‰ç§‘ä¸¦åˆ—</option>
                    <option value="chi">ä¸­æ–‡ç§‘</option>
                    <option value="eng">è‹±æ–‡ç§‘</option>
                    <option value="math">æ•¸å­¸ç§‘</option>
                </select>
            </div>
            <div id="chart-detail" style="height: 600px;"></div>
        </div>

        <div class="ai-box">
            <button class="copy-btn" onclick="copyPrompt()">è¤‡è£½æŒ‡ä»¤</button>
            <h3>ğŸ¤– AI åˆ†ææŒ‡ä»¤</h3>
            <textarea id="aiPrompt" style="width:100%; height:100px; padding:10px;" readonly></textarea>
        </div>
    </div>
</div>

<script>
    let rawData = {};
    window.processed = {}; 
    window.globalStats = {};
    window.currentGrade = '1';
    window.processedDataExport = null; // ç”¨æ–¼å„²å­˜çš„å¿«ç…§

    // åˆå§‹åŒ–: é è¨­åŠ è¼‰ P1
    window.addEventListener('DOMContentLoaded', () => {
        window.loadFromCloud('1');
    });

    // åˆ‡æ›å¹´ç´š UI
    window.switchGradeUI = function(grade) {
        window.currentGrade = grade;
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.nav-btn')[grade-1].classList.add('active');
        document.getElementById('currentGradeBadge').innerText = `P${grade}`;
        // æ¸…ç©ºç•¶å‰é¡¯ç¤º
        window.resetToUploadMode();
    }

    // é‡ç½®ç‚ºä¸Šå‚³æ¨¡å¼
    window.resetToUploadMode = function() {
        document.getElementById('uploadPanel').style.display = 'grid';
        document.getElementById('resultArea').style.display = 'none';
        document.getElementById('btnBackUpload').style.display = 'none';
        resetInputs();
    }

    function resetInputs() {
        rawData = {};
        ['fileInfo', 'fileOld', 'fileNew'].forEach(id => document.getElementById(id).value = '');
        ['panelInfo', 'panelOld', 'panelNew'].forEach(id => document.getElementById(id).style.display = 'none');
    }

    ['fileInfo', 'fileOld', 'fileNew'].forEach(id => {
        document.getElementById(id).addEventListener('change', e => parseCSV(e, id));
    });

    function parseCSV(e, type) {
        const enc = document.getElementById('encodingSelect').value;
        Papa.parse(e.target.files[0], {
            header: false, skipEmptyLines: true, encoding: enc,
            complete: res => {
                rawData[type] = res.data;
                const headers = res.data[0];
                if(type === 'fileInfo') initDropdown('panelInfo', headers, [{id:'colClass',keys:['ç­','class']},{id:'colName',keys:['å§“å','name']},{id:'colRegInfo',keys:['è¨»å†Š','reg']}]);
                if(type === 'fileOld') initDropdown('panelOld', headers, [{id:'oldReg',keys:['è¨»å†Š','reg']},{id:'oldChi',keys:['ä¸­æ–‡','chi']},{id:'oldEng',keys:['è‹±æ–‡','eng']},{id:'oldMath',keys:['æ•¸å­¸','math']}]);
                if(type === 'fileNew') initDropdown('panelNew', headers, [{id:'newReg',keys:['è¨»å†Š','reg']},{id:'newChi',keys:['ä¸­æ–‡','chi']},{id:'newEng',keys:['è‹±æ–‡','eng']},{id:'newMath',keys:['æ•¸å­¸','math']}]);
            },
            error: err => alert("è®€å–éŒ¯èª¤: " + err.message)
        });
    }

    function initDropdown(panelId, headers, configs) {
        document.getElementById(panelId).style.display = 'block';
        configs.forEach(cfg => {
            const sel = document.getElementById(cfg.id);
            sel.innerHTML = '';
            let foundIdx = -1;
            headers.forEach((h, i) => {
                const opt = document.createElement('option');
                opt.value = i; opt.text = `[${i}] ${h}`;
                sel.appendChild(opt);
                if(foundIdx === -1 && cfg.keys.some(k => h.toLowerCase().includes(k))) foundIdx = i;
            });
            if(foundIdx !== -1) {
                sel.value = foundIdx;
                const label = sel.previousElementSibling;
                if(!label.innerHTML.includes('è‡ªå‹•')) label.innerHTML += ' <span class="auto-tag">âœ” è‡ªå‹•åµæ¸¬</span>';
            }
        });
    }

    function processData() {
        if(!rawData.fileInfo || !rawData.fileOld || !rawData.fileNew) { alert("è«‹ä¸Šå‚³æ‰€æœ‰æª”æ¡ˆ"); return; }

        const idxClass = document.getElementById('colClass').value;
        const idxName = document.getElementById('colName').value;
        const idxRegInfo = document.getElementById('colRegInfo').value;

        const getScores = (rows, idPrefix) => {
            const iReg = document.getElementById(idPrefix + 'Reg').value;
            const iChi = document.getElementById(idPrefix + 'Chi').value;
            const iEng = document.getElementById(idPrefix + 'Eng').value;
            const iMath = document.getElementById(idPrefix + 'Math').value;
            let map = {};
            rows.slice(1).forEach(r => {
                const reg = r[iReg] ? r[iReg].trim() : null;
                if(reg) map[reg] = { chi: parseFloat(r[iChi])||0, eng: parseFloat(r[iEng])||0, math: parseFloat(r[iMath])||0 };
            });
            return map;
        };

        const oldMap = getScores(rawData.fileOld, 'old');
        const newMap = getScores(rawData.fileNew, 'new');
        
        window.processed = {};
        let classes = new Set();
        let allScores = { chi:[], eng:[], math:[] };

        rawData.fileInfo.slice(1).forEach(r => {
            const reg = r[idxRegInfo]?.trim();
            if(!reg || !oldMap[reg] || !newMap[reg]) return;
            const cls = r[idxClass]; const name = r[idxName];
            classes.add(cls);
            if(!window.processed[cls]) window.processed[cls] = [];
            let student = { name, cls, scores: {} };
            ['chi', 'eng', 'math'].forEach(sub => {
                const o = oldMap[reg][sub]; const n = newMap[reg][sub];
                if(n > 0) allScores[sub].push(n);
                student.scores[sub] = { old: o, new: n, diff: n - o };
            });
            window.processed[cls].push(student);
        });

        window.globalStats = {};
        ['chi', 'eng', 'math'].forEach(sub => {
            const arr = allScores[sub];
            window.globalStats[sub] = arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length) : 0;
        });

        // æº–å‚™å„²å­˜ç”¨æ•¸æ“š
        window.processedDataExport = { processed: window.processed, globalStats: window.globalStats };

        window.renderDashboard();
        document.getElementById('uploadPanel').style.display = 'none';
        document.getElementById('resultArea').style.display = 'block';
        document.getElementById('btnBackUpload').style.display = 'inline-block';
        document.getElementById('cloudStatus').innerHTML = `âš ï¸ ç•¶å‰æ•¸æ“šå°šæœªå„²å­˜ï¼Œè«‹é»æ“Šã€Œä¸Šå‚³è‡³é›²ç«¯ã€ä»¥ä¿å­˜ P${window.currentGrade} æ•¸æ“šã€‚`;
    }

    window.renderDashboard = function() {
        const div = document.getElementById('globalStats');
        div.innerHTML = ['chi','eng','math'].map(s => {
            const name = s==='chi'?'ä¸­æ–‡':(s==='eng'?'è‹±æ–‡':'æ•¸å­¸');
            return `<div class="stat-item"><h3>${name}å¹³å‡</h3><div style="font-size:1.5em;color:#007bff">${window.globalStats[s].toFixed(1)}</div></div>`;
        }).join('');

        const riskBody = document.getElementById('riskBody');
        riskBody.innerHTML = '';
        Object.values(window.processed).flat().forEach(s => {
            let dropCount = 0;
            ['chi','eng','math'].forEach(sub => { if(s.scores[sub].diff < -2) dropCount++; });
            if(dropCount === 3) {
                riskBody.innerHTML += `<tr><td>${s.cls}</td><td>${s.name}</td><td class="risk-val">${s.scores.chi.diff.toFixed(1)}</td><td class="risk-val">${s.scores.eng.diff.toFixed(1)}</td><td class="risk-val">${s.scores.math.diff.toFixed(1)}</td></tr>`;
            }
        });

        const classes = Object.keys(window.processed).sort();
        const traces = ['chi','eng','math'].map(sub => {
            return { x: classes, y: classes.map(c => window.processed[c].filter(s => s.scores[sub].diff > 0).length), name: (sub==='chi'?'ä¸­':(sub==='eng'?'è‹±':'æ•¸')) + 'é€²æ­¥äººæ•¸', type: 'bar' };
        });
        Plotly.newPlot('chart-macro', traces, { barmode: 'group', title: 'å„ç­é€²æ­¥äººæ•¸çµ±è¨ˆ' });

        const sel = document.getElementById('classSelect');
        const currentVal = sel.value;
        sel.innerHTML = '';
        classes.forEach(c => sel.add(new Option(c, c)));
        if(classes.includes(currentVal)) sel.value = currentVal;
        
        window.updateDetailChart();
        window.generatePrompt();
    }

    window.updateDetailChart = function() {
        const cls = document.getElementById('classSelect').value;
        const mode = document.getElementById('subjectSelect').value;
        const students = window.processed[cls];
        if(!students) return;

        const subs = mode === 'all' ? ['chi', 'eng', 'math'] : [mode];
        const traces = [];
        subs.forEach((sub, idx) => {
            const axis = mode === 'all' ? (idx + 1) : 1;
            const nameMap = {'chi':'ä¸­æ–‡', 'eng':'è‹±æ–‡', 'math':'æ•¸å­¸'};
            traces.push({ x: students.map(s => s.scores[sub].old), y: students.map(s => s.name), mode: 'markers', marker: { color: '#ccc', size: 8 }, name: 'èˆŠæˆç¸¾', xaxis: 'x' + axis, showlegend: false });
            traces.push({ x: students.map(s => s.scores[sub].new), y: students.map(s => s.name), mode: 'markers', marker: { color: students.map(s => s.scores[sub].diff >= 0 ? '#28a745' : '#dc3545'), size: 10 }, name: nameMap[sub], xaxis: 'x' + axis });
        });

        const layout = { title: `ç­åˆ¥ ${cls} è©³ç´°åˆ†æ`, height: Math.max(500, students.length * 30), margin: {l: 100, r: 20, t: 50, b: 50} };
        if(mode === 'all') layout.grid = { rows: 1, columns: 3, pattern: 'independent' };
        else layout.xaxis = { title: 'åˆ†æ•¸', range: [0, 105] };
        Plotly.newPlot('chart-detail', traces, layout);
    }

    window.generatePrompt = function() {
        let txt = `åˆ†æ P${window.currentGrade} ç´šåˆ¥è¡¨ç¾ï¼š\nå…¨ç´šå¹³å‡ï¼šä¸­${window.globalStats.chi.toFixed(1)}, è‹±${window.globalStats.eng.toFixed(1)}, æ•¸${window.globalStats.math.toFixed(1)}\n\n`;
        Object.keys(window.processed).sort().forEach(cls => {
            const list = window.processed[cls];
            const avg = sub => (list.reduce((a,b)=>a+b.scores[sub].new,0)/list.length).toFixed(1);
            txt += `ã€${cls}ã€‘ä¸­${avg('chi')}, è‹±${avg('eng')}, æ•¸${avg('math')}\n`;
        });
        document.getElementById('aiPrompt').value = txt;
    }

    window.copyPrompt = function() { navigator.clipboard.writeText(document.getElementById('aiPrompt').value); alert("å·²è¤‡è£½"); }
</script>

</body>
</html>